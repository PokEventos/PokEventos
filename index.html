<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PokEventos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; -webkit-font-smoothing:antialiased; }
    .pokeball-bg { background-image: radial-gradient(circle at 20% 30%,rgba(239,68,68,.07) 0%,transparent 50%), radial-gradient(circle at 80% 70%,rgba(59,130,246,.07) 0%,transparent 50%); }
    .card-img { transition:transform .3s ease,box-shadow .3s ease; }
    .card-img:hover { transform:scale(1.08) rotate(2deg); box-shadow:0 20px 40px rgba(0,0,0,.3); }
    .modal-enter { animation:slideUp .3s ease; }
    .fade-in { animation:fadeIn .25s ease; }
    @keyframes slideUp { from{transform:translateY(60px);opacity:0} to{transform:translateY(0);opacity:1} }
    @keyframes fadeIn  { from{opacity:0} to{opacity:1} }
    .wanted-glow { box-shadow:0 0 0 3px rgba(251,191,36,.6), 0 4px 20px rgba(0,0,0,.15); }
    .pulse-dot { animation:pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
    @keyframes fade-in { from{opacity:0;transform:scale(0.95)} to{opacity:1;transform:scale(1)} }
    .animate-fade-in { animation:fade-in 0.3s ease-out; }
  </style>
  <script>
    const s = document.createElement('script');
    s.type = 'module';
    s.textContent = "import{createClient}from'https://esm.sh/@supabase/supabase-js@2';window.supabaseCreateClient=createClient;window.dispatchEvent(new Event('supabase-ready'))";
    document.head.appendChild(s);
  </script>
</head>
<body>
<div id="root"></div>
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">  // === SUPABASE ===
  const SUPA_URL='https://beqiihapbgtrrgvmgrpg.supabase.co';
  const SUPA_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJlcWlpaGFwYmd0cnJndm1ncnBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNDQ5NjIsImV4cCI6MjA4NjkyMDk2Mn0.caWCYxnO3tW6eDXDwIp-Ht8JWxr7RymMXgNFEQ7Idik';
  let supabase=null;
  const initSupa=()=>{if(window.supabaseCreateClient){supabase=window.supabaseCreateClient(SUPA_URL,SUPA_KEY);console.log('âœ… Supabase conectado');}else setTimeout(initSupa,100);};
  initSupa();
  window.addEventListener('supabase-ready',initSupa);
  const sbDB={
    createLeilao:async(d)=>supabase?await supabase.from('leiloes').insert(d).select().single():{data:null,error:new Error('offline')},
    createCartas:async(c)=>supabase?await supabase.from('leilao_cartas').insert(c):{error:new Error('offline')},
    createProfile:async(profile)=>supabase?await supabase.from('profiles').insert(profile).select().single():{data:null,error:new Error('offline')},
    getProfile:async(userId)=>supabase?await supabase.from('profiles').select('*').eq('id',userId).single():{data:null,error:new Error('offline')},
    updateProfile:async(userId,updates)=>supabase?await supabase.from('profiles').update(updates).eq('id',userId):{error:new Error('offline')}
  };
  const sbAuth={
    signUp:async(email,password,displayName)=>{
      if(!supabase)return{data:null,error:new Error('Supabase offline')};
      console.log('ðŸ“ Criando usuÃ¡rio...');
      const{data,error}=await supabase.auth.signUp({
        email:email,
        password:password,
        options:{data:{display_name:displayName}}
      });
      if(error)console.error('âŒ Erro signup:',error);
      else console.log('âœ… UsuÃ¡rio criado!',data);
      return{data,error};
    },
    signIn:async(email,password)=>{
      if(!supabase)return{data:null,error:new Error('Supabase offline')};
      console.log('ðŸ”‘ Fazendo login...');
      const{data,error}=await supabase.auth.signInWithPassword({email,password});
      if(error)console.error('âŒ Erro login:',error);
      else console.log('âœ… Login OK!',data);
      return{data,error};
    },
    signOut:async()=>{
      if(!supabase)return{error:new Error('Supabase offline')};
      console.log('ðŸ‘‹ Saindo...');
      const{error}=await supabase.auth.signOut();
      if(error)console.error('âŒ Erro logout:',error);
      else console.log('âœ… Logout OK!');
      return{error};
    },
    getUser:async()=>{
      if(!supabase)return{data:{user:null}};
      return await supabase.auth.getUser();
    }
  };





const { useState, useMemo, useEffect, useCallback } = React;

/* â”€â”€â”€ IMAGENS ESTÃTICAS â”€â”€â”€ */
const TCG = {
  charizardBase : 'https://assets.tcgdex.net/en/base/base1/4/high.png',
  lovebirds     : 'https://assets.tcgdex.net/en/swsh/swsh7/215/high.png',
  moonbreon     : 'https://assets.tcgdex.net/en/swsh/swsh7/215/high.png',
  charizardVmax : 'https://assets.tcgdex.net/en/swsh/swsh3/20/high.png',
  pikachuVmax   : 'https://assets.tcgdex.net/en/swsh/swsh4/44/high.png',
  mewtwov       : 'https://assets.tcgdex.net/en/swsh/swsh10.5/030/high.png',
  rayquazaVmax  : 'https://assets.tcgdex.net/en/swsh/swsh7/111/high.png',
  blastoise     : 'https://assets.tcgdex.net/en/base/base1/2/high.png',
  venusaur      : 'https://assets.tcgdex.net/en/base/base1/15/high.png',
};
const POKE = {
  pikachu   : 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/25.png',
  charizard : 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/6.png',
  mewtwo    : 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/150.png',
  snorlax   : 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/143.png',
  dragonite : 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/149.png',
  umbreon   : 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/197.png',
  eevee     : 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/133.png',
  jolteon   : 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/135.png',
};

/* â”€â”€â”€ LEILÃ•ES MOCKADOS â”€â”€â”€ */
const EVENTS = [];


/* â”€â”€â”€ UTIL: verifica se carta wanted aparece em leilÃ£o â”€â”€â”€ */
const matchWanted = (wantedCard, eventCard) => {
  const wName = wantedCard.name.toLowerCase().trim();
  const wNum  = (wantedCard.number || wantedCard.localId || '').toLowerCase().trim();
  const wId   = (wantedCard.id || '').toLowerCase().trim();
  
  const eName = eventCard.name.toLowerCase().trim();
  const eNum  = (eventCard.number || eventCard.localId || '').toLowerCase().trim();
  const eId   = (eventCard.id || '').toLowerCase().trim();
  
  // MATCH PERFEITO: ID exato (mais confiÃ¡vel)
  if (wId && eId && wId === eId) {
    return true;
  }
  
  // MATCH FORTE: Nome E NÃºmero (evita falsos positivos)
  if (wName && wNum && eNum) {
    const nomeMatch = eName.includes(wName) || wName.includes(eName);
    const numeroMatch = eNum === wNum;
    
    if (nomeMatch && numeroMatch) {
      return true;
    }
  }
  
  // MATCH MÃ‰DIO: Apenas nÃºmero (se for especÃ­fico o suficiente)
  // Exemplo: "006/165" Ã© especÃ­fico, "25" nÃ£o Ã©
  if (wNum && eNum && wNum === eNum) {
    // SÃ³ aceita se o nÃºmero tem "/" (formato completo)
    if (wNum.includes('/') || wNum.length > 3) {
      return true;
    }
  }
  
  return false;
};

/* â”€â”€â”€ BASE LOCAL DE CARTAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ~80 cartas icÃ´nicas para busca instantÃ¢nea.
   Estrutura idÃªntica ao retorno da PokemonTCG API para futura substituiÃ§Ã£o.
   No futuro: trocar searchLocalCards() por chamada real Ã  API.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const LOCAL_CARDS = [
  { id:'base1-4', name:'Charizard', number:'4', set:'base1', setName:'Base Set', rarity:'Rare', image:'https://assets.tcgdex.net/en/base/base1/4/low.png', imageLarge:'https://assets.tcgdex.net/en/base/base1/4/high.png' },
  { id:'base1-10', name:'Mewtwo', number:'10', set:'base1', setName:'Base Set', rarity:'Rare', image:'https://assets.tcgdex.net/en/base/base1/10/low.png', imageLarge:'https://assets.tcgdex.net/en/base/base1/10/high.png' },
  { id:'base1-15', name:'Venusaur', number:'15', set:'base1', setName:'Base Set', rarity:'Rare', image:'https://assets.tcgdex.net/en/base/base1/15/low.png', imageLarge:'https://assets.tcgdex.net/en/base/base1/15/high.png' },
  { id:'base1-2', name:'Blastoise', number:'2', set:'base1', setName:'Base Set', rarity:'Rare', image:'https://assets.tcgdex.net/en/base/base1/2/low.png', imageLarge:'https://assets.tcgdex.net/en/base/base1/2/high.png' },
  { id:'xy1-2', name:'M Venusaur EX', number:'2', set:'xy1', setName:'XY', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy1/2/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy1/2/high.png' },
  { id:'xy1-30', name:'M Blastoise EX', number:'30', set:'xy1', setName:'XY', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy1/30/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy1/30/high.png' },
  { id:'xy12-100', name:'M Venusaur EX', number:'100', set:'xy12', setName:'Evolutions', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy12/100/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy12/100/high.png' },
  { id:'xy12-101', name:'M Charizard EX', number:'101', set:'xy12', setName:'Evolutions', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy12/101/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy12/101/high.png' },
  { id:'xy12-102', name:'M Blastoise EX', number:'102', set:'xy12', setName:'Evolutions', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy12/102/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy12/102/high.png' },
  { id:'xy12-13', name:'M Charizard EX', number:'13', set:'xy12', setName:'Evolutions', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy12/13/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy12/13/high.png' },
  { id:'xy12-2', name:'M Venusaur EX', number:'2', set:'xy12', setName:'Evolutions', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy12/2/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy12/2/high.png' },
  { id:'xy12-22', name:'M Blastoise EX', number:'22', set:'xy12', setName:'Evolutions', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy12/22/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy12/22/high.png' },
  { id:'xy2-107', name:'M Charizard EX', number:'107', set:'xy2', setName:'Flashfire', rarity:'Secret Rare', image:'https://assets.tcgdex.net/en/xy/xy2/107/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy2/107/high.png' },
  { id:'xy2-108', name:'M Charizard EX', number:'108', set:'xy2', setName:'Flashfire', rarity:'Secret Rare', image:'https://assets.tcgdex.net/en/xy/xy2/108/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy2/108/high.png' },
  { id:'xy2-13', name:'M Charizard EX', number:'13', set:'xy2', setName:'Flashfire', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy2/13/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy2/13/high.png' },
  { id:'xy2-69', name:'M Charizard EX', number:'69', set:'xy2', setName:'Flashfire', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy2/69/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy2/69/high.png' },
  { id:'xy6-105', name:'M Rayquaza EX', number:'105', set:'xy6', setName:'Roaring Skies', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy6/105/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy6/105/high.png' },
  { id:'xy6-61', name:'M Rayquaza EX', number:'61', set:'xy6', setName:'Roaring Skies', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy6/61/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy6/61/high.png' },
  { id:'xy6-76', name:'M Rayquaza EX', number:'76', set:'xy6', setName:'Roaring Skies', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy6/76/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy6/76/high.png' },
  { id:'xy7-98', name:'M Rayquaza EX', number:'98', set:'xy7', setName:'Ancient Origins', rarity:'Secret Rare', image:'https://assets.tcgdex.net/en/xy/xy7/98/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy7/98/high.png' },
  { id:'xy8-159', name:'M Mewtwo EX', number:'159', set:'xy8', setName:'BREAKthrough', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy8/159/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy8/159/high.png' },
  { id:'xy8-160', name:'M Mewtwo EX', number:'160', set:'xy8', setName:'BREAKthrough', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy8/160/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy8/160/high.png' },
  { id:'xy8-63', name:'M Mewtwo EX', number:'63', set:'xy8', setName:'BREAKthrough', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy8/63/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy8/63/high.png' },
  { id:'xy8-64', name:'M Mewtwo EX', number:'64', set:'xy8', setName:'BREAKthrough', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy8/64/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy8/64/high.png' },
  { id:'xyp-XY183', name:'Mewtwo-EX', number:'XY183', set:'xyp', setName:'XY Black Star Promos', rarity:'Rare', image:'https://assets.tcgdex.net/en/xy/xyp/XY183/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xyp/XY183/high.png' },
  { id:'xy12-11', name:'Charizard', number:'11', set:'xy12', setName:'Evolutions', rarity:'Rare', image:'https://assets.tcgdex.net/en/xy/xy12/11/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy12/11/high.png' },
  { id:'xy12-12', name:'Charizard EX', number:'12', set:'xy12', setName:'Evolutions', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy12/12/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy12/12/high.png' },
  { id:'xy2-100', name:'Charizard EX', number:'100', set:'xy2', setName:'Flashfire', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy2/100/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy2/100/high.png' },
  { id:'xy2-11', name:'Charizard EX', number:'11', set:'xy2', setName:'Flashfire', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy2/11/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy2/11/high.png' },
  { id:'xy2-12', name:'Charizard EX', number:'12', set:'xy2', setName:'Flashfire', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy2/12/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy2/12/high.png' },
  { id:'xy12-103', name:'Mewtwo EX', number:'103', set:'xy12', setName:'Evolutions', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy12/103/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy12/103/high.png' },
  { id:'xy12-51', name:'Mewtwo', number:'51', set:'xy12', setName:'Evolutions', rarity:'Rare', image:'https://assets.tcgdex.net/en/xy/xy12/51/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy12/51/high.png' },
  { id:'xy12-52', name:'Mewtwo EX', number:'52', set:'xy12', setName:'Evolutions', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy12/52/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy12/52/high.png' },
  { id:'xy8-157', name:'Mewtwo EX', number:'157', set:'xy8', setName:'BREAKthrough', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy8/157/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy8/157/high.png' },
  { id:'xy8-158', name:'Mewtwo EX', number:'158', set:'xy8', setName:'BREAKthrough', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy8/158/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy8/158/high.png' },
  { id:'xy8-163', name:'Mewtwo EX', number:'163', set:'xy8', setName:'BREAKthrough', rarity:'Secret Rare', image:'https://assets.tcgdex.net/en/xy/xy8/163/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy8/163/high.png' },
  { id:'xy8-164', name:'Mewtwo EX', number:'164', set:'xy8', setName:'BREAKthrough', rarity:'Secret Rare', image:'https://assets.tcgdex.net/en/xy/xy8/164/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy8/164/high.png' },
  { id:'xy8-61', name:'Mewtwo EX', number:'61', set:'xy8', setName:'BREAKthrough', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy8/61/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy8/61/high.png' },
  { id:'xy8-62', name:'Mewtwo EX', number:'62', set:'xy8', setName:'BREAKthrough', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy8/62/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy8/62/high.png' },
  { id:'xy6-104', name:'Rayquaza EX', number:'104', set:'xy6', setName:'Roaring Skies', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy6/104/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy6/104/high.png' },
  { id:'xy6-60', name:'Rayquaza EX', number:'60', set:'xy6', setName:'Roaring Skies', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy6/60/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy6/60/high.png' },
  { id:'xy6-75', name:'Rayquaza EX', number:'75', set:'xy6', setName:'Roaring Skies', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy6/75/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy6/75/high.png' },
  { id:'xy10-119', name:'Umbreon EX', number:'119', set:'xy10', setName:'Fates Collide', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy10/119/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy10/119/high.png' },
  { id:'xy10-55', name:'Umbreon EX', number:'55', set:'xy10', setName:'Fates Collide', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy10/55/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy10/55/high.png' },
  { id:'xy1-1', name:'Venusaur EX', number:'1', set:'xy1', setName:'XY', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy1/1/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy1/1/high.png' },
  { id:'xy1-141', name:'Venusaur EX', number:'141', set:'xy1', setName:'XY', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy1/141/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy1/141/high.png' },
  { id:'xy12-1', name:'Venusaur EX', number:'1', set:'xy12', setName:'Evolutions', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy12/1/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy12/1/high.png' },
  { id:'xy1-142', name:'Blastoise EX', number:'142', set:'xy1', setName:'XY', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy1/142/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy1/142/high.png' },
  { id:'xy1-29', name:'Blastoise EX', number:'29', set:'xy1', setName:'XY', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy1/29/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy1/29/high.png' },
  { id:'xy12-21', name:'Blastoise EX', number:'21', set:'xy12', setName:'Evolutions', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/xy/xy12/21/low.png', imageLarge:'https://assets.tcgdex.net/en/xy/xy12/21/high.png' },
  { id:'swsh10.5-004', name:'Radiant Venusaur', number:'004', set:'swsh10.5', setName:'PokÃ©mon GO', rarity:'Radiant Rare', image:'https://assets.tcgdex.net/en/swsh/swsh10.5/004/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh10.5/004/high.png' },
  { id:'swsh10.5-011', name:'Radiant Charizard', number:'011', set:'swsh10.5', setName:'PokÃ©mon GO', rarity:'Radiant Rare', image:'https://assets.tcgdex.net/en/swsh/swsh10.5/011/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh10.5/011/high.png' },
  { id:'swsh10.5-018', name:'Radiant Blastoise', number:'018', set:'swsh10.5', setName:'PokÃ©mon GO', rarity:'Radiant Rare', image:'https://assets.tcgdex.net/en/swsh/swsh10.5/018/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh10.5/018/high.png' },
  { id:'swsh12.5-020', name:'Radiant Charizard', number:'020', set:'swsh12.5', setName:'Crown Zenith', rarity:'Radiant Rare', image:'https://assets.tcgdex.net/en/swsh/swsh12.5/020/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh12.5/020/high.png' },
  { id:'swsh10.5-010', name:'Charizard', number:'010', set:'swsh10.5', setName:'PokÃ©mon GO', rarity:'Holo Rare', image:'https://assets.tcgdex.net/en/swsh/swsh10.5/010/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh10.5/010/high.png' },
  { id:'swsh11-TG03', name:'Charizard', number:'TG03', set:'swsh11', setName:'Lost Origin', rarity:'Rare', image:'https://assets.tcgdex.net/en/swsh/swsh11/TG03/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh11/TG03/high.png' },
  { id:'swsh12.5-018', name:'Charizard V', number:'018', set:'swsh12.5', setName:'Crown Zenith', rarity:'Holo Rare V', image:'https://assets.tcgdex.net/en/swsh/swsh12.5/018/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh12.5/018/high.png' },
  { id:'swsh12.5-019', name:'Charizard VSTAR', number:'019', set:'swsh12.5', setName:'Crown Zenith', rarity:'Holo Rare VSTAR', image:'https://assets.tcgdex.net/en/swsh/swsh12.5/019/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh12.5/019/high.png' },
  { id:'swsh3-19', name:'Charizard V', number:'19', set:'swsh3', setName:'Darkness Ablaze', rarity:'Holo Rare V', image:'https://assets.tcgdex.net/en/swsh/swsh3/19/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh3/19/high.png' },
  { id:'swsh3-20', name:'Charizard VMAX', number:'20', set:'swsh3', setName:'Darkness Ablaze', rarity:'Holo Rare VMAX', image:'https://assets.tcgdex.net/en/swsh/swsh3/20/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh3/20/high.png' },
  { id:'swsh3.5-74', name:'Charizard VMAX', number:'74', set:'swsh3.5', setName:"Champion's Path", rarity:'Secret Rare', image:'https://assets.tcgdex.net/en/swsh/swsh3.5/74/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh3.5/74/high.png' },
  { id:'swsh3.5-79', name:'Charizard V', number:'79', set:'swsh3.5', setName:"Champion's Path", rarity:'Secret Rare', image:'https://assets.tcgdex.net/en/swsh/swsh3.5/79/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh3.5/79/high.png' },
  { id:'swsh4-25', name:'Charizard', number:'25', set:'swsh4', setName:'Vivid Voltage', rarity:'Rare', image:'https://assets.tcgdex.net/en/swsh/swsh4/25/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh4/25/high.png' },
  { id:'swsh9-017', name:'Charizard V', number:'017', set:'swsh9', setName:'Brilliant Stars', rarity:'Holo Rare V', image:'https://assets.tcgdex.net/en/swsh/swsh9/017/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh9/017/high.png' },
  { id:'swsh9-018', name:'Charizard VSTAR', number:'018', set:'swsh9', setName:'Brilliant Stars', rarity:'Holo Rare VSTAR', image:'https://assets.tcgdex.net/en/swsh/swsh9/018/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh9/018/high.png' },
  { id:'swsh9-153', name:'Charizard V', number:'153', set:'swsh9', setName:'Brilliant Stars', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/swsh/swsh9/153/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh9/153/high.png' },
  { id:'swsh9-154', name:'Charizard V', number:'154', set:'swsh9', setName:'Brilliant Stars', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/swsh/swsh9/154/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh9/154/high.png' },
  { id:'swsh9-174', name:'Charizard VSTAR', number:'174', set:'swsh9', setName:'Brilliant Stars', rarity:'Secret Rare', image:'https://assets.tcgdex.net/en/swsh/swsh9/174/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh9/174/high.png' },
  { id:'swsh10.5-030', name:'Mewtwo V', number:'030', set:'swsh10.5', setName:'PokÃ©mon GO', rarity:'Holo Rare V', image:'https://assets.tcgdex.net/en/swsh/swsh10.5/030/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh10.5/030/high.png' },
  { id:'swsh10.5-031', name:'Mewtwo VSTAR', number:'031', set:'swsh10.5', setName:'PokÃ©mon GO', rarity:'Holo Rare VMAX', image:'https://assets.tcgdex.net/en/swsh/swsh10.5/031/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh10.5/031/high.png' },
  { id:'swsh10.5-072', name:'Mewtwo V', number:'072', set:'swsh10.5', setName:'PokÃ©mon GO', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/swsh/swsh10.5/072/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh10.5/072/high.png' },
  { id:'swsh10.5-079', name:'Mewtwo VSTAR', number:'079', set:'swsh10.5', setName:'PokÃ©mon GO', rarity:'Secret Rare', image:'https://assets.tcgdex.net/en/swsh/swsh10.5/079/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh10.5/079/high.png' },
  { id:'swsh10.5-086', name:'Mewtwo VSTAR', number:'086', set:'swsh10.5', setName:'PokÃ©mon GO', rarity:'Secret Rare', image:'https://assets.tcgdex.net/en/swsh/swsh10.5/086/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh10.5/086/high.png' },
  { id:'swsh12.5-059', name:'Mewtwo', number:'059', set:'swsh12.5', setName:'Crown Zenith', rarity:'Holo Rare', image:'https://assets.tcgdex.net/en/swsh/swsh12.5/059/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh12.5/059/high.png' },
  { id:'swsh12.5-GG44', name:'Mewtwo VSTAR', number:'GG44', set:'swsh12.5', setName:'Crown Zenith', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/swsh/swsh12.5/GG44/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh12.5/GG44/high.png' },
  { id:'swsh9-056', name:'Mewtwo', number:'056', set:'swsh9', setName:'Brilliant Stars', rarity:'Rare', image:'https://assets.tcgdex.net/en/swsh/swsh9/056/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh9/056/high.png' },
  { id:'swsh12-TG20', name:'Rayquaza VMAX', number:'TG20', set:'swsh12', setName:'Silver Tempest', rarity:'Holo Rare VMAX', image:'https://assets.tcgdex.net/en/swsh/swsh12/TG20/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh12/TG20/high.png' },
  { id:'swsh12-TG29', name:'Rayquaza VMAX', number:'TG29', set:'swsh12', setName:'Silver Tempest', rarity:'Secret Rare', image:'https://assets.tcgdex.net/en/swsh/swsh12/TG29/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh12/TG29/high.png' },
  { id:'swsh12.5-100', name:'Rayquaza V', number:'100', set:'swsh12.5', setName:'Crown Zenith', rarity:'Holo Rare V', image:'https://assets.tcgdex.net/en/swsh/swsh12.5/100/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh12.5/100/high.png' },
  { id:'swsh12.5-101', name:'Rayquaza VMAX', number:'101', set:'swsh12.5', setName:'Crown Zenith', rarity:'Holo Rare VMAX', image:'https://assets.tcgdex.net/en/swsh/swsh12.5/101/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh12.5/101/high.png' },
  { id:'swsh12.5-102', name:'Rayquaza VMAX', number:'102', set:'swsh12.5', setName:'Crown Zenith', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/swsh/swsh12.5/102/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh12.5/102/high.png' },
  { id:'swsh4-138', name:'Rayquaza', number:'138', set:'swsh4', setName:'Vivid Voltage', rarity:'Amazing Rare', image:'https://assets.tcgdex.net/en/swsh/swsh4/138/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh4/138/high.png' },
  { id:'swsh7-110', name:'Rayquaza V', number:'110', set:'swsh7', setName:'Evolving Skies', rarity:'Holo Rare V', image:'https://assets.tcgdex.net/en/swsh/swsh7/110/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh7/110/high.png' },
  { id:'swsh7-111', name:'Rayquaza VMAX', number:'111', set:'swsh7', setName:'Evolving Skies', rarity:'Holo Rare VMAX', image:'https://assets.tcgdex.net/en/swsh/swsh7/111/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh7/111/high.png' },
  { id:'swsh7-193', name:'Rayquaza V', number:'193', set:'swsh7', setName:'Evolving Skies', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/swsh/swsh7/193/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh7/193/high.png' },
  { id:'swsh7-194', name:'Rayquaza V', number:'194', set:'swsh7', setName:'Evolving Skies', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/swsh/swsh7/194/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh7/194/high.png' },
  { id:'swsh7-217', name:'Rayquaza VMAX', number:'217', set:'swsh7', setName:'Evolving Skies', rarity:'Secret Rare', image:'https://assets.tcgdex.net/en/swsh/swsh7/217/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh7/217/high.png' },
  { id:'swsh7-218', name:'Rayquaza VMAX', number:'218', set:'swsh7', setName:'Evolving Skies', rarity:'Secret Rare', image:'https://assets.tcgdex.net/en/swsh/swsh7/218/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh7/218/high.png' },
  { id:'swsh7-188', name:'Umbreon V', number:'188', set:'swsh7', setName:'Evolving Skies', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/swsh/swsh7/188/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh7/188/high.png' },
  { id:'swsh7-189', name:'Umbreon V', number:'189', set:'swsh7', setName:'Evolving Skies', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/swsh/swsh7/189/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh7/189/high.png' },
  { id:'swsh7-214', name:'Umbreon VMAX', number:'214', set:'swsh7', setName:'Evolving Skies', rarity:'Secret Rare', image:'https://assets.tcgdex.net/en/swsh/swsh7/214/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh7/214/high.png' },
  { id:'swsh7-215', name:'Umbreon VMAX', number:'215', set:'swsh7', setName:'Evolving Skies', rarity:'Secret Rare', image:'https://assets.tcgdex.net/en/swsh/swsh7/215/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh7/215/high.png' },
  { id:'swsh7-94', name:'Umbreon V', number:'94', set:'swsh7', setName:'Evolving Skies', rarity:'Holo Rare V', image:'https://assets.tcgdex.net/en/swsh/swsh7/94/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh7/94/high.png' },
  { id:'swsh7-95', name:'Umbreon VMAX', number:'95', set:'swsh7', setName:'Evolving Skies', rarity:'Holo Rare VMAX', image:'https://assets.tcgdex.net/en/swsh/swsh7/95/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh7/95/high.png' },
  { id:'swsh9-TG22', name:'Umbreon V', number:'TG22', set:'swsh9', setName:'Brilliant Stars', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/swsh/swsh9/TG22/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh9/TG22/high.png' },
  { id:'swsh9-TG23', name:'Umbreon VMAX', number:'TG23', set:'swsh9', setName:'Brilliant Stars', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/swsh/swsh9/TG23/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh9/TG23/high.png' },
  { id:'swsh10.5-003', name:'Venusaur', number:'003', set:'swsh10.5', setName:'PokÃ©mon GO', rarity:'Holo Rare', image:'https://assets.tcgdex.net/en/swsh/swsh10.5/003/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh10.5/003/high.png' },
  { id:'swsh3.5-1', name:'Venusaur V', number:'1', set:'swsh3.5', setName:"Champion's Path", rarity:'Holo Rare V', image:'https://assets.tcgdex.net/en/swsh/swsh3.5/1/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh3.5/1/high.png' },
  { id:'swsh10.5-017', name:'Blastoise', number:'017', set:'swsh10.5', setName:'PokÃ©mon GO', rarity:'Holo Rare', image:'https://assets.tcgdex.net/en/swsh/swsh10.5/017/low.png', imageLarge:'https://assets.tcgdex.net/en/swsh/swsh10.5/017/high.png' },
  { id:'sv10-213', name:"Team Rocket's Mewtwo ex", number:'213', set:'sv10', setName:'Destined Rivals', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/sv/sv10/213/low.png', imageLarge:'https://assets.tcgdex.net/en/sv/sv10/213/high.png' },
  { id:'sv03-215', name:'Charizard ex', number:'215', set:'sv03', setName:'Obsidian Flames', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/sv/sv03/215/low.png', imageLarge:'https://assets.tcgdex.net/en/sv/sv03/215/high.png' },
  { id:'sv03.5-183', name:'Charizard ex', number:'183', set:'sv03.5', setName:'151', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/sv/sv03.5/183/low.png', imageLarge:'https://assets.tcgdex.net/en/sv/sv03.5/183/high.png' },
  { id:'sv03.5-150', name:'Mewtwo', number:'150', set:'sv03.5', setName:'151', rarity:'Rare', image:'https://assets.tcgdex.net/en/sv/sv03.5/150/low.png', imageLarge:'https://assets.tcgdex.net/en/sv/sv03.5/150/high.png' },
  { id:'sv08.5-059', name:'Umbreon', number:'059', set:'sv08.5', setName:'Prismatic Evolutions', rarity:'Rare', image:'https://assets.tcgdex.net/en/sv/sv08.5/059/low.png', imageLarge:'https://assets.tcgdex.net/en/sv/sv08.5/059/high.png' },
  { id:'sv03.5-182', name:'Venusaur ex', number:'182', set:'sv03.5', setName:'151', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/sv/sv03.5/182/low.png', imageLarge:'https://assets.tcgdex.net/en/sv/sv03.5/182/high.png' },
  { id:'sv03.5-184', name:'Blastoise ex', number:'184', set:'sv03.5', setName:'151', rarity:'Ultra Rare', image:'https://assets.tcgdex.net/en/sv/sv03.5/184/low.png', imageLarge:'https://assets.tcgdex.net/en/sv/sv03.5/184/high.png' },
];

/* Busca instantÃ¢nea na base local */
const searchLocalCards = (query) => {
  if (!query.trim()) return [];
  const q = query.toLowerCase().trim();
  return LOCAL_CARDS.filter(c =>
    c.name.toLowerCase().includes(q) ||
    c.number.toLowerCase().includes(q) ||
    (c.set?.name || '').toLowerCase().includes(q) ||
    (c.rarity || '').toLowerCase().includes(q)
  ).slice(0, 20);
};

/* â”€â”€â”€ CONSTANTES GLOBAIS â”€â”€â”€ */
const QUALITY_COLOR = { M:'bg-yellow-400',NM:'bg-green-500',SP:'bg-blue-500',MP:'bg-orange-400',HP:'bg-red-500',D:'bg-gray-500' };
const QUALITY_DESC  = { M:'Mint',NM:'Near Mint',SP:'Slightly Played',MP:'Moderately Played',HP:'Heavily Played',D:'Damaged' };

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP ROOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TCGDEX â€” funÃ§Ãµes compartilhadas (globais)
   Usadas em SearchWantedScreen e AuctioneerScreen
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TCGDEX_API    = 'https://api.tcgdex.net/v2/en/cards';
const TCGDEX_API_PT = 'https://api.tcgdex.net/v2/pt-br/cards';

const normalizeTcgdex = (c, namePt) => ({
  id:     c.id,
  name:   namePt || c.name,          // nome PT-BR quando disponÃ­vel
  nameEn: c.name,                    // nome EN sempre preservado
  namePt: namePt || null,
  number: c.localId || '',
  rarity: c.rarity || '',
  set:    { name: getSetName(
              (c.set && c.set.id) || c.id.split('-').slice(0,-1).join('-'),
              (c.set && c.set.name) || null
            ) },
  images: { small: c.image ? c.image + '/low.png' : '', large: c.image ? c.image + '/high.png' : '' },
});

const PROMO_SETS = {
  'SVP':'svp', 'MEP':'mep', 'SWSHP':'swshp', 'XYP':'xyp',
  'BWP':'bwp', 'POP':'pop', 'HGSS':'hgss', 'DPP':'dp',
};

const detectarTipoBusca = (q) => {
  const qu = q.trim().toUpperCase();
  const matchPromoTotal = qu.match(/^([A-Z]{2,5})\s+(\d{1,4})\s*\/\s*[A-Z]*\s*(\d{1,4})$/);
  if (matchPromoTotal) { const setId = PROMO_SETS[matchPromoTotal[1]]; if (setId) return { tipo: 'id', valor: setId + '-' + matchPromoTotal[2].padStart(3,'0') }; }
  const matchPromo = qu.match(/^([A-Z]{2,5})\s+(\d{1,4})$/);
  if (matchPromo) { const setId = PROMO_SETS[matchPromo[1]]; if (setId) return { tipo: 'id', valor: setId + '-' + matchPromo[2].padStart(3,'0') }; }
  const matchAlfa = q.match(/^([A-Za-z]{1,4}\d{1,4})\s*\/\s*([A-Za-z]{1,4}\d{1,4})$/i);
  if (matchAlfa) return { tipo: 'alfatotal', numero: matchAlfa[1].toUpperCase(), total: matchAlfa[2].toUpperCase() };
  const matchNumTotal = q.match(/^(\d+)\s*\/\s*(\d+)$/);
  if (matchNumTotal) return { tipo: 'numtotal', numero: matchNumTotal[1], total: parseInt(matchNumTotal[2], 10) };
  if (/^[a-z0-9.]+-[a-zA-Z0-9]+$/.test(q)) return { tipo: 'id', valor: q };
  if (/^[A-Za-z]{1,4}\d{1,4}$/.test(q)) return { tipo: 'alfanumero', valor: q.toUpperCase() };
  if (/^\d{1,4}$/.test(q)) return { tipo: 'numero', valor: q };
  return { tipo: 'nome', valor: q };
};

const fetchDetalhes = async (id) => {
  try {
    const res = await fetch(TCGDEX_API + '/' + encodeURIComponent(id));
    if (!res.ok) return null;
    return await res.json();
  } catch { return null; }
};

// Busca nome PT-BR para um conjunto de cartas EN (por id)
const buscarNomesPt = async (cartas) => {
  // Mapeia id â†’ nome PT-BR
  const mapaIds = {};
  // Busca os IDs Ãºnicos em pt-br (atÃ© 20 cartas em paralelo)
  await Promise.all(cartas.slice(0, 20).map(async (c) => {
    try {
      const res = await fetch(TCGDEX_API_PT + '/' + encodeURIComponent(c.id));
      if (res.ok) {
        const d = await res.json();
        if (d && d.name) mapaIds[c.id] = d.name;
      }
    } catch { /* silencioso */ }
  }));
  return mapaIds;
};

// Executa a busca TCGdex completa com suporte bilÃ­ngue
const tcgdexBuscar = async (q) => {
  const busca = detectarTipoBusca(q);

  // â”€â”€ Busca por nome: dispara EN + PT-BR em paralelo e mescla â”€â”€â”€â”€â”€â”€
  if (busca.tipo === 'nome') {
    const [resEn, resPt] = await Promise.allSettled([
      fetch(TCGDEX_API    + '?name=' + encodeURIComponent(busca.valor)),
      fetch(TCGDEX_API_PT + '?name=' + encodeURIComponent(busca.valor)),
    ]);

    const cartasEn  = resEn.status === 'fulfilled' && resEn.value.ok
      ? (await resEn.value.json()).filter(c => c.image && c.id)
      : [];
    const cartasPt  = resPt.status === 'fulfilled' && resPt.value.ok
      ? (await resPt.value.json()).filter(c => c.image && c.id)
      : [];

    // Mapa PT: id â†’ nome PT
    const mapaId2pt = {};
    cartasPt.forEach(c => { mapaId2pt[c.id] = c.name; });

    // Cartas PT que nÃ£o estÃ£o em EN (raridade de pt-br ter card extra)
    const idsEn = new Set(cartasEn.map(c => c.id));
    const soPt  = cartasPt.filter(c => !idsEn.has(c.id));

    // Mescla: todas as EN (com nome PT se disponÃ­vel) + exclusivas PT
    const todas = [
      ...cartasEn.map(c => normalizeTcgdex(c, mapaId2pt[c.id] || null)),
      ...soPt.map(c => normalizeTcgdex(c, c.name)),
    ];

    return todas.slice(0, 40);
  }

  // â”€â”€ Busca por ID direto: tenta pegar nome PT tambÃ©m â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (busca.tipo === 'id') {
    const [resEn, resPt] = await Promise.allSettled([
      fetch(TCGDEX_API    + '/' + encodeURIComponent(busca.valor)),
      fetch(TCGDEX_API_PT + '/' + encodeURIComponent(busca.valor)),
    ]);
    if (resEn.status !== 'fulfilled' || !resEn.value.ok) return [];
    const data   = await resEn.value.json();
    const namePt = resPt.status === 'fulfilled' && resPt.value.ok
      ? (await resPt.value.json()).name : null;
    return data && data.id ? [normalizeTcgdex(data, namePt)] : [];
  }

  // â”€â”€ NÃºmero/total, alfatotal, alfanumero, numero: sÃ³ EN (o nÃºmero â”€â”€
  // Ã© universal â€” busca PT-BR depois para enriquecer os nomes)     â”€â”€
  let cartasEn = [];

  if (busca.tipo === 'numtotal') {
    const numSemZero = String(parseInt(busca.numero, 10));
    const res = await fetch(TCGDEX_API + '?localId=' + encodeURIComponent(numSemZero));
    if (!res.ok) return [];
    const lista = await res.json();
    if (!Array.isArray(lista) || lista.length === 0) return [];
    const candidatas = lista.filter(c => c.image && c.id);
    const detalhes = await Promise.all(candidatas.map(c => fetchDetalhes(c.id)));
    cartasEn = detalhes.filter(d =>
      d && d.set?.cardCount?.official === busca.total && parseInt(d.localId, 10) === parseInt(busca.numero, 10)
    );
  } else if (busca.tipo === 'alfatotal') {
    const res = await fetch(TCGDEX_API + '?localId=' + encodeURIComponent(busca.numero));
    if (!res.ok) return [];
    const lista = await res.json();
    if (!Array.isArray(lista) || lista.length === 0) return [];
    const candidatas = lista.filter(c => c.image && c.id);
    const detalhes = await Promise.all(candidatas.map(c => fetchDetalhes(c.id)));
    const totalNum = parseInt(busca.total.replace(/^[A-Za-z]+/, ''), 10);
    cartasEn = detalhes.filter(d =>
      d && (d.localId||'').toUpperCase() === busca.numero && d.set?.cardCount?.official === totalNum
    );
  } else if (busca.tipo === 'alfanumero') {
    const res = await fetch(TCGDEX_API + '?localId=' + encodeURIComponent(busca.valor));
    if (!res.ok) return [];
    const data = await res.json();
    cartasEn = Array.isArray(data) ? data.filter(c => c.image && c.id) : [];
  } else if (busca.tipo === 'numero') {
    const numSemZero = String(parseInt(busca.valor, 10));
    const res = await fetch(TCGDEX_API + '?localId=' + encodeURIComponent(numSemZero));
    if (!res.ok) return [];
    const data = await res.json();
    cartasEn = Array.isArray(data) ? data.filter(c => c.image && c.id) : [];
  }

  if (cartasEn.length === 0) return [];

  // Enriquecer com nomes PT em paralelo
  const mapaId2pt = await buscarNomesPt(cartasEn);
  return cartasEn.map(c => normalizeTcgdex(c, mapaId2pt[c.id] || null));
};

/* â”€â”€â”€ buscarCartaIdioma â€” Busca inteligente para import Excel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const buscarCartaIdioma = async (numero, nome, idioma = 'EN', setIdOverride = '') => {
  const JP_ONLY = idioma === 'JP';
  const baseUrl = JP_ONLY ? 'https://api.tcgdex.net/v2/ja/cards' : TCGDEX_API;
  
  // Normalizar nÃºmero
  let searchNum = String(numero).trim().toUpperCase();
  
  // Detectar tipo de carta
  const isPromo = /^[A-Z]+-?\d+$/.test(searchNum); // SVP-001, XY84
  const isSubset = /^[A-Z]{2}\d+\/[A-Z]{2}\d+$/.test(searchNum); // TG30/TG30
  const isNormal = /^\d+\/\d+$/.test(searchNum); // 006/165
  
  let searchId = null;
  
  if (setIdOverride) {
    // Se tem Set definido, usar ele
    const num = searchNum.replace(/[^0-9]/g, '');
    searchId = `${setIdOverride}-${num}`;
  } else if (isPromo) {
    // Promos: SVP-001 â†’ svp-001 (lowercase)
    searchId = searchNum.toLowerCase().replace('-', '-');
    // ExceÃ§Ã£o: XY promos precisam de "xyp-" prefix
    if (/^XY\d+$/.test(searchNum)) {
      searchId = `xyp-${searchNum.toLowerCase()}`;
    }
  } else if (isSubset) {
    // Subsets: TG30/TG30 â†’ buscar pelo total
    const match = searchNum.match(/^([A-Z]{2})(\d+)\/[A-Z]{2}(\d+)$/);
    if (match) {
      const prefix = match[1].toLowerCase();
      const num = parseInt(match[2], 10);
      const total = parseInt(match[3], 10);
      
      try {
        const res = await fetch(`${baseUrl}?localId=${num}`);
        if (res.ok) {
          const cards = await res.json();
          const found = cards.find(c => 
            c.set?.cardCount?.official === total &&
            c.localId?.toLowerCase() === searchNum.toLowerCase()
          );
          if (found) return found;
        }
      } catch (e) {}
    }
  } else if (isNormal) {
    // Normal: 006/165 â†’ buscar pelo total
    const [num, total] = searchNum.split('/').map(n => parseInt(n, 10));
    
    try {
      const res = await fetch(`${baseUrl}?localId=${num}`);
      if (res.ok) {
        const cards = await res.json();
        const found = cards.find(c => c.set?.cardCount?.official === total);
        if (found) return found;
      }
    } catch (e) {}
  }
  
  // Se nÃ£o achou, tentar buscar por ID direto
  if (searchId) {
    try {
      const res = await fetch(`${baseUrl}/${searchId}`);
      if (res.ok) return await res.json();
    } catch (e) {}
  }
  
  // Fallback: buscar por nome
  if (nome) {
    try {
      const res = await fetch(`${baseUrl}?name=${encodeURIComponent(nome)}`);
      if (res.ok) {
        const cards = await res.json();
        return cards[0];
      }
    } catch (e) {}
  }
  
  return null;
};

/* â”€â”€â”€ BlocoCarrossel â€” componente reutilizÃ¡vel para fotos dos blocos â”€â”€â”€ */
const BlocoCarrossel = ({ fotos, dark = true }) => {
  const [ativo, setAtivo] = React.useState(0);
  if (!fotos || fotos.length === 0) return null;
  return (
    <div className={`rounded-2xl overflow-hidden border-2 border-yellow-300 shadow-xl ${dark ? 'bg-gray-900' : 'bg-gray-100'}`}>
      <div className={`flex items-center justify-between px-3 py-1.5 ${dark ? 'bg-gray-800' : 'bg-gray-200'}`}>
        <span className="text-yellow-400 text-[11px] font-black tracking-wide">ðŸ“¦ BLOCOS DO LEILÃƒO</span>
        <span className={`text-[10px] ${dark ? 'text-gray-400' : 'text-gray-500'}`}>{ativo + 1} / {fotos.length}</span>
      </div>
      <div className="relative">
        <img src={fotos[ativo]} alt={`Bloco ${ativo + 1}`}
          className={`w-full object-contain max-h-72 ${dark ? 'bg-gray-900' : 'bg-white'}`}
          onError={e => { e.target.parentElement.style.display = 'none'; }} />
        <div className="absolute bottom-2 left-2 bg-black/70 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">
          Bloco {ativo + 1}
        </div>
        {fotos.length > 1 && (
          <>
            <button onClick={() => setAtivo(a => Math.max(0, a - 1))} disabled={ativo === 0}
              className="absolute left-2 top-1/2 -translate-y-1/2 bg-black/60 text-white w-8 h-8 rounded-full flex items-center justify-center text-4xl disabled:opacity-20 hover:bg-black/80">â€¹</button>
            <button onClick={() => setAtivo(a => Math.min(fotos.length - 1, a + 1))} disabled={ativo === fotos.length - 1}
              className="absolute right-2 top-1/2 -translate-y-1/2 bg-black/60 text-white w-8 h-8 rounded-full flex items-center justify-center text-4xl disabled:opacity-20 hover:bg-black/80">â€º</button>
          </>
        )}
      </div>
      {fotos.length > 1 && (
        <div className={`flex gap-1.5 p-2 overflow-x-auto ${dark ? 'bg-gray-800' : 'bg-gray-200'}`}>
          {fotos.map((url, i) => (
            <button key={i} onClick={() => setAtivo(i)}
              className={`flex-shrink-0 w-12 h-12 rounded-lg overflow-hidden border-2 transition-all ${ativo === i ? 'border-yellow-400' : 'border-gray-600 opacity-50 hover:opacity-90'}`}>
              <img src={url} className="w-full h-full object-cover" alt={`Bloco ${i+1}`} />
            </button>
          ))}
        </div>
      )}
    </div>
  );
};

/* â”€â”€â”€ Filtro de raridade comum â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Raridades "nÃ£o raras" no TCGdex: Common, Uncommon, None, vazia.
   Tudo que NÃƒO estiver nessa lista Ã© considerado raro e mantido.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const RARIDADES_COMUNS = new Set([
  'common', 'uncommon', 'none', '',
]);
const isRaridadeComum = (rarity) =>
  RARIDADES_COMUNS.has((rarity || '').toLowerCase().trim());

const filtrarComuns = (cards) =>
  cards.filter(c => !isRaridadeComum(c.rarity));

/* â”€â”€â”€ Mapa de set IDs â†’ nomes completos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Cobre as sÃ©ries principais. Fallback: busca em tempo real.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const SET_NAMES = {
  // Scarlet & Violet
  'sv1':'Escarlate e Violeta', 'sv2':'EvoluÃ§Ã£o em Paldea', 'sv3':'Obsidiana em Chamas',
  'sv4':'Fenda Paradoxal', 'sv5':'ForÃ§as Temporais', 'sv6':'MÃ¡scaras do CrepÃºsculo',
  'sv7':'Coroa Estelar', 'sv8':'TrovÃµes Surreais', 'sv9':'Jornada Brilhante',
  'svp':'Escarlate e Violeta Promo',
  // Sword & Shield
  'swsh1':'Espada e Escudo', 'swsh2':'RebeliÃ£o Chocante', 'swsh3':'Trevas Ardentes',
  'swsh3.5':'Destinos de Champion', 'swsh4':'CampeÃµes Brilhantes',
  'swsh4.5':'Shining Fates', 'swsh5':'Batalha de Estilos',
  'swsh6':'Reinado Gelado', 'swsh6.5':'EvoluÃ§Ã£o CÃ©ltica',
  'swsh7':'CÃ©us em EvoluÃ§Ã£o', 'swsh8':'FusÃ£o Surpreendente',
  'swsh9':'Estrelas Brilhantes', 'swsh9.5':'PokÃ©mon GO',
  'swsh10':'Origem Perdida', 'swsh11':'Tempestade Prateada',
  'swsh12':'Regulamento Vermelho e Azul', 'swsh12.5':'Coroa Zenith',
  'swshp':'Espada e Escudo Promo',
  // Sun & Moon
  'sm1':'Sol e Lua', 'sm2':'GuardiÃµes das Alturas', 'sm3':'Sombras Ardentes',
  'sm3.5':'Shining Legends', 'sm4':'AlianÃ§a MÃ¡gica', 'sm5':'Ultra Prisma',
  'sm6':'Aliados Poderosos', 'sm7':'Destinos Proibidos', 'sm8':'Poder da Lenda',
  'sm9':'Tempestade Celestial', 'sm10':'Duplo Impacto', 'sm11':'Elo InquebrÃ¡vel',
  'sm12':'Astros CÃ³smicos', 'smp':'Sol e Lua Promo',
  // XY
  'xy1':'XY', 'xy2':'CanhÃ£o a Vapor', 'xy3':'Flashpoint', 'xy4':'ColeÃ§Ã£o Fantasma',
  'xy5':'Canto Primal', 'xy6':'Ancient Origins', 'xy7':'BREAKthrough',
  'xy8':'BREAKpoint', 'xy9':'GeraÃ§Ã£o Fabulosa', 'xy10':'Steam Siege',
  'xy11':'Evolved Battle Arsenal', 'xy12':'Segredos EvoluÃ­dos', 'xyp':'XY Promo',
  // Black & White / HeartGold SoulSilver / DP / Base
  'bw1':'Preto e Branco', 'bw2':'Emerging Powers', 'bw3':'Noble Victories',
  'bw4':'Next Destinies', 'bw5':'Dark Explorers', 'bw6':'Dragons Exalted',
  'bwp':'Preto e Branco Promo',
  'hgss1':'HeartGold SoulSilver', 'hgss2':'Unleashed', 'hgss3':'Undaunted', 'hgss4':'Triumphant',
  'dp1':'Diamante e PÃ©rola', 'dp2':'MistÃ©rio de Majectic', 'dp3':'Secretos das Ilhas',
  'dp4':'Grandes Encontros', 'dp5':'Majestic Dawn', 'dp6':'Legends Awakened', 'dp7':'Stormfront',
  'base1':'Base Set', 'base2':'Jungle', 'base3':'Fossil', 'base4':'Base Set 2', 'base5':'Team Rocket',
  'gym1':'Gym Heroes', 'gym2':'Gym Challenge', 'neo1':'Neo Genesis', 'neo2':'Neo Discovery',
  'neo3':'Neo Revelation', 'neo4':'Neo Destiny',
  // Paldea e especiais
  'mep':'Mega Evolution Promo', 'pop':'POP Series', 'cel25':'Celebrations',
  'cel25c':'Celebrations Classic Collection',
};

const getSetName = (setId, fallback) => SET_NAMES[setId] || fallback || setId;


const CardModal = ({ data, onClose, wantedList, checkins, toggleCheckin, setModalEvent, addToWanted, removeWanted }) => {
  const { card, setName, imgSrc, rarity, auctions, rarityColor } = data;
  const inWanted = wantedList.find(w => w.id === card.id);
  // Monta URL high/low a partir da base sem extensÃ£o, com fallback para small
  const baseUrl  = card.images ? card.images.small.replace('/low.png', '') : '';
  const largeSrc = baseUrl ? baseUrl + '/high.png' : imgSrc;
  return (
    <div className="fixed inset-0 bg-black/75 backdrop-blur-sm z-[9999] flex items-end md:items-center justify-center"
      onClick={e=>{ if(e.target===e.currentTarget) onClose(); }}>
      <div className="bg-white w-full md:max-w-sm md:rounded-3xl rounded-t-3xl max-h-[92vh] overflow-y-auto shadow-2xl modal-enter"
        onClick={e=>e.stopPropagation()}
        onTouchStart={e=>e.stopPropagation()}
        onTouchEnd={e=>e.stopPropagation()}>

        {/* Header */}
        <div className="sticky top-0 bg-gradient-to-r from-gray-800 to-gray-900 text-white p-4 rounded-t-3xl flex items-center justify-between z-10">
          <div>
            <p className="font-black text-4xl leading-tight">{card.name}</p>
            {card.namePt && card.namePt !== card.nameEn && (
              <p className="text-[11px] text-yellow-300 font-semibold mt-0.5">ðŸ‡§ðŸ‡· {card.namePt}</p>
            )}
            <p className="text-xs text-gray-400 mt-0.5">{setName} Â· <span className="font-mono">#{card.number}</span></p>
          </div>
          <button onClick={onClose} className="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center hover:bg-white/30 flex-shrink-0">âœ•</button>
        </div>

        <div className="p-5 space-y-4">

          {/* Imagem grande centralizada */}
          <div className="flex justify-center">
            {largeSrc
              ? <img src={largeSrc} alt={card.name} className="h-64 w-auto object-contain rounded-2xl shadow-2xl" onError={e => { e.target.src = imgSrc; }} />
              : <div className="h-64 w-44 bg-gray-100 rounded-2xl flex items-center justify-center text-5xl">ðŸŽ´</div>
            }
          </div>

          {/* Raridade */}
          {rarity && (
            <div className="flex justify-center">
              <span className={'text-4xl font-bold px-4 py-1.5 rounded-full ' + rarityColor}>{rarity}</span>
            </div>
          )}

          {/* LeilÃµes onde aparece */}
          {auctions.length > 0 && (
            <div>
              <p className="text-[11px] font-black text-green-600 uppercase tracking-widest mb-2">âœ… Presente em {auctions.length} leilÃ£{auctions.length > 1 ? 'Ãµes' : 'Ã£o'}</p>
              <div className="space-y-2">
                {auctions.map((ev, j) => (
                  <div key={j} className="bg-green-50 border-2 border-green-200 rounded-2xl p-3">
                    <p className="font-bold text-gray-800 text-4xl leading-tight">{ev.title}</p>
                    <p className="text-xs text-gray-500 mt-0.5">
                      {new Date(ev.date).toLocaleDateString('pt-BR',{day:'2-digit',month:'short',year:'numeric'})} Â· {ev.time}
                    </p>
                    <div className="flex gap-2 mt-2">
                      <button onClick={() => { onClose(); setModalEvent(ev); }}
                        className="flex-1 bg-blue-600 text-white py-2 rounded-xl text-4xl font-bold">
                        Ver LeilÃ£o â†’
                      </button>
                      <button onClick={() => toggleCheckin(ev.id)}
                        className={'px-4 py-2 rounded-xl text-sm font-bold ' + (checkins.includes(ev.id) ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600')}>
                        {checkins.includes(ev.id) ? 'âœ“' : 'ðŸ””'}
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* AÃ§Ã£o â€” Wanted List */}
          <button
            onClick={() => {
              if (inWanted) {
                removeWanted(card.id);
              } else {
                addToWanted({ id:card.id, name:card.name, number:card.number, set:setName, img:largeSrc });
              }
              onClose();
            }}
            className={'w-full py-3 rounded-2xl text-sm font-black ' + (inWanted ? 'bg-yellow-400 text-gray-900' : 'bg-yellow-50 border-2 border-yellow-400 text-yellow-700')}>
            {inWanted ? 'â­ Remover da Wanted List' : 'â˜† Adicionar Ã  Wanted List'}
          </button>

        </div>
      </div>
    </div>
  );
};


const EventModal = ({ event, onClose, wantedList, matchWanted, AUCTION_GROUPS, checkins, toggleCheckin, addToWanted, removeWanted }) => {
  const [verCartas, setVerCartas] = React.useState(false);
  
  // Debug: Ver se componente estÃ¡ sendo remontado
  React.useEffect(() => {
    console.log('ðŸ”„ EventModal montado/atualizado');
  }, []);
  
  // Grupo vinculado ao evento (se existir)
  const grupo = AUCTION_GROUPS.find(g => g.id === event.groupId);
  
  // PROTEÃ‡ÃƒO: Garantir que cards existe e Ã© um array
  const cards = Array.isArray(event.cards) ? event.cards : [];

  return (
  <div className="fixed inset-0 bg-black/75 backdrop-blur-sm z-[9999] flex items-end md:items-center justify-center"
    onClick={e=>{ if(e.target===e.currentTarget) onClose(); }}>
    <div className="bg-white w-full md:max-w-xl md:rounded-3xl rounded-t-3xl max-h-[92vh] overflow-y-auto shadow-2xl modal-enter"
      onClick={e=>e.stopPropagation()}>

      {/* â”€â”€ Header: avatar + nome do leiloeiro â”€â”€ */}
      <div className="sticky top-0 z-30 bg-gradient-to-r from-gray-800 to-gray-900 text-white rounded-t-3xl">
        <div className="flex items-center gap-3 p-4">
          {/* Avatar */}
          <div className="flex-shrink-0">
            {event.announcementPhoto ? (
              <img src={event.announcementPhoto} alt={event.organizer}
                className="w-12 h-12 rounded-full object-cover border-2 border-yellow-400 shadow-lg" />
            ) : grupo ? (
              <div className={`w-12 h-12 rounded-full bg-gradient-to-br ${grupo.color} flex items-center justify-center text-2xl border-2 border-yellow-400 shadow-lg`}>
                {grupo.emoji}
              </div>
            ) : (
              <div className="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-2xl border-2 border-yellow-400 shadow-lg">
                ðŸŽ´
              </div>
            )}
          </div>
          <div className="flex-1 min-w-0">
            <p className="font-black text-4xl leading-tight truncate">{event.organizer || event.title}</p>
            <p className="text-yellow-300 text-xs font-semibold mt-0.5">
              ðŸ“… {new Date(event.date).toLocaleDateString('pt-BR',{weekday:'short',day:'2-digit',month:'short'})} Â· â° {event.time}
            </p>
          </div>
          <button onClick={onClose} className="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center hover:bg-white/30 flex-shrink-0 text-4xl">âœ•</button>
        </div>
        {/* TÃ­tulo do leilÃ£o */}
        <div className="px-4 pb-3 border-t border-white/10 pt-2">
          <p className="text-sm text-gray-300 font-medium leading-snug">{event.title}</p>
        </div>
      </div>

      <div className="p-4 space-y-4">

        {event.eventPhotos && event.eventPhotos.length > 0 && (
          <BlocoCarrossel fotos={event.eventPhotos} dark={true} />
        )}

        {/* â”€â”€ Data/hora + descriÃ§Ã£o â”€â”€ */}
        <div className="bg-red-50 border-2 border-red-100 rounded-2xl p-3">
          <p className="font-bold text-red-700 text-sm">
            ðŸ• {new Date(event.date).toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long'})} Ã s {event.time}
          </p>
          {event.description && <p className="text-sm text-gray-600 mt-1">{event.description}</p>}
        </div>

        {/* â”€â”€ Ver cartas â”€â”€ */}
        <div>
          <button onClick={e=>{e.stopPropagation();setVerCartas(!verCartas);}}
            className={`w-full py-3 rounded-2xl font-bold text-sm flex items-center justify-center gap-2 transition-all border-2 ${verCartas?'bg-gray-800 text-white border-gray-800':'bg-white text-gray-800 border-gray-300 hover:border-gray-500'}`}>
            ðŸŽ´ {verCartas ? 'Ocultar cartas' : `Ver todas as cartas (${cards.length})`}
            <span className="text-lg">{verCartas?'â–²':'â–¼'}</span>
          </button>

          {verCartas && cards.length > 0 && (
            <div className="mt-3">
              <div className="grid grid-cols-2 gap-2">
                {cards.map((card, i) => {
                  // Garantir ID Ãºnico consistente
                  const cardId = card.id || `${card.name}-${card.set || 'unknown'}-${card.number || card.localId || 'no-num'}`.replace(/\s+/g, '-').toLowerCase();
                  const isWanted = wantedList.find(w => w.id === cardId || (card.id && w.id === card.id));
                  
                  return (
                    <div key={i} className={`rounded-xl overflow-hidden border-2 ${isWanted ? 'border-yellow-300 shadow-lg' : 'border-gray-200'} relative`}>
                      {/* BotÃ£o Wanted - CLICÃVEL */}
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          e.preventDefault();
                          if (isWanted) {
                            removeWanted(cardId);
                          } else {
                            addToWanted(card);
                          }
                        }}
                        className={`absolute top-2 right-2 z-10 w-8 h-8 rounded-full flex items-center justify-center text-lg shadow-md transition-all active:scale-90 ${
                          isWanted 
                            ? 'bg-yellow-400 text-gray-900 hover:bg-yellow-500' 
                            : 'bg-white/90 text-gray-400 hover:bg-yellow-100 hover:text-yellow-600'
                        }`}
                        title={isWanted ? 'Remover da Wanted List' : 'Adicionar Ã  Wanted List'}
                      >
                        {isWanted ? 'â­' : 'â˜†'}
                      </button>
                      
                      {/* Badge Wanted */}
                      {isWanted && (
                        <div className="bg-yellow-400 text-gray-900 text-[9px] font-black px-2 py-0.5 text-center">
                          â­ Na sua Wanted List
                        </div>
                      )}
                      
                      {/* Imagem */}
                      <div className="bg-gray-100 flex items-center justify-center p-2" style={{minHeight:'150px'}}>
                        <img src={card.img} alt={card.name}
                          className="h-36 w-auto object-contain drop-shadow-sm"
                          onError={e=>e.target.style.display='none'} />
                      </div>
                      
                      {/* Info */}
                      <div className="px-2 py-1.5 bg-white">
                        <p className="font-black text-gray-800 text-xs leading-snug truncate">{card.name}</p>
                        <p className="text-[10px] text-gray-400 truncate mt-0.5">{card.set}</p>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
        </div>

        {/* â”€â”€ Pagamento â”€â”€ */}
        {(event.paymentMethods || event.paymentDeadline) && (
          <div className="bg-green-50 border-2 border-green-100 rounded-2xl p-3">
            <p className="font-bold text-gray-700 mb-2 text-sm">ðŸ’³ Pagamento</p>
            {event.paymentMethods && event.paymentMethods.length > 0 && (
              <div className="flex flex-wrap gap-2 mb-2">
                {event.paymentMethods.map((m,i)=><span key={i} className="bg-green-500 text-white px-3 py-1 rounded-full text-xs font-bold">ðŸ’° {m}</span>)}
              </div>
            )}
            {event.paymentDeadline && (
              <p className="text-xs text-gray-500">Prazo: <span className="font-bold text-gray-800">{new Date(event.paymentDeadline).toLocaleDateString('pt-BR')}</span></p>
            )}
          </div>
        )}

        {/* â”€â”€ AÃ§Ãµes â”€â”€ */}
        <div className="space-y-2 pb-2">
          <button onClick={e=>{e.stopPropagation();toggleCheckin(event.id);}}
            className={`w-full py-3.5 rounded-xl font-bold shadow-md ${checkins.includes(event.id)?'bg-green-500 text-white':'bg-blue-600 text-white'}`}>
            {checkins.includes(event.id)?'âœ“ Check-in Confirmado':'ðŸ”” Fazer Check-in'}
          </button>
          {event.whatsappLink && (
            <a href={event.whatsappLink} target="_blank" rel="noopener noreferrer"
              className="w-full bg-green-500 text-white py-3.5 rounded-xl font-bold flex items-center justify-center gap-2 shadow-md">
              ðŸ“² Ir para o WhatsApp do Grupo
            </a>
          )}
        </div>
      </div>
    </div>
  </div>
  );
};

/* â”€â”€â”€ BOTTOM NAV â”€â”€â”€ */


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GRUPOS DE LEILÃƒO â€” cadastro dos grupos do WhatsApp
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const AUCTION_GROUPS = [
  { id:'karmaytcg',      name:'KARMA TCG - Ã‰PICO DNS Ã‰PIC...', short:'KARMA TCG',         emoji:'âš¡', color:'from-yellow-500 to-orange-500',  members:null },
  { id:'armarstcg',      name:'ARMARSTCG â— LeilÃµes Notic...', short:'ARMARSTCG',           emoji:'ðŸ†', color:'from-red-500 to-pink-500',        members:null },
  { id:'aliadotcg',      name:'ALIADO TCG - LeilÃµes, Rifas...', short:'ALIADO TCG',        emoji:'ðŸƒ', color:'from-blue-500 to-cyan-500',       members:null },
  { id:'pimtcg',         name:'PIM - Compra Venda LeilÃ£o', short:'PIM TCG',                emoji:'ðŸŽ´', color:'from-green-500 to-teal-500',      members:null },
  { id:'meaplafenby',    name:'MEAPLA EMBY',              short:'MEAPLA EMBY',              emoji:'ðŸŒŸ', color:'from-purple-500 to-indigo-500',   members:null },
  { id:'limacardvenda',  name:'LIMA CARDS & VENDA LG...',  short:'LIMA CARDS',              emoji:'ðŸ‰', color:'from-red-600 to-red-800',         members:null },
  { id:'dreamfieldtcg',  name:'DreamField TCG LeilÃµes, Ve...', short:'DreamField TCG',     emoji:'âœ¨', color:'from-sky-400 to-blue-600',        members:null },
  { id:'dominatcg',      name:'Dominators & grupo E...',   short:'Dominators TCG',          emoji:'ðŸ‘‘', color:'from-yellow-600 to-amber-700',    members:null },
  { id:'dmgtcg',         name:'DMG TCG',                   short:'DMG TCG',                 emoji:'ðŸ’Ž', color:'from-cyan-500 to-blue-700',       members:null },
  { id:'buenohowtcg',    name:'Bueno HowTCG ðŸŽ´ A grupo E...', short:'Bueno HowTCG',        emoji:'ðŸŽ¯', color:'from-orange-400 to-red-500',      members:null },
  { id:'ghostudios',     name:'GhostStudios Card game...',  short:'GhostStudios',            emoji:'ðŸ‘»', color:'from-gray-600 to-gray-900',       members:null },
  { id:'espertogudalupe',name:'Esperto de Gudar Fouks Jr...', short:'Esperto de Gudar',    emoji:'ðŸ¦Š', color:'from-orange-500 to-yellow-600',   members:null },
  { id:'pokemonpikachu', name:'Pokemon Pikachu',            short:'PokÃ©mon Pikachu',         emoji:'âš¡', color:'from-yellow-400 to-yellow-600',   members:null },
  { id:'estandoon',      name:'ESTAMOS ON ðŸŽ´ðŸŽ´ðŸŽ´',         short:'ESTAMOS ON',              emoji:'ðŸ”¥', color:'from-red-500 to-orange-600',      members:null },
  { id:'tcgpokeshield',  name:'TCG PokÃ©Shield',             short:'TCG PokÃ©Shield',          emoji:'ðŸ›¡ï¸', color:'from-blue-600 to-indigo-800',    members:null },
  { id:'boogcardshop',   name:'BOOGCARDSHOP ðŸŽ´',           short:'BOOGCARDSHOP',            emoji:'ðŸŽª', color:'from-pink-500 to-purple-600',     members:null },
  { id:'armandotcg2',    name:'ArmandoTCG 2',              short:'ArmandoTCG 2',            emoji:'âš”ï¸', color:'from-gray-700 to-gray-900',      members:null },
  { id:'descontocardgame',name:'Desconto Card game',        short:'Desconto Card Game',      emoji:'ðŸ’°', color:'from-green-600 to-emerald-700',   members:null },
  { id:'slarrpokfire',   name:'SLAR FOR POKEFIR AUC...',   short:'SLAR POKFIRE',            emoji:'ðŸŒ‹', color:'from-red-700 to-orange-800',      members:null },
  { id:'jjamestcg',      name:'# James TCG ðŸŽ´',            short:'James TCG',               emoji:'ðŸŽ­', color:'from-indigo-500 to-purple-700',   members:null },
  { id:'moretcg',        name:'moretCG ðŸŽ´ðŸŽ´ðŸŽ´ðŸŽ´ðŸŽ´ 15%...',  short:'moretCG',                emoji:'ðŸ’«', color:'from-teal-500 to-cyan-600',       members:null },
  { id:'hpretcg',        name:'+HPRE - GRUPO OFICIAL...',  short:'+HPRE TCG',               emoji:'ðŸ…', color:'from-gold-400 to-yellow-600',     members:null },
  { id:'freeletchtcg',   name:'FreeletchTCG ðŸŽ´ðŸŽ´...',      short:'FreeletchTCG',            emoji:'ðŸ¦…', color:'from-blue-800 to-indigo-900',     members:null },
  { id:'collectlubishop',name:'COLLECTLUBI SHOP PSA...',   short:'COLLECTLUBI SHOP',        emoji:'ðŸª', color:'from-emerald-500 to-green-700',   members:null },
  { id:'ritafire',       name:'RITA DE CHARIZARD DE ELKO', short:'RITA DE CHARIZARD',       emoji:'ðŸ”¥', color:'from-red-600 to-orange-700',      members:null },
  { id:'mkabpremium',    name:'M KAB PREMIUM CHAN...',     short:'M KAB PREMIUM',           emoji:'ðŸ’Ž', color:'from-purple-600 to-indigo-800',   members:null },
  { id:'ymgtcg',         name:'YMG TCG ðŸŽ´',               short:'YMG TCG',                  emoji:'ðŸŒŠ', color:'from-blue-400 to-teal-600',       members:null },
  { id:'meoxboxpremium', name:'MEO XBOX PREMIUM CHAN...',  short:'MEO XBOX PREMIUM',        emoji:'ðŸŽ®', color:'from-green-700 to-emerald-900',   members:null },
  { id:'meadowtcg',      name:'Meadow TCG',                short:'Meadow TCG',               emoji:'ðŸŒ¿', color:'from-green-500 to-lime-600',      members:null },
  { id:'silvertcg',      name:'Silver TCG ðŸŽ´',             short:'Silver TCG',               emoji:'ðŸ¥ˆ', color:'from-gray-400 to-slate-600',      members:null },
  { id:'tabernamento',   name:'TABERNA NERD - TIN...',     short:'TABERNA NERD',            emoji:'ðŸº', color:'from-amber-600 to-yellow-800',    members:null },
  { id:'leilaorecovery', name:'LEILÃƒO RECOVERY ðŸ’Ž 100...',  short:'LEILÃƒO RECOVERY',        emoji:'ðŸ’Ž', color:'from-cyan-600 to-blue-800',       members:null },
  { id:'leilaomineral',  name:'LEILÃƒO DE MINERAL (PORTU...', short:'LEILÃƒO MINERAL',        emoji:'ðŸ’Ž', color:'from-purple-700 to-indigo-900',   members:null },
  { id:'collectfosso',   name:'COLLECTIVOS (PORTUGA...)',   short:'COLLECTIVOS PT',          emoji:'ðŸ‡µðŸ‡¹', color:'from-green-600 to-red-600',      members:null },
  { id:'communiquedesc', name:'COMMUNIQUE - DESCONT...',   short:'COMMUNIQUE',              emoji:'ðŸ“¢', color:'from-blue-500 to-sky-600',        members:null },
  { id:'yttstore',       name:'YTT STORE TCG ðŸŽ´',          short:'YTT STORE',               emoji:'ðŸ¬', color:'from-violet-500 to-purple-700',   members:null },
  { id:'maranatcg',      name:'MaranaTCG TCG',             short:'MaranaTCG',               emoji:'âœï¸', color:'from-blue-700 to-indigo-900',    members:null },
  { id:'andreatcgplus',  name:'Andreatcg+ Representante...', short:'Andreatcg+',             emoji:'ðŸ‘©â€ðŸ’¼', color:'from-pink-500 to-rose-600',   members:null },
  { id:'reidobrasil',    name:'REI DO BRASIL PROMO...',    short:'REI DO BRASIL',           emoji:'ðŸ‘‘', color:'from-yellow-500 to-green-600',    members:null },
  { id:'yyt111store',    name:'YYT 111 STORE TCG ðŸŽ´',      short:'YYT 111 STORE',           emoji:'ðŸ’¯', color:'from-orange-500 to-red-600',      members:null },
  { id:'pokemonoferta',  name:'POKEMON OFERTAS SHOPE...',  short:'POKEMON OFERTAS',         emoji:'ðŸ›ï¸', color:'from-yellow-400 to-orange-500',  members:null },
  { id:'francisotcg',    name:'Franciscon Pokemon',        short:'Franciscon',               emoji:'ðŸŽ²', color:'from-teal-400 to-cyan-600',       members:null },
  { id:'youngtcg',       name:'YOUNG TCG ðŸŽ´ðŸŽ´',            short:'YOUNG TCG',               emoji:'ðŸŒ±', color:'from-lime-500 to-green-600',      members:null },
  { id:'leilaonerd',     name:'LEILÃƒO NO BREAK (TURMA...', short:'LEILÃƒO NO BREAK',         emoji:'âš¡', color:'from-yellow-600 to-orange-700',   members:null },
  { id:'leilaobrasil',   name:'LEILÃƒO EM BREAK (TURMA...', short:'LEILÃƒO EM BREAK',         emoji:'ðŸŽª', color:'from-purple-500 to-pink-600',     members:null },
  { id:'zapzaptcg',      name:'ZapZapCards',               short:'ZapZap Cards',             emoji:'âš¡', color:'from-yellow-400 to-amber-500',    members:null },
  { id:'plantasatopiche', name:'Plantas atopiche OE',      short:'Plantas atopiche',         emoji:'ðŸŒº', color:'from-green-400 to-emerald-600',   members:null },
  { id:'maranatcg2',     name:'MaranaTCG TCG CÃ³pia',       short:'MaranaTCG 2',              emoji:'âœï¸', color:'from-indigo-700 to-blue-900',    members:null },
  { id:'pokemonshopbr',  name:'POKEMON SHOP BR - LeilÃ£o...', short:'POKEMON SHOP BR',       emoji:'ðŸ‡§ðŸ‡·', color:'from-green-500 to-yellow-400',  members:null },
];

const App = () => {
  const [user, setUser] = React.useState(null);
  const [userProfile, setUserProfile] = React.useState(null);
    const [loading, setLoading] = React.useState(true);
    
    // Verificar se jÃ¡ estÃ¡ logado ao carregar
    React.useEffect(() => {
      const checkUser = async () => {
        console.log('ðŸ” Verificando sessÃ£o...');
        const { data } = await sbAuth.getUser();
        if (data?.user) {
          console.log('âœ… UsuÃ¡rio logado:', data.user.email);
          setUser(data.user);
          
          // Carregar perfil usando RPC (contorna erro 406)
          try {
            console.log('ðŸ“¡ Chamando get_my_profile...');
            const { data: profileJson, error } = await supabase.rpc('get_my_profile');
            console.log('ðŸ“¡ RPC retornou:', { data: profileJson, error });
            
            if (error) {
              console.error('âŒ Erro RPC:', error);
            } else if (profileJson) {
              console.log('âœ… Perfil carregado via RPC:', profileJson);
              setUserProfile(profileJson);
            } else {
              console.warn('âš ï¸ RPC retornou null - tentando SELECT direto...');
              // Fallback: tentar SELECT direto
              const { data: profile2 } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', data.user.id)
                .single();
              
              console.log('Fallback profile:', profile2);
              if (profile2) {
                setUserProfile(profile2);
              }
            }
          } catch (err) {
            console.error('âŒ Exception ao carregar perfil:', err);
          }
        } else {
          console.log('âš ï¸ Nenhum usuÃ¡rio logado');
        }
        setLoading(false);
      };
      checkUser();
    }, []);
    
    const [screen,      setScreen]      = useState('login');
  const [events,      setEvents]      = useState([]); // Mudado de EVENTS para events (useState)
  const [checkins,    setCheckins]    = useState([]);
  const [modalEvent,  setModalEvent]  = useState(null);
  const [searchLog,   setSearchLog]   = useState([]);
  const [wantedList,  setWantedList]  = useState([]);
  const [alerts,      setAlerts]      = useState([]);
  const [showTutorial, setShowTutorial] = useState(false);
  const [tutorialStep, setTutorialStep] = useState(0);
  
  // CRITICAL: Para compatibilidade com cÃ³digo existente que usa EVENTS
  const EVENTS = events;
  
  // Carregar leilÃµes do Supabase
  const loadAuctionsFromDB = async () => {
    if (!supabase) {
      console.warn('âš ï¸ Supabase ainda nÃ£o inicializado, aguardando...');
      return;
    }
    
    try {
      console.log('ðŸ”„ Carregando leilÃµes do Supabase...');
      const { data, error } = await supabase
        .from('auctions')
        .select('*')
        .order('date', { ascending: true });
      
      if (error) {
        console.error('âŒ Erro ao carregar leilÃµes:', error);
        return;
      }
      
      if (data && data.length > 0) {
        setEvents(data);
        console.log(`âœ… ${data.length} leilÃµes carregados`);
      } else {
        console.log('â„¹ï¸ Nenhum leilÃ£o encontrado');
      }
    } catch (err) {
      console.error('âŒ Erro ao carregar leilÃµes:', err);
    }
  };
  
  // Carregar check-ins do Supabase
  const loadCheckinsFromDB = async () => {
    if (!supabase || !user) {
      console.warn('âš ï¸ Supabase ou usuÃ¡rio nÃ£o disponÃ­vel');
      return;
    }
    try {
      console.log('ðŸ”„ Carregando check-ins do Supabase...');
      const { data, error } = await supabase
        .from('user_checkins')
        .select('event_id')
        .eq('user_id', user.id);
      
      if (error) {
        console.error('âŒ Erro ao carregar check-ins:', error);
        return;
      }
      
      if (data && data.length > 0) {
        const eventIds = data.map(row => row.event_id);
        setCheckins(eventIds);
        console.log(`âœ… ${eventIds.length} check-ins carregados`);
      }
    } catch (err) {
      console.error('âŒ Erro ao carregar check-ins:', err);
    }
  };
  
  // Verificar se deve mostrar tutorial (primeira vez)
  React.useEffect(() => {
    if (user && !loading) {
      const hasSeenTutorial = localStorage.getItem(`tutorial_seen_${user.id}`);
      if (!hasSeenTutorial) {
        // Esperar 1 segundo para o usuÃ¡rio se acostumar com a tela
        setTimeout(() => setShowTutorial(true), 1000);
      }
    }
  }, [user, loading]);
  
  // Carregar Wanted List do Supabase quando o usuÃ¡rio logar
  React.useEffect(() => {
    if (user && userProfile) {
      loadWantedListFromDB();
      loadCheckinsFromDB();
    }
  }, [user, userProfile]);
  
  // Carregar leilÃµes do Supabase (pÃºblico - todos veem)
  React.useEffect(() => {
    // Aguardar Supabase estar pronto
    const tryLoadAuctions = () => {
      if (supabase) {
        loadAuctionsFromDB();
      } else {
        console.log('â³ Aguardando Supabase inicializar...');
        setTimeout(tryLoadAuctions, 200);
      }
    };
    tryLoadAuctions();
  }, []);
  
  const loadWantedListFromDB = async () => {
    if (!supabase || !user) {
      console.warn('âš ï¸ Supabase ou usuÃ¡rio nÃ£o disponÃ­vel');
      return;
    }
    
    try {
      console.log('ðŸ”„ Carregando Wanted List do Supabase...');
      const { data, error } = await supabase
        .from('user_wanted_cards')
        .select('*')
        .eq('user_id', user.id);
      
      if (error) {
        console.error('âŒ Erro ao carregar wanted list:', error);
        return;
      }
      
      if (data && data.length > 0) {
        const cards = data.map(row => ({
          ...row.card_data,
          addedAt: new Date(row.created_at)
        }));
        setWantedList(cards);
        console.log(`âœ… ${cards.length} cartas carregadas da Wanted List`);
      } else {
        console.log('â„¹ï¸ Nenhuma carta na Wanted List');
      }
    } catch (err) {
      console.error('âŒ Erro ao carregar wanted list:', err);
    }
  };
  
  const closeTutorial = (dontShowAgain) => {
    if (dontShowAgain && user) {
      localStorage.setItem(`tutorial_seen_${user.id}`, 'true');
    }
    setShowTutorial(false);
    setTutorialStep(0);
  };
  
  // interests: { eventId_cardIdx: true } â€” cartas marcadas para ser avisado no leilÃ£o
  const [interests,   setInterests]   = useState({});
  const toggleInterest = (eventId, cardIdx) => {
    const key = eventId + '_' + cardIdx;
    setInterests(prev => ({ ...prev, [key]: !prev[key] }));
  };
  const isInterested = (eventId, cardIdx) => !!interests[eventId + '_' + cardIdx];
  
  // Determinar se Ã© leiloeiro baseado no perfil real
  const isAuctioneer = userProfile?.tipo === 'leiloeiro';
  const isApproved = userProfile?.approved !== false; // true ou null = aprovado
  
  const [liveAuction, setLiveAuction] = useState(null);   // leilÃ£o ao vivo em andamento

  /* â”€â”€â”€ Verifica alertas toda vez que wantedList ou EVENTS mudam â”€â”€â”€ */
  useEffect(() => {
    const newAlerts = [];
    wantedList.forEach(wc => {
      EVENTS.forEach(ev => {
        ev.cards.forEach(ec => {
          if (matchWanted(wc, ec)) {
            const key = `${wc.id}-${ev.id}`;
            const already = alerts.find(a => a.key === key);
            if (!already) newAlerts.push({ key, cardName:wc.name, cardImg:wc.img, eventTitle:ev.title, eventId:ev.id, eventDate:ev.date, eventTime:ev.time, seen:false });
          }
        });
      });
    });
    if (newAlerts.length) setAlerts(prev => [...prev, ...newAlerts]);
  }, [wantedList]);

  const unseenAlerts = alerts.filter(a => !a.seen).length;
  const toggleCheckin = async (id) => {
    const isCheckedIn = checkins.includes(id);
    
    // Atualizar localmente primeiro (UI instantÃ¢nea)
    setCheckins(p => isCheckedIn ? p.filter(x => x !== id) : [...p, id]);
    
    // Salvar no Supabase se o usuÃ¡rio estiver logado
    if (user) {
      try {
        if (isCheckedIn) {
          // Remover check-in
          console.log(`ðŸ—‘ï¸ Removendo check-in do leilÃ£o ${id}...`);
          const { error } = await supabase
            .from('user_checkins')
            .delete()
            .eq('user_id', user.id)
            .eq('event_id', id);
          
          if (error) {
            console.error('âŒ Erro ao remover check-in:', error);
          } else {
            console.log('âœ… Check-in removido');
          }
        } else {
          // Adicionar check-in
          console.log(`âœ… Adicionando check-in no leilÃ£o ${id}...`);
          const { error } = await supabase
            .from('user_checkins')
            .insert({
              user_id: user.id,
              event_id: id
            });
          
          if (error) {
            console.error('âŒ Erro ao adicionar check-in:', error);
          } else {
            console.log('âœ… Check-in salvo');
          }
        }
      } catch (err) {
        console.error('âŒ Erro ao salvar check-in:', err);
      }
    }
  };
  
  const addToWanted = async (card) => {
    // Garantir que a carta tem um ID Ãºnico
    const cardId = card.id || `${card.name}-${card.set || 'unknown'}-${card.number || card.localId || 'no-num'}`.replace(/\s+/g, '-').toLowerCase();
    
    // Verificar se jÃ¡ existe (usando o ID gerado ou original)
    if (wantedList.find(w => w.id === cardId || (w.id && w.id === card.id))) {
      console.log(`âš ï¸ ${card.name} jÃ¡ estÃ¡ na Wanted List`);
      return;
    }
    
    // Criar objeto completo da carta com ID garantido
    const cardWithId = {
      ...card,
      id: cardId,
      addedAt: new Date()
    };
    
    // Adicionar localmente primeiro
    setWantedList(p => [...p, cardWithId]);
    
    // Salvar no Supabase se o usuÃ¡rio estiver logado
    if (user) {
      try {
        console.log(`ðŸ’¾ Salvando ${card.name} na Wanted List...`);
        const { error } = await supabase
          .from('user_wanted_cards')
          .insert({
            user_id: user.id,
            card_id: cardId,
            card_name: card.name,
            card_data: cardWithId
          });
        
        if (error) {
          console.error('âŒ Erro ao salvar carta na wanted list:', error);
        } else {
          console.log(`âœ… ${card.name} salvo no Supabase`);
        }
      } catch (err) {
        console.error('âŒ Erro ao salvar no Supabase:', err);
      }
    }
  };
  
  const removeWanted = async (id) => {
    // Remover localmente primeiro
    setWantedList(p => p.filter(w => w.id !== id));
    
    // Remover do Supabase se o usuÃ¡rio estiver logado
    if (user) {
      try {
        console.log(`ðŸ—‘ï¸ Removendo carta da Wanted List...`);
        const { error } = await supabase
          .from('user_wanted_cards')
          .delete()
          .eq('user_id', user.id)
          .eq('card_id', id);
        
        if (error) {
          console.error('âŒ Erro ao remover carta da wanted list:', error);
        } else {
          console.log('âœ… Carta removida do Supabase');
        }
      } catch (err) {
        console.error('âŒ Erro ao remover do Supabase:', err);
      }
    }
  };
  
  const markAlertSeen = key => setAlerts(p => p.map(a => a.key === key ? { ...a, seen: true } : a));
  const logSearch = query => {
    if (!query.trim()) return;
    setSearchLog(prev => {
      const existing = prev.find(x=>x.query.toLowerCase()===query.toLowerCase());
      const updated  = existing
        ? prev.map(x=>x.query.toLowerCase()===query.toLowerCase()?{...x,count:x.count+1,last:new Date()}:x)
        : [...prev,{query:query.trim(),count:1,last:new Date()}];
      const sorted = [...updated].sort((a,b)=>b.count-a.count);
      console.group('%cðŸ“Š PokEventos â€” Backlog de Buscas','color:#8B5CF6;font-weight:bold;font-size:14px');
      console.table(sorted.map((s,i)=>({'#':i+1,'Carta':s.query,'Buscas':s.count,'Ãšltima':new Date(s.last).toLocaleString('pt-BR')})));
      console.groupEnd();
      return updated;
    });
  };

  /* â”€â”€â”€ MODAL DETALHES â”€â”€â”€ */
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL CARTA â€” popup ao clicar em resultado
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */


  const BottomNav = ({ current }) => (
    <div className="fixed bottom-0 left-0 right-0 bg-white border-t-4 border-yellow-400 px-2 py-3 shadow-2xl z-40">
      <div className="flex justify-around items-center">
        {[
          { id:'home',     icon:'ðŸŽ´', label:'LeilÃµes'    },
          { id:'calendar', icon:'ðŸ“…', label:'CalendÃ¡rio'  },
          { id:'search',   icon:'ðŸ”', label:'Buscar'      },
          { id:'profile',  icon:'ðŸ‘¤', label:'Perfil'      },
        ].map(tab=>(
          <button key={tab.id} onClick={()=>setScreen(tab.id)}
            className={`flex flex-col items-center gap-0.5 relative ${current===tab.id?'text-red-600':'text-gray-400'}`}>
            <span className="text-2xl">{tab.icon}</span>
            <span className="text-[10px] font-semibold">{tab.label}</span>
            {tab.id==='wanted' && unseenAlerts>0 && (
              <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] rounded-full w-4 h-4 flex items-center justify-center font-bold border border-white pulse-dot">{unseenAlerts}</span>
            )}
            {tab.id==='home' && checkins.length>0 && (
              <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] rounded-full w-4 h-4 flex items-center justify-center font-bold border border-white">{checkins.length}</span>
            )}
          </button>
        ))}
      </div>
    </div>
  );

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TUTORIAL MODAL - Primeira vez
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const TutorialModal = () => {
    const [dontShowAgain, setDontShowAgain] = React.useState(false);
    
    const slides = [
      {
        emoji: 'ðŸŽ´',
        title: 'Bem-vindo ao PokÃ©Eventos!',
        description: 'Seu app para acompanhar todos os leilÃµes de PokÃ©mon TCG em um sÃ³ lugar!',
        color: 'from-red-500 to-yellow-400'
      },
      {
        emoji: 'ðŸ“…',
        title: 'CalendÃ¡rio de LeilÃµes',
        description: 'Veja todos os leilÃµes organizados por data. Clique em qualquer evento para ver as cartas, fazer check-in e acessar o link do WhatsApp!',
        color: 'from-blue-500 to-purple-500'
      },
      {
        emoji: 'â­',
        title: 'Wanted List',
        description: 'Adicione suas cartas desejadas na Wanted List e receba alertas automÃ¡ticos quando elas aparecerem em leilÃµes!',
        color: 'from-yellow-400 to-orange-500'
      },
      {
        emoji: 'ðŸ”',
        title: 'Busca Inteligente',
        description: 'Busque cartas por nome, nÃºmero ou ediÃ§Ã£o. Encontrou em um leilÃ£o? Check-in! NÃ£o encontrou? Adicione Ã  Wanted List!',
        color: 'from-green-500 to-teal-500'
      },
      {
        emoji: 'ðŸš€',
        title: 'Pronto para comeÃ§ar!',
        description: 'Explore o calendÃ¡rio, monte sua Wanted List e nunca mais perca um leilÃ£o!',
        color: 'from-pink-500 to-red-500'
      }
    ];

    const currentSlide = slides[tutorialStep];
    const isLastSlide = tutorialStep === slides.length - 1;

    return (
      <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in">
          {/* Header com gradiente */}
          <div className={`bg-gradient-to-r ${currentSlide.color} p-8 text-center relative`}>
            <div className="text-7xl mb-4 animate-bounce">{currentSlide.emoji}</div>
            <h2 className="text-2xl font-black text-white mb-2" style={{fontFamily:'Arial Black,sans-serif'}}>
              {currentSlide.title}
            </h2>
            <p className="text-white/90 text-sm leading-relaxed">
              {currentSlide.description}
            </p>
          </div>

          {/* Indicadores de slides */}
          <div className="flex justify-center gap-2 py-4 bg-gray-50">
            {slides.map((_, idx) => (
              <button
                key={idx}
                onClick={() => setTutorialStep(idx)}
                className={`h-2 rounded-full transition-all ${
                  idx === tutorialStep 
                    ? 'w-8 bg-blue-500' 
                    : 'w-2 bg-gray-300 hover:bg-gray-400'
                }`}
              />
            ))}
          </div>

          {/* Checkbox "NÃ£o mostrar novamente" */}
          <div className="px-6 py-3 bg-gray-50 border-t">
            <label className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={dontShowAgain}
                onChange={(e) => setDontShowAgain(e.target.checked)}
                className="w-4 h-4 accent-blue-500"
              />
              <span className="text-sm text-gray-600">NÃ£o mostrar novamente</span>
            </label>
          </div>

          {/* BotÃµes de navegaÃ§Ã£o */}
          <div className="p-6 pt-3 flex gap-3">
            {tutorialStep > 0 && (
              <button
                onClick={() => setTutorialStep(tutorialStep - 1)}
                className="flex-1 py-3 px-4 bg-gray-200 text-gray-700 rounded-xl font-bold hover:bg-gray-300 transition-all"
              >
                â† Voltar
              </button>
            )}
            <button
              onClick={() => {
                if (isLastSlide) {
                  closeTutorial(dontShowAgain);
                } else {
                  setTutorialStep(tutorialStep + 1);
                }
              }}
              className={`flex-1 py-3 px-4 rounded-xl font-bold text-white transition-all bg-gradient-to-r ${currentSlide.color} hover:opacity-90`}
            >
              {isLastSlide ? 'ðŸŽ‰ ComeÃ§ar!' : 'PrÃ³ximo â†’'}
            </button>
          </div>

          {/* BotÃ£o pular */}
          {!isLastSlide && (
            <button
              onClick={() => closeTutorial(dontShowAgain)}
              className="w-full py-3 text-sm text-gray-500 hover:text-gray-700 font-semibold"
            >
              Pular tutorial
            </button>
          )}
        </div>
      </div>
    );
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TELA LOGIN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const LoginScreen = () => {
    const [email, setEmail] = React.useState('');
    const [password, setPassword] = React.useState('');
    const [loading, setLoading] = React.useState(false);
    const [error, setError] = React.useState('');

    const handleLogin = async () => {
      if (!email || !password) {
        setError('Preencha email e senha');
        return;
      }
      
      setLoading(true);
      setError('');
      
      const { data, error: loginError } = await sbAuth.signIn(email, password);
      
      if (loginError) {
        setError(loginError.message || 'Erro ao fazer login');
        setLoading(false);
      } else if (data?.user) {
        console.log('âœ… Login bem-sucedido!', data.user);
        setUser(data.user);
        
        // Carregar perfil via RPC
        try {
          const { data: profileJson, error: rpcError } = await supabase.rpc('get_my_profile');
          if (!rpcError && profileJson) {
            console.log('âœ… Perfil carregado via RPC:', profileJson);
            setUserProfile(profileJson);
          }
        } catch (err) {
          console.error('âŒ Erro ao carregar perfil:', err);
        }
        
        setScreen('home');
      }
    };

    return (
    <div className="min-h-screen bg-gradient-to-br from-red-500 via-yellow-400 to-blue-500 flex items-center justify-center p-4 relative overflow-hidden">
      <img src={POKE.pikachu}   className="absolute top-8 left-6 w-20 opacity-20 animate-bounce" style={{animationDuration:'3s'}} />
      <img src={POKE.charizard} className="absolute bottom-16 right-6 w-28 opacity-15 animate-bounce" style={{animationDuration:'4s'}} />
      <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm relative z-10">
        <div className="text-center mb-6">
          <div className="relative inline-block mb-3">
            <div className="absolute inset-0 bg-yellow-300 rounded-full blur-xl opacity-60"></div>
            <img src={POKE.pikachu} className="w-20 h-20 relative z-10" />
          </div>
          <h1 className="text-4xl font-black bg-gradient-to-r from-blue-600 to-red-600 bg-clip-text text-transparent" style={{fontFamily:'Arial Black,sans-serif'}}>PokEventos</h1>
          <p className="text-gray-500 text-sm mt-1 font-medium">Todos os leilÃµes em um sÃ³ lugar</p>
          <div className="flex justify-center items-end gap-3 mt-5">
            {[
              { src:TCG.venusaur,      label:'Venusaur',   border:'border-green-400', size:'w-16', shift:'' },
              { src:TCG.charizardBase, label:'Charizard',  border:'border-red-400',   size:'w-16', shift:'-translate-y-2' },
              { src:TCG.blastoise,     label:'Blastoise',  border:'border-blue-400',  size:'w-16', shift:'' },
            ].map((c,i)=>(
              <div key={i} className="flex flex-col items-center gap-1">
                <img src={c.src} alt={c.label} className={`${c.size} ${c.shift} rounded-lg shadow-xl border-2 ${c.border} card-img`} />
                <span className="text-[9px] text-gray-500 font-semibold">{c.label}</span>
              </div>
            ))}
          </div>
        </div>
        
        {error && (
          <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-xl text-red-600 text-sm">
            âš ï¸ {error}
          </div>
        )}
        
        <div className="space-y-3">
          <input 
            type="email" 
            placeholder="E-mail" 
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            onKeyDown={e => e.key === 'Enter' && handleLogin()} 
            disabled={loading}
            className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-yellow-400 outline-none text-sm disabled:bg-gray-50" 
          />
          <input 
            type="password" 
            placeholder="Senha" 
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            onKeyDown={e => e.key === 'Enter' && handleLogin()} 
            autoComplete="current-password" 
            disabled={loading}
            className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-yellow-400 outline-none text-sm disabled:bg-gray-50" 
          />
          <button 
            onClick={handleLogin} 
            disabled={loading}
            className="w-full bg-gradient-to-r from-red-500 to-red-600 text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 hover:from-red-600 hover:to-red-700 disabled:opacity-50 disabled:cursor-not-allowed">
            {loading ? 'â³ Entrando...' : 'âš¡ Entrar'}
          </button>
          <p className="text-center text-sm"><button onClick={()=>setScreen('register')} className="text-red-600 hover:underline font-semibold">Criar nova conta</button></p>
        </div>
      </div>
    </div>
    );
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TELA CADASTRO
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const RegisterScreen = () => {
    const [accountType, setAccountType] = React.useState('collector');
    const [formData, setFormData] = React.useState({
      displayName: '',
      email: '',
      whatsapp: '',
      password: '',
      confirmPassword: ''
    });
    const [loading, setLoading] = React.useState(false);
    const [error, setError] = React.useState('');
    const [termsAccepted, setTermsAccepted] = React.useState(false);
    
    const isAuc = accountType === 'auctioneer';

    const handleRegister = async () => {
      setError('');
      
      // ValidaÃ§Ãµes
      if (!formData.displayName || !formData.email || !formData.password) {
        setError('Preencha todos os campos obrigatÃ³rios');
        return;
      }
      
      if (isAuc && !formData.whatsapp) {
        setError('WhatsApp Ã© obrigatÃ³rio para leiloeiros');
        return;
      }
      
      if (formData.password !== formData.confirmPassword) {
        setError('As senhas nÃ£o coincidem');
        return;
      }
      
      if (formData.password.length < 6) {
        setError('A senha deve ter pelo menos 6 caracteres');
        return;
      }
      
      if (!termsAccepted) {
        setError('Aceite os termos para continuar');
        return;
      }
      
      setLoading(true);
      
      // 1. Criar usuÃ¡rio no Supabase Auth
      const { data, error: signUpError } = await sbAuth.signUp(
        formData.email, 
        formData.password, 
        formData.displayName
      );
      
      if (signUpError) {
        setError(signUpError.message || 'Erro ao criar conta');
        setLoading(false);
        return;
      }
      
      if (data?.user) {
        console.log('âœ… UsuÃ¡rio criado no Auth!', data.user);
        
        // Aguardar um momento para garantir que auth.users foi populado
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // 2. Criar perfil usando funÃ§Ã£o SQL (SECURITY DEFINER)
        try {
          const { data: result, error: rpcError } = await supabase.rpc('create_user_profile', {
            user_id: data.user.id,
            user_email: formData.email,
            user_name: formData.displayName,
            user_tipo: isAuc ? 'leiloeiro' : 'participante',
            user_whatsapp: formData.whatsapp || null
          });
          
          if (rpcError) {
            console.error('âŒ Erro ao criar perfil:', rpcError);
            setError('Conta criada, mas erro ao salvar perfil. Entre em contato com suporte.');
            setLoading(false);
            return;
          }
          
          console.log('âœ… Perfil criado!', result);
          
          if (isAuc) {
            alert('âœ… Conta de leiloeiro criada! Aguarde aprovaÃ§Ã£o da equipe PokÃ©Eventos.');
          }
          
          setUser(data.user);
          setScreen('home');
        } catch (err) {
          console.error('âŒ Exception ao criar perfil:', err);
          setError('Erro inesperado ao criar perfil. Tente novamente.');
          setLoading(false);
        }
      }
    };

    return (
    <div className="min-h-screen bg-gradient-to-br from-blue-500 via-purple-500 to-yellow-400 flex items-center justify-center p-4 relative overflow-hidden">
        {/* BANNER DE TESTE */}
        <div className="fixed top-0 left-0 right-0 bg-yellow-400 text-black text-center py-1 text-xs font-bold z-50" style={{zIndex: 9999}}>
          âš ï¸ VERSÃƒO DE TESTE - test branch
        </div>
        
      <img src={POKE.mewtwo}  className="absolute top-8 right-4 w-20 opacity-10 animate-bounce" style={{animationDuration:'3.5s'}} />
      <img src={POKE.eevee}   className="absolute bottom-12 left-4 w-16 opacity-10 animate-bounce" style={{animationDuration:'4.5s'}} />
      <div className="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm relative z-10 overflow-y-auto max-h-[96vh]">

        {/* Header â€” Jolteon */}
        <div className="text-center mb-5">
          <button onClick={()=>setScreen('login')} className="absolute top-4 left-4 text-gray-400 hover:text-gray-600 text-lg">â†</button>
          <div className="relative inline-block mb-2">
            <div className="absolute inset-0 bg-yellow-300 rounded-full blur-xl opacity-70"></div>
            <img src={POKE.jolteon} className="w-16 h-16 relative z-10 drop-shadow-lg" />
          </div>
          <h1 className="text-2xl font-black bg-gradient-to-r from-blue-600 to-yellow-500 bg-clip-text text-transparent" style={{fontFamily:'Arial Black,sans-serif'}}>Criar Conta</h1>
          <p className="text-gray-400 text-xs mt-0.5">Junte-se Ã  comunidade PokEventos</p>
        </div>

        {error && (
          <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-xl text-red-600 text-sm">
            âš ï¸ {error}
          </div>
        )}

        {/* Tipo de conta â€” com estado */}
        <div className="grid grid-cols-2 gap-2 mb-4">
          <button onClick={()=>setAccountType('collector')} disabled={loading}
            className={`flex flex-col items-center gap-1 p-3 rounded-2xl border-2 font-bold text-sm transition-all ${accountType==='collector'?'border-blue-500 bg-blue-50 text-blue-700 shadow-md':'border-gray-200 bg-gray-50 text-gray-400'}`}>
            <span className="text-2xl">ðŸ‘¤</span>
            <span>Colecionador</span>
            <span className={`text-[10px] font-normal ${accountType==='collector'?'text-blue-500':'text-gray-400'}`}>Acompanha leilÃµes</span>
          </button>
          <button onClick={()=>setAccountType('auctioneer')} disabled={loading}
            className={`flex flex-col items-center gap-1 p-3 rounded-2xl border-2 font-bold text-sm transition-all ${accountType==='auctioneer'?'border-yellow-500 bg-yellow-50 text-yellow-700 shadow-md':'border-gray-200 bg-gray-50 text-gray-400'}`}>
            <span className="text-2xl">ðŸ”¨</span>
            <span>Leiloeiro</span>
            <span className={`text-[10px] font-normal ${accountType==='auctioneer'?'text-yellow-600':'text-gray-400'}`}>Organiza leilÃµes</span>
          </button>
        </div>

        <div className="space-y-2.5">
          <input 
            type="text" 
            placeholder="Nome completo *" 
            value={formData.displayName}
            onChange={(e) => setFormData({...formData, displayName: e.target.value})}
            disabled={loading}
            className="w-full px-4 py-2.5 border-2 border-gray-200 rounded-xl focus:border-purple-400 outline-none text-sm disabled:bg-gray-50" 
          />
          <input 
            type="email" 
            placeholder="E-mail *" 
            value={formData.email}
            onChange={(e) => setFormData({...formData, email: e.target.value})}
            disabled={loading}
            className="w-full px-4 py-2.5 border-2 border-gray-200 rounded-xl focus:border-purple-400 outline-none text-sm disabled:bg-gray-50" 
          />

          {/* WhatsApp â€” obrigatÃ³rio para leiloeiro, opcional para colecionador */}
          <div>
            <input 
              type="tel" 
              placeholder={isAuc ? 'WhatsApp *' : 'WhatsApp (opcional)'}
              value={formData.whatsapp}
              onChange={(e) => setFormData({...formData, whatsapp: e.target.value})}
              disabled={loading}
              className={`w-full px-4 py-2.5 border-2 rounded-xl outline-none text-sm disabled:bg-gray-50 ${isAuc?'border-yellow-300 focus:border-yellow-500':'border-gray-200 focus:border-purple-400'}`} 
            />
            {!isAuc && (
              <p className="text-[10px] text-gray-400 mt-1 ml-1">
                âš¡ NecessÃ¡rio para participar de leilÃµes
              </p>
            )}
          </div>

          <input 
            type="password" 
            placeholder="Senha *" 
            value={formData.password}
            onChange={(e) => setFormData({...formData, password: e.target.value})}
            autoComplete="new-password" 
            disabled={loading}
            className="w-full px-4 py-2.5 border-2 border-gray-200 rounded-xl focus:border-purple-400 outline-none text-sm disabled:bg-gray-50" 
          />
          <input 
            type="password" 
            placeholder="Confirmar senha *" 
            value={formData.confirmPassword}
            onChange={(e) => setFormData({...formData, confirmPassword: e.target.value})}
            disabled={loading}
            className="w-full px-4 py-2.5 border-2 border-gray-200 rounded-xl focus:border-purple-400 outline-none text-sm disabled:bg-gray-50" 
          />

          <div className="flex items-start gap-2 pt-1">
            <input 
              type="checkbox" 
              id="terms2" 
              checked={termsAccepted}
              onChange={(e) => setTermsAccepted(e.target.checked)}
              disabled={loading}
              className="mt-0.5 w-4 h-4 accent-purple-500 flex-shrink-0" 
            />
            <label htmlFor="terms2" className="text-xs text-gray-500 leading-relaxed">
              Aceito os <button className="text-purple-600 font-semibold hover:underline">Termos de Uso</button> e a <button className="text-purple-600 font-semibold hover:underline">PolÃ­tica de Privacidade</button>
            </label>
          </div>

          <button 
            onClick={handleRegister}
            disabled={loading}
            className={`w-full text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 transition-all mt-1 disabled:opacity-50 disabled:cursor-not-allowed ${isAuc?'bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600':'bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700'}`}>
            <img src={POKE.jolteon} className="w-5 h-5 object-contain" />
            {loading ? 'â³ Criando conta...' : (isAuc ? 'Criar conta de Leiloeiro' : 'Criar minha conta')}
          </button>

          <p className="text-center text-sm">
            JÃ¡ tem conta? <button onClick={()=>setScreen('login')} className="text-purple-600 hover:underline font-semibold">Entrar</button>
          </p>
        </div>
      </div>
    </div>
    );
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TELA HOME
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const HomeScreen = () => {
    const myEvents = EVENTS.filter(e=>checkins.includes(e.id));
    return (
      <div className="min-h-screen bg-gray-50 pokeball-bg pb-24">
        <div className="bg-gradient-to-r from-red-500 via-red-600 to-red-700 text-white p-6 pb-8 relative overflow-hidden">
          <img src={POKE.charizard} className="absolute -right-8 -top-4 w-36 opacity-20" />
          <div className="flex justify-between items-center relative z-10">
            <div><h1 className="text-2xl font-black" style={{fontFamily:'Arial Black,sans-serif'}}>PokEventos</h1><p className="text-red-100 text-sm">âš¡ Meus LeilÃµes</p></div>
            <button onClick={()=>setScreen('profile')} className="p-2 bg-white/20 rounded-full text-xl">ðŸ‘¤</button>
          </div>
        </div>
        <div className="px-4 -mt-4 space-y-3">
          <div className="bg-white rounded-2xl shadow-lg p-4 border-l-4 border-yellow-400 flex items-center gap-3">
            <img src={POKE.pikachu} className="w-12 h-12" />
            <div><p className="font-bold text-gray-800">Meus Check-ins</p><p className="text-sm text-gray-500">{myEvents.length>0?`${myEvents.length} confirmado(s)`:'Nenhum ainda'}</p></div>
          </div>
          {myEvents.length===0 ? (
            <div className="bg-white rounded-2xl shadow-lg p-8 text-center">
              <img src={POKE.snorlax} className="w-28 mx-auto mb-3 opacity-40" />
              <p className="font-bold text-gray-700 mb-1">Nenhum check-in ainda</p>
              <p className="text-sm text-gray-500 mb-4">Explore o calendÃ¡rio e confirme presenÃ§a!</p>
              <button onClick={()=>setScreen('calendar')} className="bg-blue-500 text-white px-6 py-2 rounded-xl font-bold text-sm">Ver CalendÃ¡rio</button>
            </div>
          ) : myEvents.map(event=>(
            <div key={event.id} onClick={()=>setModalEvent(event)} className="bg-white rounded-2xl shadow-md cursor-pointer border-2 border-green-200 hover:shadow-xl overflow-hidden">
              <div className="bg-green-500 px-4 py-2"><span className="text-white text-xs font-bold">âœ“ CHECK-IN CONFIRMADO</span></div>
              <div className="p-4">
                <p className="font-bold text-gray-800 mb-1">{event.title}</p>
                <p className="text-xs text-gray-500 mb-3">{event.organizer} Â· ðŸ• {event.time}</p>
                <div className="flex gap-2 overflow-x-auto pb-1">
                  {(event.cards || []).map((card,i)=><img key={i} src={card.img} alt={card.name} className="h-16 w-auto rounded-lg shadow-md border border-yellow-300 object-contain flex-shrink-0" onError={e=>e.target.style.display='none'} />)}
                </div>
              </div>
            </div>
          ))}
        </div>
        {modalEvent && <EventModal key={modalEvent.id} event={modalEvent} onClose={()=>setModalEvent(null)} wantedList={wantedList} matchWanted={matchWanted} AUCTION_GROUPS={AUCTION_GROUPS} checkins={checkins} toggleCheckin={toggleCheckin} addToWanted={addToWanted} removeWanted={removeWanted} />}
        <BottomNav current="home" />
      </div>
    );
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TELA CALENDÃRIO
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const CalendarScreen = () => {
    const [currentMonth, setCurrentMonth] = useState(new Date());
    const [selectedDate, setSelectedDate] = useState(null);
    const [showDayModal, setShowDayModal] = useState(false);
    const getDays = (month) => {
      const first = new Date(month.getFullYear(), month.getMonth(), 1);
      const last  = new Date(month.getFullYear(), month.getMonth() + 1, 0);
      const days  = [];
      for (let i = 0; i < first.getDay(); i++) days.push(null);
      for (let d = 1; d <= last.getDate(); d++) days.push(new Date(month.getFullYear(), month.getMonth(), d));
      return days;
    };
    const getEventsForDate = date => {
      if (!date) return [];
      return EVENTS.filter(e => e.date === date.toISOString().split('T')[0]);
    };
    const today = new Date(); today.setHours(0,0,0,0);
    const days  = getDays(currentMonth);

    // PrÃ³ximos leilÃµes (futuros + hoje), ordenados por data
    const todayStr    = today.toISOString().split('T')[0];
    const upcomingEvs = EVENTS
      .filter(e => e.date >= todayStr)
      .sort((a,b) => a.date.localeCompare(b.date) || a.time.localeCompare(b.time));

    const handleDayClick = date => {
      const ev = getEventsForDate(date);
      if (ev.length > 0) { setSelectedDate(date); setShowDayModal(true); }
    };

    return (
      <div className="min-h-screen bg-gray-50 pokeball-bg pb-24">

        {/* â”€â”€ Header â”€â”€ */}
        <div className="bg-gradient-to-r from-gray-900 to-gray-800 text-white p-5 pb-6 relative overflow-hidden">
          <img src={POKE.mewtwo} className="absolute -right-6 -top-2 w-32 opacity-10" />
          <p className="text-yellow-400 text-[10px] font-black tracking-widest uppercase mb-0.5">PokEventos</p>
          <h1 className="text-2xl font-black relative z-10" style={{fontFamily:'Arial Black,sans-serif'}}>CalendÃ¡rio</h1>
          <p className="text-gray-400 text-xs mt-0.5">Clique no dia ou no leilÃ£o para ver detalhes</p>
        </div>

        <div className="px-3 mt-6 space-y-4 pb-4">

          {/* â”€â”€ Lista de leilÃµes do mÃªs â”€â”€ */}
          <div>
            <div className="flex items-center justify-between mb-2 px-1">
              <p className="text-xs font-black text-gray-500 uppercase tracking-wider">
                ðŸ—“ {upcomingEvs.length} prÃ³ximo{upcomingEvs.length !== 1 ? 's leilÃµes' : ' leilÃ£o'}
              </p>
            </div>

            {upcomingEvs.length === 0 ? (
              <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-8 text-center">
                <p className="text-3xl mb-2">ðŸ“…</p>
                <p className="text-gray-500 font-semibold text-sm">Nenhum leilÃ£o este mÃªs</p>
              </div>
            ) : (
              <div className="space-y-3">
                {upcomingEvs.map(event => {
                  const hasWanted  = (event.cards || []).some(c => wantedList.some(w => matchWanted(w,c)));
                  const grupo      = AUCTION_GROUPS.find(g => g.id === event.groupId);
                  const evDate     = new Date(event.date + 'T00:00:00');
                  const isPast     = evDate < today;
                  const isChecked  = checkins.includes(event.id);

                  return (
                    <div key={event.id}
                      onClick={() => setModalEvent(event)}
                      className={`bg-white rounded-2xl shadow-md cursor-pointer overflow-hidden transition-all hover:shadow-xl active:scale-[0.99] border-l-4 ${
                        event.featured ? 'border-l-yellow-400' :
                        hasWanted      ? 'border-l-yellow-300' :
                        isChecked      ? 'border-l-green-400' :
                        isPast         ? 'border-l-gray-200'  :
                        'border-l-purple-400'
                      }`}>


                      {hasWanted && !event.featured && (
                        <div className="bg-yellow-50 border-b border-yellow-100 px-4 py-1 flex items-center gap-1.5">
                          <span className="text-yellow-700 text-[10px] font-bold">â­ Carta da sua Wanted List aqui!</span>
                        </div>
                      )}

                      <div className="p-4">
                        {/* Avatar + identidade do leiloeiro */}
                        <div className="flex items-center gap-3 mb-3">
                          {/* Avatar grande */}
                          <div className="flex-shrink-0">
                            {event.announcementPhoto ? (
                              <img src={event.announcementPhoto} alt={event.organizer}
                                className="w-14 h-14 rounded-2xl object-cover border-2 border-gray-100 shadow-sm" />
                            ) : grupo ? (
                              <div className={`w-14 h-14 rounded-2xl bg-gradient-to-br ${grupo.color} flex items-center justify-center text-3xl shadow-sm`}>
                                {grupo.emoji}
                              </div>
                            ) : (
                              <div className="w-14 h-14 rounded-2xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-3xl shadow-sm">
                                ðŸŽ´
                              </div>
                            )}
                          </div>

                          {/* Nome + info */}
                          <div className="flex-1 min-w-0">
                            {/* Data em destaque */}
                            <div className="flex items-baseline gap-2 mb-1.5">
                              <p className="text-xl font-black text-gray-900 leading-none tabular-nums">
                                {evDate.toLocaleDateString('pt-BR',{day:'2-digit',month:'short'})}
                              </p>
                              <p className="text-sm font-bold text-purple-600 leading-none">
                                {event.time}
                              </p>
                            </div>
                            <p className="font-bold text-gray-800 text-sm leading-tight truncate">{event.organizer || event.title}</p>
                            <p className="text-[11px] text-gray-400 truncate mt-0.5">{event.title}</p>
                            <div className="flex items-center gap-1.5 mt-1.5 flex-wrap">
                              {isChecked && (
                                <span className="bg-green-500 text-white px-2 py-0.5 rounded-full text-[10px] font-bold">âœ“ Check-in</span>
                              )}
                              {isPast && (
                                <span className="bg-gray-200 text-gray-500 px-2 py-0.5 rounded-full text-[10px] font-bold">Encerrado</span>
                              )}
                            </div>
                          </div>
                        </div>

                        {/* PrÃ©via das cartas â€” scroll horizontal */}
                        {(event.cards || []).length > 0 && (
                          <div className="flex gap-1.5 overflow-x-auto pb-1 -mx-1 px-1">
                            {(event.cards || []).slice(0, 8).map((card, i) => {
                              const isCardWanted = wantedList.some(w => matchWanted(w, card));
                              return (
                                <div key={i} className={`flex-shrink-0 relative rounded-lg overflow-hidden ${isCardWanted ? 'ring-2 ring-yellow-400' : ''}`}>
                                  <img src={card.img} alt={card.name}
                                    className="h-16 w-auto object-contain"
                                    onError={e => e.target.style.display='none'} />
                                  {isCardWanted && (
                                    <span className="absolute top-0 right-0 text-[8px]">â­</span>
                                  )}
                                </div>
                              );
                            })}
                            {(event.cards || []).length > 8 && (
                              <div className="flex-shrink-0 w-10 h-16 bg-gray-100 rounded-lg flex items-center justify-center">
                                <span className="text-[9px] text-gray-500 font-bold text-center leading-tight">+{(event.cards || []).length-8}<br/>mais</span>
                              </div>
                            )}
                          </div>
                        )}

                        {/* RodapÃ© â€” nÃºmero de cartas + CTA */}
                        <div className="flex items-center justify-between mt-2.5 pt-2.5 border-t border-gray-100">
                          <span className="text-[11px] text-gray-400 font-medium">
                            ðŸŽ´ {(event.cards || []).length} carta{(event.cards || []).length !== 1 ? 's' : ''}
                          </span>
                          <span className="text-[11px] text-purple-600 font-black flex items-center gap-1">
                            Ver leilÃ£o â€º
                          </span>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
          {/* â”€â”€ Mini calendÃ¡rio â”€â”€ */}
          <div className="bg-white rounded-2xl shadow-md border border-gray-100 p-4">
            <div className="flex justify-between items-center mb-3">
              <button onClick={()=>setCurrentMonth(new Date(currentMonth.getFullYear(),currentMonth.getMonth()-1))}
                className="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-lg text-gray-600 text-lg font-black">â€¹</button>
              <h2 className="text-sm font-black text-gray-800 capitalize">
                {currentMonth.toLocaleDateString('pt-BR',{month:'long',year:'numeric'})}
              </h2>
              <button onClick={()=>setCurrentMonth(new Date(currentMonth.getFullYear(),currentMonth.getMonth()+1))}
                className="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-lg text-gray-600 text-lg font-black">â€º</button>
            </div>
            <div className="grid grid-cols-7 gap-0.5 mb-1">
              {['D','S','T','Q','Q','S','S'].map((d,i) =>
                <div key={i} className="text-center text-[10px] font-bold text-gray-400 py-1">{d}</div>
              )}
            </div>
            <div className="grid grid-cols-7 gap-1">
              {days.map((date, idx) => {
                if (!date) return <div key={idx} className="aspect-square" />;
                const dayEv    = getEventsForDate(date);
                const isToday  = date.toDateString() === today.toDateString();
                const hasEv    = dayEv.length > 0;
                const hasWanted= hasEv && dayEv.some(ev => ev.cards.some(c => wantedList.some(w => matchWanted(w,c))));
                const isSelected = selectedDate && date.toDateString() === selectedDate.toDateString() && showDayModal;
                return (
                  <button key={idx} onClick={() => handleDayClick(date)}
                    className={`aspect-square rounded-lg flex flex-col items-center justify-center relative transition-all text-xs font-bold
                      ${isToday        ? 'bg-red-500 text-white shadow-md' :
                        isSelected     ? 'bg-gray-800 text-white ring-2 ring-yellow-400' :
                        hasWanted      ? 'bg-yellow-100 border-2 border-yellow-400 text-gray-800' :
                        hasEv          ? 'bg-yellow-50 border-2 border-yellow-300 text-gray-800 hover:bg-yellow-100' :
                        'text-gray-400 hover:bg-gray-100'}`}>
                    <span className="text-base font-black opacity-30 leading-none">{date.getDate()}</span>
                    {hasEv && (
                      <div className="flex gap-0.5 mt-0.5">
                        {dayEv.slice(0,3).map((_,i) =>
                          <span key={i} className={`w-1 h-1 rounded-full ${isToday?'bg-white':'bg-yellow-500'}`} />
                        )}
                      </div>
                    )}
                    {hasWanted && !isToday && <span className="absolute -top-0.5 -right-0.5 text-[8px]">â­</span>}
                  </button>
                );
              })}
            </div>
          </div>


        {/* â”€â”€ Modal dia (clique no calendÃ¡rio) â”€â”€ */}
        {showDayModal && selectedDate && (
          <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[9999] flex items-end md:items-center justify-center"
            onClick={e=>{ if(e.target===e.currentTarget) setShowDayModal(false); }}>
            <div className="bg-white w-full md:max-w-xl md:rounded-3xl rounded-t-3xl max-h-[80vh] overflow-y-auto shadow-2xl modal-enter"
              onClick={e=>e.stopPropagation()}>
              <div className="sticky top-0 bg-gradient-to-r from-gray-800 to-gray-900 text-white p-4 rounded-t-3xl flex justify-between items-center z-10">
                <div>
                  <p className="font-black text-base capitalize">
                    {selectedDate.toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long'})}
                  </p>
                  <p className="text-xs text-gray-300">{getEventsForDate(selectedDate).length} leilÃµes agendados</p>
                </div>
                <button onClick={()=>setShowDayModal(false)} className="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center text-lg">âœ•</button>
              </div>
              <div className="p-4 space-y-3">
                {getEventsForDate(selectedDate).map(event => {
                  const hasWanted = (event.cards || []).some(c => wantedList.some(w => matchWanted(w,c)));
                  const grupo     = AUCTION_GROUPS.find(g => g.id === event.groupId);
                  return (
                    <div key={event.id}
                      onClick={() => { setShowDayModal(false); setModalEvent(event); }}
                      className={`rounded-2xl border-2 cursor-pointer overflow-hidden transition-all hover:shadow-md active:scale-[0.99] ${hasWanted?'border-yellow-400 bg-yellow-50':'border-gray-200 bg-white hover:border-purple-400'}`}>
                      <div className="p-3 flex items-center gap-3">
                        {/* Avatar */}
                        {event.announcementPhoto ? (
                          <img src={event.announcementPhoto} alt={event.organizer}
                            className="w-12 h-12 rounded-xl object-cover border border-gray-100 flex-shrink-0" />
                        ) : grupo ? (
                          <div className={`w-12 h-12 rounded-xl bg-gradient-to-br ${grupo.color} flex items-center justify-center text-2xl flex-shrink-0`}>
                            {grupo.emoji}
                          </div>
                        ) : (
                          <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-2xl flex-shrink-0">ðŸŽ´</div>
                        )}
                        <div className="flex-1 min-w-0">
                          <p className="font-black text-gray-900 text-sm truncate">{event.organizer || event.title}</p>
                          <p className="text-[10px] text-gray-400 truncate">{event.title}</p>
                          <div className="flex items-center gap-1.5 mt-1">
                            <span className="bg-purple-100 text-purple-700 text-[10px] font-bold px-2 py-0.5 rounded-full">â° {event.time}</span>
                            {event.featured && <span className="bg-yellow-400 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">â­</span>}
                            {hasWanted && <span className="bg-yellow-100 text-yellow-700 text-[10px] font-bold px-2 py-0.5 rounded-full">Wanted!</span>}
                          </div>
                        </div>
                        <span className="text-gray-400 text-lg flex-shrink-0">â€º</span>
                      </div>
                      {/* Mini prÃ©via cartas */}
                      {(event.cards || []).length > 0 && (
                        <div className="flex gap-1 px-3 pb-3 overflow-x-auto">
                          {(event.cards || []).slice(0,6).map((c,i)=>
                            <img key={i} src={c.img} alt={c.name} className="h-12 w-auto object-contain rounded-md flex-shrink-0"
                              onError={e=>e.target.style.display='none'} />
                          )}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        )}

        {modalEvent && <EventModal key={modalEvent.id} event={modalEvent} onClose={()=>setModalEvent(null)} wantedList={wantedList} matchWanted={matchWanted} AUCTION_GROUPS={AUCTION_GROUPS} checkins={checkins} toggleCheckin={toggleCheckin} addToWanted={addToWanted} removeWanted={removeWanted} />}
      <BottomNav current="calendar" />
      </div>
    );
  };

  const SearchWantedScreen = () => {
    const [query,       setQuery]      = useState('');
    const [results,     setResults]    = useState([]);
    const [loading,     setLoading]    = useState(false);
    const [searched,    setSearched]   = useState('');
    const [apiError,    setApiError]   = useState('');
    const [modalCard,   setModalCard]  = useState(null);
    const [excluirComuns, setExcluirComuns] = useState(false);

    // FunÃ§Ãµes TCGdex compartilhadas: TCGDEX_API, normalizeTcgdex, detectarTipoBusca, fetchDetalhes, tcgdexBuscar (globais)

    const doSearch = async (override) => {
      const q = (override !== undefined ? override : query).trim();
      if (!q) return;
      setLoading(true);
      setApiError('');
      setResults([]);
      setSearched(q);
      try {
        const found = await tcgdexBuscar(q);
        setResults(found);
        if (found.length === 0) setApiError('Nenhuma carta encontrada para "' + q + '"');
      } catch (e) {
        setApiError('Erro na busca. Verifique sua conexÃ£o.');
      }
      setLoading(false);
    };

    // Debounce para busca em tempo real (600ms apÃ³s parar de digitar)
    const debounceRef = React.useRef(null);
    const handleChange = (val) => {
      setQuery(val);
      if (!val.trim()) {
        setResults([]); setSearched(''); setApiError('');
        if (debounceRef.current) clearTimeout(debounceRef.current);
        return;
      }
      if (debounceRef.current) clearTimeout(debounceRef.current);
      debounceRef.current = setTimeout(() => { doSearch(val); }, 600);
    };

    const wantedWithMatches = wantedList.map(wc => ({
      ...wc,
      matches: EVENTS.filter(ev => (ev.cards||[]).some(c => matchWanted(wc, c)))
    }));

    const TAGS = ['Charizard','Pikachu','Umbreon','Mewtwo','Lugia','Rayquaza','Mew','Arceus','Gengar','Eevee'];

    return (
      <div className="min-h-screen bg-gray-50 pokeball-bg pb-24">

        {/* Header */}
        <div className="bg-gray-900 text-white p-5 pb-5 relative overflow-hidden">
          <img src={POKE.umbreon} className="absolute -right-4 -bottom-2 w-36 opacity-10" />
          <p className="text-yellow-400 text-[10px] font-black tracking-widest uppercase mb-1">PokEventos</p>
          <h1 className="text-2xl font-black mb-0.5" style={{fontFamily:'Arial Black,sans-serif'}}>Buscar Carta</h1>
          <p className="text-gray-400 text-xs mb-2">Nome Â· nÃºmero (215/203) Â· sÃ³ nÃºmero (215) Â· ID (swsh7-215)</p>

          {/* BotÃ£o Importar Excel */}
          <div className="mb-3">
            <label className="flex items-center justify-center gap-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-4 py-3 rounded-xl font-bold cursor-pointer hover:from-green-600 hover:to-emerald-700 active:scale-95 transition-all shadow-lg">
              ðŸ“Š Importar Cartas do Excel
              <input 
                type="file" 
                accept=".xlsx,.xls" 
                className="hidden"
                onChange={async (e) => {
                  const file = e.target.files?.[0];
                  if (!file) return;
                  
                  // Importar biblioteca XLSX
                  if (!window.XLSX) {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js';
                    document.head.appendChild(script);
                    await new Promise(resolve => script.onload = resolve);
                  }
                  
                  const reader = new FileReader();
                  reader.onload = async (evt) => {
                    try {
                      const data = new Uint8Array(evt.target.result);
                      const workbook = XLSX.read(data, { type: 'array' });
                      const sheet = workbook.Sheets[workbook.SheetNames[0]];
                      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                      
                      // Pular header (primeira linha)
                      const cartas = rows.slice(1).filter(row => row[0]); // Filtrar linhas vazias
                      
                      let processadas = 0;
                      let erros = 0;
                      
                      alert(`ðŸ“Š Processando ${cartas.length} cartas...`);
                      
                      for (const row of cartas) {
                        const numero = String(row[0] || '').trim();
                        const nome = String(row[1] || '').trim();
                        const idioma = String(row[2] || 'EN').trim().toUpperCase();
                        const setId = String(row[3] || '').trim();
                        
                        if (!numero && !nome) continue;
                        
                        try {
                          // Buscar carta
                          const carta = await buscarCartaIdioma(numero, nome, idioma, setId);
                          
                          if (carta && !addedCards.find(c => c.id === carta.id)) {
                            const newCard = {
                              ...carta,
                              quality: 'NM',
                              startValue: '',
                              comment: '',
                              ligaPrice: null,
                              ligaLoading: false,
                              pollOptions: ['', '', ''],
                              minBid: '',
                              increment: ''
                            };
                            setAddedCards(prev => [newCard, ...prev]);
                            processadas++;
                          }
                        } catch (err) {
                          console.error(`Erro ao processar ${numero} ${nome}:`, err);
                          erros++;
                        }
                        
                        // Delay para nÃ£o sobrecarregar API
                        await new Promise(resolve => setTimeout(resolve, 200));
                      }
                      
                      alert(`âœ… Import concluÃ­do!\n${processadas} cartas adicionadas\n${erros} erros`);
                    } catch (error) {
                      alert(`âŒ Erro ao processar Excel: ${error.message}`);
                    }
                  };
                  reader.readAsArrayBuffer(file);
                  e.target.value = '';
                }}
              />
            </label>
          </div>

          <div className="flex gap-2">
            <input
              type="text"
              value={query}
              onChange={e => handleChange(e.target.value)}
              onKeyDown={e => { if (e.key === 'Enter') doSearch(); }}
              placeholder="Charizard Â· 215/172 Â· GG10/GG70 Â· TG22â€¦"
              className="flex-1 px-4 py-3 rounded-xl text-gray-900 text-sm font-medium outline-none bg-white shadow-lg"
              autoComplete="off"
            />
            {query.length > 0
              ? <button onClick={() => handleChange('')}
                  className="bg-white/20 text-white px-4 py-3 rounded-xl font-black text-lg shadow-lg">Ã—</button>
              : null
            }
            <button onClick={() => { if (debounceRef.current) clearTimeout(debounceRef.current); doSearch(); }}
              className="bg-yellow-400 text-gray-900 px-4 py-3 rounded-xl font-black text-lg shadow-lg active:scale-95 transition-transform">
              {loading ? 'â³' : 'ðŸ”'}
            </button>
          </div>

          {/* Tags rÃ¡pidas */}
          <div className="flex flex-wrap gap-2 mt-3">
            {TAGS.map(tag => (
              <button key={tag}
                onClick={() => { setQuery(tag); doSearch(tag); }}
                className="text-[11px] bg-white/15 hover:bg-white/25 text-white px-3 py-1 rounded-full font-semibold border border-white/20">
                {tag}
              </button>
            ))}
          </div>

          {/* Toggle â€” excluir comuns */}
          <div className="mt-3 flex justify-end">
            <button
              onClick={() => setExcluirComuns(v => !v)}
              className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-[11px] font-bold border transition-all ${
                excluirComuns
                  ? 'bg-yellow-400 text-gray-900 border-yellow-400 shadow-md'
                  : 'bg-white/15 text-white border-white/30 hover:bg-white/25'
              }`}>
              {excluirComuns ? 'âœ¦ SÃ³ raras' : 'â—‡ SÃ³ raras'}
            </button>
          </div>
        </div>

        <div className="px-4 pt-4 space-y-3">

          {/* Loading */}
          {loading && (
            <div className="bg-white rounded-2xl shadow-md p-8 text-center">
              <div className="text-4xl mb-3 animate-bounce">ðŸŽ´</div>
              <p className="font-bold text-gray-600">Buscando em TCGdexâ€¦</p>
              <p className="text-xs text-gray-400 mt-1">Consultando base completa de cartas</p>
            </div>
          )}

          {/* Erro */}
          {apiError && !loading && (
            <div className="bg-red-50 border-2 border-red-200 rounded-2xl p-5 text-center">
              <p className="text-3xl mb-2">ðŸ“¡</p>
              <p className="font-bold text-red-700">{apiError}</p>
              <button onClick={() => doSearch()}
                className="mt-3 bg-red-500 text-white px-4 py-2 rounded-xl text-sm font-bold">
                Tentar novamente
              </button>
            </div>
          )}

          {/* Resultados */}
          {!loading && results.length > 0 && (() => {
            const displayResults = excluirComuns ? filtrarComuns(results) : results;
            return (
            <div>
              <p className="text-[11px] font-black text-gray-400 uppercase tracking-widest px-1 mb-3">
                {displayResults.length} variante{displayResults.length !== 1 ? 's' : ''} de "{searched}"
                {excluirComuns && displayResults.length < results.length && (
                  <span className="text-yellow-600 font-normal normal-case ml-1">
                    Â· {results.length - displayResults.length} comum{results.length - displayResults.length !== 1 ? 'uns' : ''} oculta{results.length - displayResults.length !== 1 ? 's' : ''}
                  </span>
                )}
              </p>
              <div className="space-y-3">
                {displayResults.map((card, i) => {
                  const setName  = card.set ? card.set.name : '';
                  const imgSrc   = card.images ? card.images.small : '';
                  const rarity   = card.rarity || '';
                  const inWanted = wantedList.find(w => w.id === card.id);
                  const auctions = EVENTS.filter(ev =>
                    (ev.cards||[]).some(ec => {
                      const ecName = (ec.name||'').toLowerCase();
                      const cName  = (card.name||'').toLowerCase();
                      return ecName.includes(cName) || cName.includes(ecName);
                    })
                  );
                  const rarityColor = rarity.toLowerCase().includes('secret') || rarity.toLowerCase().includes('rainbow') || rarity.toLowerCase().includes('illustration')
                    ? 'bg-purple-100 text-purple-700'
                    : rarity.toLowerCase().includes('ultra') || rarity.toLowerCase().includes('holo')
                    ? 'bg-blue-100 text-blue-700'
                    : 'bg-gray-100 text-gray-500';

                  return (
                    <div key={card.id || i}
                      className="bg-white rounded-2xl shadow-md overflow-hidden cursor-pointer active:scale-95 transition-transform hover:shadow-xl hover:ring-2 hover:ring-yellow-400"
                      onClick={() => setModalCard({ card, setName, imgSrc, rarity, inWanted, auctions, rarityColor })}>
                      <div className="p-4 flex gap-4">
                        {imgSrc
                          ? <img src={imgSrc} alt={card.name}
                              className="h-28 w-auto object-contain rounded-xl shadow-lg border border-gray-100 flex-shrink-0" />
                          : <div className="h-28 w-20 bg-gray-100 rounded-xl flex-shrink-0 flex items-center justify-center text-3xl">ðŸŽ´</div>
                        }
                        <div className="flex-1 min-w-0">
                          <p className="font-black text-gray-900 text-base leading-tight">{card.name}</p>
                          {card.namePt && card.namePt !== card.nameEn && (
                            <p className="text-[10px] text-gray-400 font-medium mt-0.5">ðŸ‡§ðŸ‡· PT: {card.namePt}</p>
                          )}
                          <p className="text-xs text-gray-400 mt-0.5">
                            {setName} Â· <span className="font-mono">{card.number}</span>
                          </p>
                          {rarity ? <span className={'inline-block text-[10px] font-bold px-2 py-0.5 rounded-full mt-1 ' + rarityColor}>{rarity}</span> : null}
                          {auctions.length > 0
                            ? <p className="text-[10px] font-black text-green-600 uppercase tracking-wide mt-2">âœ… Em {auctions.length} leilÃ£{auctions.length > 1 ? 'Ãµes' : 'Ã£o'}</p>
                            : <p className="text-[10px] text-gray-400 mt-2">Toque para ver detalhes</p>
                          }
                          {inWanted && <p className="text-[10px] font-black text-yellow-600 mt-0.5">â­ Na sua Wanted List</p>}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
            );
          })()}

          {/* Sem resultados */}
          {!loading && searched && results.length === 0 && !apiError && (
            <div className="bg-white rounded-2xl shadow-md p-8 text-center">
              <img src={POKE.snorlax} className="w-20 mx-auto mb-3 opacity-30" />
              <p className="font-bold text-gray-600">Nenhuma carta encontrada para "{searched}"</p>
              <p className="text-xs text-gray-400 mt-1">Tente sÃ³ o nome base: "Charizard" em vez de "Charizard GX"</p>
            </div>
          )}

          {/* Estado inicial â€” Wanted List */}
          {!searched && !loading && (
            <div className="space-y-4">
              {wantedList.length > 0 ? (
                <div className="bg-white rounded-2xl shadow-md overflow-hidden border-t-4 border-yellow-400">
                  <div className="px-4 py-3 bg-yellow-50 border-b border-yellow-100 flex items-center justify-between">
                    <p className="font-bold text-gray-700 text-sm">Minha Wanted List</p>
                    <span className="text-xs text-gray-400">{wantedList.length}/50</span>
                  </div>
                  <div className="divide-y divide-gray-50">
                    {wantedWithMatches.map((wc, i) => (
                      <div key={i} className="p-3 flex items-center gap-3">
                        {wc.img
                          ? <img src={wc.img} alt={wc.name}
                              className="h-16 w-auto object-contain rounded-lg shadow border border-yellow-100 flex-shrink-0"
                            />
                          : null
                        }
                        <div className="flex-1 min-w-0">
                          <p className="font-black text-gray-800 text-sm">{wc.name}</p>
                          {wc.set ? <p className="text-xs text-gray-400">{wc.set}{wc.number ? ' Â· ' + wc.number : ''}</p> : null}
                          {wc.matches.length > 0 ? (
                            <div className="mt-1 space-y-1">
                              {wc.matches.map((ev, j) => (
                                <button key={j} onClick={() => setModalEvent(ev)}
                                  className="flex items-center gap-1.5 bg-green-50 text-green-700 border border-green-200 px-2 py-1 rounded-full text-[10px] font-bold w-full text-left">
                                  <span className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse flex-shrink-0 inline-block"></span>
                                  {ev.title.length > 28 ? ev.title.slice(0,28)+'â€¦' : ev.title} Â· {ev.time}
                                </button>
                              ))}
                            </div>
                          ) : (
                            <button onClick={() => { setQuery(wc.name); doSearch(wc.name); }}
                              className="text-[10px] text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full mt-1 inline-block hover:bg-gray-200">
                              Aguardandoâ€¦ buscar novamente â†’
                            </button>
                          )}
                        </div>
                        <button onClick={() => removeWanted(wc.id)}
                          className="w-8 h-8 text-gray-300 hover:text-red-400 hover:bg-red-50 rounded-full flex items-center justify-center flex-shrink-0">
                          âœ•
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              ) : (
                <div className="bg-white rounded-2xl shadow-md p-8 text-center">
                  <img src={POKE.eevee} className="w-20 mx-auto mb-3 opacity-50" />
                  <p className="font-black text-gray-700 mb-2">Como buscar</p>
                  <div className="text-sm text-gray-400 leading-relaxed space-y-1 text-left bg-gray-50 rounded-xl p-3">
                    <p>ðŸ”¤ <strong className="text-gray-600">Por nome</strong> â€” "Charizard" traz todas as versÃµes</p>
                    <p>ðŸ”¢ <strong className="text-gray-600">NÃºmero/total</strong> â€” "215/172" ou "GG10/GG70" busca a carta exata</p>
                    <p>ðŸ”¢ <strong className="text-gray-600">SÃ³ o nÃºmero</strong> â€” "215" ou "GG10" traz todas com esse nÃºmero</p>
                    <p>ðŸ†” <strong className="text-gray-600">ID direto</strong> â€” "swsh7-215" ou "swsh12.5-GG44"</p>
                    <p>ðŸŽ´ <strong className="text-gray-600">Promo</strong> â€” "SVP 001" ou "MEP 012" busca direto no set</p>
                    <p>â­ Cartas nÃ£o encontradas em leilÃ£o vÃ£o para a Wanted List</p>
                  </div>
                </div>
              )}
            </div>
          )}

        </div>

        {modalEvent ? <EventModal key={modalEvent.id} event={modalEvent} onClose={()=>setModalEvent(null)} wantedList={wantedList} matchWanted={matchWanted} AUCTION_GROUPS={AUCTION_GROUPS} checkins={checkins} toggleCheckin={toggleCheckin} addToWanted={addToWanted} removeWanted={removeWanted} /> : null}
        {modalCard && <CardModal data={modalCard} onClose={() => setModalCard(null)} wantedList={wantedList} checkins={checkins} toggleCheckin={toggleCheckin} setModalEvent={setModalEvent} addToWanted={addToWanted} removeWanted={removeWanted} />}
        <BottomNav current="search" />
      </div>
    );
  };




  const AuctioneerScreen = () => {
    const QUALITIES   = ['M','NM','SP','MP','HP','D'];
    const CATEGORIES  = ['1st Edition','Promo','Vintage','Arte Rara','Ultra Rara','Arte Secreta','Holo','Reverse Holo','Full Art','Rainbow','Gold'];
    const AUCTION_TYPES = [
      { id:'poll',  label:'Poll de Lances',    desc:'Participantes votam em opÃ§Ãµes fixas de valor' },
      { id:'free',  label:'Lances Livres',     desc:'Lances a partir de um mÃ­nimo com incremento prÃ©-definido' },
    ];

    /* â”€â”€ Motor de detecÃ§Ã£o removido â€” fotos sÃ£o adicionadas como galeria do evento â”€â”€ */

    const [step,         setStep]         = useState(1);
    const [form,         setForm]         = useState({
      name:'', date:'', time:'', whatsappLink:'', auctionType:'free', categories:[], photos:[], groupId:'',
      announcementPhoto: null,
      eventPhotos: [],
    });
    const [cardQuery,       setCardQuery]      = useState('');
    const [cardResults,     setCardResults]    = useState([]);
    const [cardLoading,     setCardLoading]    = useState(false);
    const [excluirComunsL,  setExcluirComunsL] = useState(false);
    const cardDebounceRef = React.useRef(null);
    const [groupSearch,  setGroupSearch]  = useState('');
    const [savedGroups,  setSavedGroups]  = useState(
      // Grupos salvos pelo leiloeiro (comeÃ§a vazio; futuramente persistido)
      []
    );
    const [auctionCards, setAuctionCards] = useState([]);
    const [savedAuctions,setSavedAuctions]= useState([]);
    const [showSuccess,  setShowSuccess]  = useState(false);
    const [photoPreviewUrls, setPhotoPreviewUrls] = useState({ announcement: null, content: [] });

    const searchCards = (q) => {
      if (!q.trim()) { setCardResults([]); return; }
      if (cardDebounceRef.current) clearTimeout(cardDebounceRef.current);
      cardDebounceRef.current = setTimeout(async () => {
        setCardLoading(true);
        try {
          const found = await tcgdexBuscar(q.trim());
          setCardResults(found);
        } catch {
          setCardResults([]);
        }
        setCardLoading(false);
      }, 500);
    };

    const addCardToAuction = (card) => {
      if (auctionCards.find(c=>c.card.id===card.id)) return;
      // â†“ unshift: nova carta vai pro TOPO
      setAuctionCards(prev => [
        { card, quality:'NM', startValue:'', comment:'', ligaPrice:null, ligaLoading:false,
          pollOptions:['','',''], minBid:'', increment:'' },
        ...prev
      ]);
      setCardQuery(''); setCardResults([]);
    };

    const updateCard = (cardId, field, value) => {
      setAuctionCards(prev => prev.map(c => c.card.id===cardId ? {...c,[field]:value} : c));
    };
    const updateCardPollOption = (cardId, idx, value) => {
      setAuctionCards(prev => prev.map(c => {
        if (c.card.id!==cardId) return c;
        const opts = [...c.pollOptions]; opts[idx]=value;
        return {...c, pollOptions:opts};
      }));
    };
    const addPollOption = (cardId) => {
      setAuctionCards(prev => prev.map(c => c.card.id===cardId ? {...c, pollOptions:[...c.pollOptions,'']} : c));
    };

    const removeCard = (cardId) => {
      setAuctionCards(prev => prev.filter(c => c.card.id!==cardId));
    };

    const fetchLigaPrice = (cardId, cardName) => {
      updateCard(cardId, 'ligaLoading', true);
      setTimeout(() => {
        const mockPrices = {
          'charizard':4800,'pikachu':380,'blastoise':2200,'venusaur':1800,
          'mewtwo':950,'umbreon':3200,'rayquaza':1600,'mew':420,
          'lugia':5500,'arceus':280,'gengar':320,'dragonite':1100,
        };
        const key = Object.keys(mockPrices).find(k=>cardName.toLowerCase().includes(k));
        const price = key ? mockPrices[key]+Math.floor(Math.random()*200-100) : Math.floor(Math.random()*500+100);
        updateCard(cardId,'ligaPrice',price);
        updateCard(cardId,'ligaLoading',false);
      }, 800);
    };

    const saveAuction = async () => {
      const newAuction = {
        ...form, id:Date.now(), status:'published', createdAt:new Date(),
        title:form.name, time:form.time, organizer:'Dr. JoÃ£o Silva',
        description:`LeilÃ£o criado via painel. ${auctionCards.length} cartas.`,
        featured:false,
        whatsappLink: form.whatsappLink || '#',
        paymentMethods:['PIX'], paymentDeadline:form.date,
        auctionType: form.auctionType,
        announcementPhoto: form.announcementPhoto || null,
        eventPhotos: form.eventPhotos || [],
        rawCards: auctionCards,
        cards: auctionCards.map(ac=>({
          name:ac.card.name, number:ac.card.number,
          set:ac.card.set?.name, rarity:ac.quality==='M'||ac.quality==='NM'?'ultra-rare':'holo',
          img:ac.card.images?.large||ac.card.images?.small,
          comment:ac.comment, quality:ac.quality,
          minBid:ac.minBid, increment:ac.increment, pollOptions:ac.pollOptions, ligaPrice:ac.ligaPrice,
        })),
      };
      
      // Salvar no Supabase
      if (user) {
        try {
          console.log('ðŸ’¾ Salvando leilÃ£o no Supabase...');
          const { data: savedAuction, error } = await supabase
            .from('auctions')
            .insert({
              created_by: user.id,
              title: form.name,
              date: form.date,
              time: form.time,
              location: form.location || '',
              host: form.host || userProfile?.nome || 'Leiloeiro',
              group_name: form.auctionGroup,
              cards: newAuction.cards,
              is_live: false,
              whatsapp_link: form.whatsappLink || null,
              payment_methods: newAuction.paymentMethods || [],
              payment_deadline: newAuction.paymentDeadline || null,
              announcement_photo: form.announcementPhoto || null,
              event_photos: form.eventPhotos || []
            })
            .select()
            .single();
          
          if (error) {
            console.error('âŒ Erro ao salvar leilÃ£o:', error);
            alert('âš ï¸ Erro ao salvar leilÃ£o no banco de dados');
          } else if (savedAuction) {
            console.log('âœ… LeilÃ£o salvo! ID:', savedAuction.id);
            newAuction.id = savedAuction.id;
            
            // Adicionar Ã  lista local
            setEvents(prev => [...prev, savedAuction]);
          }
        } catch (err) {
          console.error('âŒ Exception ao salvar leilÃ£o:', err);
        }
      }
      
      setSavedAuctions(prev=>[...prev,newAuction]);
      setShowSuccess(true);
      setTimeout(()=>{ setShowSuccess(false); setStep(4); }, 1500);
    };

    const toggleCategory = (cat) => {
      setForm(prev=>({...prev, categories:prev.categories.includes(cat)?prev.categories.filter(c=>c!==cat):[...prev.categories,cat]}));
    };

    return (
      <div className="min-h-screen bg-gray-50 pokeball-bg pb-24">
        {/* Header */}
        <div className="bg-gradient-to-r from-gray-800 to-gray-900 text-white p-6 pb-8 relative overflow-hidden">
          <div className="absolute right-4 top-4 text-6xl opacity-10">ðŸ”¨</div>
          <h1 className="text-2xl font-black relative z-10" style={{fontFamily:'Arial Black,sans-serif'}}>Painel Leiloeiro</h1>
          <p className="text-gray-300 text-sm">ðŸ”¨ Crie e gerencie seus leilÃµes</p>
        </div>

        {/* Success toast */}
        {showSuccess && (
          <div className="fixed top-4 left-1/2 -translate-x-1/2 z-[9999] bg-green-500 text-white px-6 py-3 rounded-2xl shadow-2xl font-bold flex items-center gap-2 fade-in">
            âœ“ LeilÃ£o salvo com sucesso!
          </div>
        )}

        <div className="px-4 -mt-4 space-y-4">

          {/* â”€â”€ LEILÃ•ES SALVOS â”€â”€ */}
          {savedAuctions.length > 0 && (
            <div className="bg-white rounded-2xl shadow-lg overflow-hidden border-t-4 border-green-400">
              <div className="px-4 py-3 bg-green-50 border-b flex items-center justify-between">
                <p className="font-bold text-gray-700 text-sm">ðŸ“‹ Meus LeilÃµes ({savedAuctions.length})</p>
              </div>
              {savedAuctions.map((a,i) => (
                <div key={i} className="p-3 border-b last:border-0 flex items-center justify-between">
                  <div>
                    <p className="font-bold text-sm text-gray-800">{a.name}</p>
                    <p className="text-xs text-gray-500">{a.date} Â· {a.time} Â· {a.cards.length} cartas</p>
                  </div>
                  <span className="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full font-bold">Rascunho</span>
                </div>
              ))}
            </div>
          )}

          {/* â”€â”€ STEPS â”€â”€ */}
          <div className="bg-white rounded-2xl shadow-lg overflow-hidden border-t-4 border-gray-800">
            {/* Progress bar â€” steps 1, 2, 3 */}
            {step >= 1 && step <= 3 && (
              <div className="flex border-b">
                {[{n:1,label:'LeilÃ£o'},{n:2,label:'Cartas'},{n:3,label:'RevisÃ£o'}].map(s=>(
                  <button key={s.n} onClick={()=>{ if(s.n < step) setStep(s.n); }} className={`flex-1 py-3 text-xs font-bold transition-all ${step===s.n?'bg-gray-800 text-white':'text-gray-400 hover:bg-gray-50'}`}>
                    <span className={`inline-flex items-center justify-center w-5 h-5 rounded-full text-[10px] font-black mr-1 ${step===s.n?'bg-white text-gray-800':step>s.n?'bg-green-500 text-white':'bg-gray-200 text-gray-500'}`}>
                      {step>s.n?'âœ“':s.n}
                    </span>
                    {s.label}
                  </button>
                ))}
              </div>
            )}

            {/* â•â• STEP 1: INFORMAÃ‡Ã•ES + AVATAR + BLOCOS â•â• */}
            {step===1 && (() => {
              // Grupos filtrados pela busca
              const allGroups = [
                ...savedGroups,
                ...AUCTION_GROUPS.filter(g => !savedGroups.find(s => s.id === g.id))
              ];
              const filteredGroups = groupSearch.trim()
                ? allGroups.filter(g =>
                    g.short.toLowerCase().includes(groupSearch.toLowerCase()) ||
                    g.name.toLowerCase().includes(groupSearch.toLowerCase())
                  )
                : allGroups;

              const selectedGroup = allGroups.find(g => g.id === form.groupId);

              return (
              <div className="p-4 space-y-5">

                {/* â”€â”€ Nome / Grupo do leilÃ£o â”€â”€ */}
                <div>
                  <label className="text-xs font-bold text-gray-600 block mb-2">ðŸ·ï¸ Nome do LeilÃ£o</label>

                  {/* Grupo selecionado â€” mostra pill e permite trocar */}
                  {selectedGroup ? (
                    <div className="flex items-center gap-3 p-3 rounded-2xl bg-green-50 border-2 border-green-400 mb-2">
                      <div className={`w-10 h-10 rounded-full bg-gradient-to-br ${selectedGroup.color} flex items-center justify-center text-xl flex-shrink-0 shadow`}>
                        {selectedGroup.avatarUrl
                          ? <img src={selectedGroup.avatarUrl} className="w-10 h-10 rounded-full object-cover" />
                          : selectedGroup.emoji}
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="font-bold text-sm text-gray-800 truncate">{selectedGroup.short}</p>
                        <p className="text-[10px] text-green-600 font-semibold">âœ“ Grupo selecionado</p>
                      </div>
                      <button onClick={()=>{ setForm(p=>({...p,groupId:'',name:''})); setGroupSearch(''); }}
                        className="text-gray-400 hover:text-red-500 text-lg px-1">âœ•</button>
                    </div>
                  ) : (
                    <>
                      {/* Campo de busca de grupo */}
                      <div className="relative mb-2">
                        <input
                          value={groupSearch}
                          onChange={e => {
                            setGroupSearch(e.target.value);
                            setForm(p => ({...p, name: e.target.value}));
                          }}
                          placeholder="Buscar ou digitar nome do leilÃ£oâ€¦"
                          className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-sm focus:border-yellow-400 outline-none pr-10"
                        />
                        <span className="absolute right-3 top-3 text-gray-400">ðŸ”</span>
                      </div>

                      {/* Lista de grupos filtrada */}
                      {groupSearch.trim() && (
                        <div className="border-2 border-gray-200 rounded-xl overflow-hidden max-h-48 overflow-y-auto shadow-lg mb-2">
                          {filteredGroups.length > 0 ? filteredGroups.map(g => (
                            <button key={g.id}
                              onClick={() => {
                                setForm(p => ({...p, groupId: g.id, name: g.short}));
                                setGroupSearch('');
                                // Salva grupo para uso futuro se ainda nÃ£o estiver salvo
                                if (!savedGroups.find(s => s.id === g.id)) {
                                  setSavedGroups(prev => [g, ...prev]);
                                }
                              }}
                              className="w-full flex items-center gap-3 p-2.5 hover:bg-yellow-50 border-b last:border-0 text-left transition-all">
                              <div className={`w-9 h-9 rounded-full bg-gradient-to-br ${g.color} flex items-center justify-center text-lg flex-shrink-0 shadow-sm flex-shrink-0`}>
                                {g.avatarUrl
                                  ? <img src={g.avatarUrl} className="w-9 h-9 rounded-full object-cover" />
                                  : g.emoji}
                              </div>
                              <span className="text-sm font-semibold text-gray-700">{g.short}</span>
                              {savedGroups.find(s=>s.id===g.id) && (
                                <span className="ml-auto text-[10px] text-yellow-600 font-bold">â­ Salvo</span>
                              )}
                            </button>
                          )) : (
                            <button
                              onClick={() => {
                                const newGroup = {
                                  id: 'custom-' + Date.now(),
                                  name: groupSearch, short: groupSearch,
                                  emoji: 'ðŸŽ´', color: 'from-gray-600 to-gray-800',
                                  avatarUrl: null,
                                };
                                setSavedGroups(prev => [newGroup, ...prev]);
                                setForm(p => ({...p, groupId: newGroup.id, name: groupSearch}));
                                setGroupSearch('');
                              }}
                              className="w-full flex items-center gap-3 p-3 hover:bg-blue-50 text-left">
                              <div className="w-9 h-9 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-lg flex-shrink-0">+</div>
                              <div>
                                <p className="text-sm font-bold text-blue-600">Cadastrar "{groupSearch}"</p>
                                <p className="text-[10px] text-gray-400">Salvar como novo grupo</p>
                              </div>
                            </button>
                          )}
                        </div>
                      )}
                    </>
                  )}
                </div>

                {/* â”€â”€ Avatar do Leiloeiro â”€â”€ */}
                <div>
                  <label className="text-xs font-bold text-gray-600 block mb-2">ðŸ–¼ï¸ Avatar do Leiloeiro</label>
                  <p className="text-[10px] text-gray-400 mb-2">Foto de perfil/avatar do grupo no WhatsApp</p>
                  <label className="block cursor-pointer">
                    <div className={`rounded-2xl border-2 border-dashed overflow-hidden transition-all ${photoPreviewUrls.announcement ? 'border-green-300' : 'border-gray-300 hover:border-yellow-400 bg-gray-50'}`}>
                      {photoPreviewUrls.announcement ? (
                        <div className="relative flex items-center gap-4 p-3">
                          <img src={photoPreviewUrls.announcement} alt="Avatar"
                            className="w-16 h-16 rounded-full object-cover border-4 border-white shadow-lg flex-shrink-0" />
                          <div className="flex-1">
                            <p className="font-bold text-sm text-gray-800">Avatar definido âœ“</p>
                            <p className="text-xs text-gray-500">Clique para trocar</p>
                          </div>
                          <button
                            onClick={e=>{e.preventDefault();setPhotoPreviewUrls(p=>({...p,announcement:null}));setForm(p=>({...p,announcementPhoto:null}));}}
                            className="w-7 h-7 bg-gray-200 hover:bg-red-100 text-gray-500 hover:text-red-500 rounded-full flex items-center justify-center font-bold flex-shrink-0">âœ•</button>
                        </div>
                      ) : (
                        <div className="p-5 text-center">
                          <p className="text-3xl mb-1">ðŸ‘¤</p>
                          <p className="text-sm font-semibold text-gray-500">Adicionar avatar do grupo</p>
                          <p className="text-[10px] text-gray-400 mt-0.5">Foto de perfil do WhatsApp</p>
                        </div>
                      )}
                    </div>
                    <input type="file" accept="image/*" className="hidden"
                      onChange={e=>{
                        const f = e.target.files?.[0]; if (!f) return;
                        const url = URL.createObjectURL(f);
                        setPhotoPreviewUrls(p=>({...p,announcement:url}));
                        setForm(p=>({...p,announcementPhoto:url}));
                        // Atualiza avatar no grupo salvo tambÃ©m
                        if (form.groupId) {
                          setSavedGroups(prev => prev.map(g =>
                            g.id === form.groupId ? {...g, avatarUrl: url} : g
                          ));
                        }
                      }} />
                  </label>
                </div>

                {/* â”€â”€ Data e HorÃ¡rio â”€â”€ */}
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="text-xs font-bold text-gray-600 block mb-1">ðŸ“… Data *</label>
                    <input type="date" value={form.date} onChange={e=>setForm(p=>({...p,date:e.target.value}))}
                      className="w-full px-3 py-3 border-2 border-gray-200 rounded-xl text-sm focus:border-gray-800 outline-none" />
                  </div>
                  <div>
                    <label className="text-xs font-bold text-gray-600 block mb-1">â° HorÃ¡rio *</label>
                    <input type="time" value={form.time} onChange={e=>setForm(p=>({...p,time:e.target.value}))}
                      className="w-full px-3 py-3 border-2 border-gray-200 rounded-xl text-sm focus:border-gray-800 outline-none" />
                  </div>
                </div>

                {/* â”€â”€ Link WhatsApp â”€â”€ */}
                <div>
                  <label className="text-xs font-bold text-gray-600 block mb-1">ðŸ“² Link do Grupo <span className="text-gray-400 font-normal">(opcional)</span></label>
                  <input value={form.whatsappLink} onChange={e=>setForm(p=>({...p,whatsappLink:e.target.value}))}
                    placeholder="https://chat.whatsapp.com/â€¦"
                    className="w-full px-4 py-2.5 border-2 border-gray-200 rounded-xl text-sm focus:border-green-500 outline-none" />
                </div>

                {/* â”€â”€ Tipo de LeilÃ£o â”€â”€ */}
                <div>
                  <label className="text-xs font-bold text-gray-600 block mb-2">Tipo de LeilÃ£o *</label>
                  <div className="space-y-2">
                    {AUCTION_TYPES.map(t=>(
                      <button key={t.id} onClick={()=>setForm(p=>({...p,auctionType:t.id}))}
                        className={`w-full text-left p-3 rounded-xl border-2 transition-all ${form.auctionType===t.id?'border-gray-800 bg-gray-50':'border-gray-200 hover:border-gray-400'}`}>
                        <div className="flex items-center gap-3">
                          <div className={`w-4 h-4 rounded-full border-2 flex items-center justify-center flex-shrink-0 ${form.auctionType===t.id?'border-gray-800':'border-gray-300'}`}>
                            {form.auctionType===t.id && <div className="w-2 h-2 bg-gray-800 rounded-full"></div>}
                          </div>
                          <div>
                            <p className="font-bold text-sm text-gray-800">{t.label}</p>
                            <p className="text-xs text-gray-500">{t.desc}</p>
                          </div>
                        </div>
                      </button>
                    ))}
                  </div>
                </div>

                {/* â”€â”€ Fotos dos Blocos â”€â”€ */}
                <div>
                  <label className="text-xs font-bold text-gray-600 block mb-1">ðŸ“¦ Fotos dos Blocos do LeilÃ£o</label>
                  <p className="text-[10px] text-gray-400 mb-2">Cada foto vira um bloco numerado no evento</p>
                  <div className="grid grid-cols-3 gap-2">
                    {photoPreviewUrls.content.map((url, i) => (
                      <div key={i} className="relative aspect-square rounded-xl overflow-hidden border-2 border-yellow-300 bg-gray-100">
                        <img src={url} alt={`Bloco ${i+1}`} className="w-full h-full object-cover" />
                        <div className="absolute bottom-0 left-0 right-0 bg-black/60 text-white text-[10px] font-bold text-center py-0.5">
                          Bloco {i+1}
                        </div>
                        <button
                          onClick={()=>{
                            setPhotoPreviewUrls(p=>({...p,content:p.content.filter((_,j)=>j!==i)}));
                            setForm(p=>({...p,eventPhotos:p.eventPhotos.filter((_,j)=>j!==i)}));
                          }}
                          className="absolute top-1 right-1 bg-black/60 text-white w-5 h-5 rounded-full text-[10px] font-bold flex items-center justify-center">âœ•</button>
                      </div>
                    ))}
                    <label className="aspect-square rounded-xl border-2 border-dashed border-gray-300 hover:border-yellow-400 bg-gray-50 flex flex-col items-center justify-center cursor-pointer transition-all">
                      <span className="text-2xl text-gray-400">+</span>
                      <span className="text-[10px] text-gray-400 mt-1">Bloco {photoPreviewUrls.content.length + 1}</span>
                      <input type="file" accept="image/*" multiple className="hidden"
                        onChange={e=>{
                          const files = Array.from(e.target.files||[]);
                          const urls  = files.map(f=>URL.createObjectURL(f));
                          setPhotoPreviewUrls(p=>({...p,content:[...p.content,...urls]}));
                          setForm(p=>({...p,eventPhotos:[...p.eventPhotos,...urls]}));
                        }} />
                    </label>
                  </div>
                </div>

                <button onClick={()=>setStep(2)} disabled={!form.date||!form.time||(!form.groupId&&!form.name)}
                  className="w-full bg-gray-800 text-white py-4 rounded-xl font-bold disabled:opacity-40 hover:bg-gray-900 transition-all">
                  PrÃ³ximo: Adicionar Cartas â†’
                </button>
              </div>
              );
            })()}

            {/* â•â• STEP 2: CARTAS â•â• */}
            {step===2 && (
              <div className="p-4 space-y-4">

                {/* â”€â”€ Fotos dos blocos â€” referÃªncia visual para adicionar cartas â”€â”€ */}
                <BlocoCarrossel fotos={photoPreviewUrls.content} dark={true} />

                {/* Busca de cartas */}
                <div>
                  {/* Linha label + toggle */}
                  <div className="flex items-center justify-between mb-2">
                    <label className="text-xs font-bold text-gray-600">ðŸŽ´ Adicionar Carta ao LeilÃ£o</label>
                    <button
                      onClick={() => setExcluirComunsL(v => !v)}
                      className={`flex items-center gap-1 px-2.5 py-1 rounded-full text-[10px] font-bold border transition-all ${
                        excluirComunsL
                          ? 'bg-yellow-400 text-gray-900 border-yellow-400'
                          : 'bg-gray-100 text-gray-500 border-gray-300 hover:border-gray-500'
                      }`}>
                      {excluirComunsL ? 'âœ¦ SÃ³ raras' : 'â—‡ SÃ³ raras'}
                    </button>
                    {/* BotÃ£o Importar JSON */}
                    <label className="flex items-center gap-1.5 bg-gradient-to-r from-purple-600 to-pink-600 text-white px-3 py-2 rounded-xl text-xs font-bold cursor-pointer hover:from-purple-700 hover:to-pink-700 active:scale-95 transition-all">
                      ðŸ“¥ JSON
                      <input type="file" accept=".json" className="hidden"
                        onChange={e => {
                          const file = e.target.files?.[0];
                          if (!file) return;
                          const reader = new FileReader();
                          reader.onload = (evt) => {
                            try {
                              const cartas = JSON.parse(evt.target.result);
                              if (!Array.isArray(cartas)) { alert('âŒ JSON invÃ¡lido!'); return; }
                              let adicionadas = 0;
                              cartas.forEach(carta => { if (auctionCards.find(c => c.card.id === carta.id)) return; adicionadas++; });
                              setAuctionCards(prev => [...prev, ...cartas.filter(c => !auctionCards.find(ac => ac.card.id === c.id)).map(carta => ({ card: carta, quality: 'NM', startValue: '', comment: '', ligaPrice: null, ligaLoading: false, pollOptions: ['', '', ''], minBid: '', increment: '' }))]);
                              alert(`âœ… ${adicionadas} cartas importadas!`);
                            } catch (error) { alert(`âŒ Erro: ${error.message}`); }
                          };
                          reader.readAsText(file);
                          e.target.value = '';
                        }} />
                    </label>
                  </div>
                  <div className="flex gap-2">
                    <input value={cardQuery} onChange={e=>{setCardQuery(e.target.value);searchCards(e.target.value);}}
                      placeholder="Nome da carta, nÃºmero, ediÃ§Ã£oâ€¦"
                      className="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl text-sm focus:border-gray-800 outline-none" />
                    {cardLoading && <span className="text-gray-400 text-sm self-center flex-shrink-0">â³</span>}
                    {/* BotÃ£o Escanear â€” abre cÃ¢mera traseira direto */}
                    <label className="flex items-center gap-1.5 bg-gray-900 text-white px-3 py-2 rounded-xl text-xs font-bold cursor-pointer hover:bg-gray-700 active:scale-95 transition-all flex-shrink-0">
                      ðŸ“· Escanear
                      <input type="file" accept="image/*" capture="environment" className="hidden"
                        onChange={e => {
                          const file = e.target.files?.[0];
                          if (!file) return;
                          const name = file.name.replace(/\.[^.]+$/, '').replace(/[_-]/g,' ');
                          setCardQuery(name);
                          searchCards(name);
                          e.target.value = '';
                        }} />
                    </label>
                  </div>

                  {/* Resultados da busca */}
                  {cardResults.length > 0 && (() => {
                    const displayCards = excluirComunsL ? filtrarComuns(cardResults) : cardResults;
                    return (
                    <div className="mt-2 border-2 border-gray-200 rounded-xl overflow-hidden max-h-60 overflow-y-auto shadow-lg">
                      {displayCards.length === 0 ? (
                        <p className="text-center text-xs text-gray-400 py-4">Nenhuma carta rara encontrada. Desative o filtro para ver todas.</p>
                      ) : displayCards.map((card, i) => (
                        <button key={i} onClick={() => addCardToAuction(card)}
                          className="w-full flex items-center gap-3 p-3 hover:bg-yellow-50 border-b last:border-0 text-left transition-all">
                          <img src={card.images?.small} alt={card.name} className="h-24 w-auto object-contain rounded-xl border border-gray-200 shadow-sm flex-shrink-0" onError={e=>e.target.style.display='none'} />
                          <div className="flex-1 min-w-0">
                            <p className="font-bold text-sm text-gray-800 leading-snug">{card.name}</p>
                            {card.namePt && card.namePt !== card.nameEn && (
                              <p className="text-[10px] text-blue-500 font-medium">ðŸ‡§ðŸ‡· {card.namePt}</p>
                            )}
                            <p className="text-xs text-gray-500 mt-0.5">{card.set?.name}</p>
                            <p className="text-[10px] font-mono text-gray-400">{card.number}</p>
                            {card.rarity && <span className="inline-block mt-1 text-[10px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded-full">{card.rarity}</span>}
                          </div>
                          <span className="text-green-500 text-2xl flex-shrink-0">+</span>
                        </button>
                      ))}
                    </div>
                    );
                  })()}
                </div>

                {/* Cartas adicionadas â€” mais recente no TOPO */}
                {auctionCards.length===0 ? (
                  <div className="text-center py-8 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                    <p className="text-3xl mb-2">ðŸŽ´</p>
                    <p className="font-semibold text-gray-500 text-sm">Nenhuma carta adicionada ainda</p>
                    <p className="text-xs text-gray-400">Use a busca acima para adicionar cartas ao leilÃ£o</p>
                  </div>
                ) : (
                  <div className="space-y-4">
                    <p className="font-bold text-sm text-gray-700 flex items-center gap-2">
                      {auctionCards.length} carta(s)
                      <span className="text-[10px] text-gray-400 font-normal">â€” Ãºltima adicionada aparece primeiro</span>
                    </p>
                    {auctionCards.map(({card,quality,startValue,comment,ligaPrice,ligaLoading,pollOptions,minBid,increment},i)=>(
                      <div key={card.id} className={`bg-white border-2 rounded-xl overflow-hidden shadow-sm ${i===0?'border-yellow-400 ring-2 ring-yellow-200':'border-gray-200'}`}>

                        {/* Badge "mais recente" */}
                        {i===0 && (
                          <div className="bg-yellow-400 px-3 py-1">
                            <span className="text-white text-[10px] font-black">âœ¦ ADICIONADA AGORA</span>
                          </div>
                        )}

                        {/* Header da carta */}
                        <div className="flex items-center gap-3 p-3 border-b border-gray-100">
                          <img src={card.images?.large||card.images?.small} alt={card.name}
                            className="h-16 w-auto object-contain rounded-lg border border-gray-200 flex-shrink-0"
                            onError={e=>e.target.style.display='none'} />
                          <div className="flex-1 min-w-0">
                            <p className="font-black text-sm text-gray-800">{card.name}</p>
                            {card.namePt && card.namePt !== card.nameEn && (
                              <p className="text-[10px] text-blue-500 font-medium">ðŸ‡§ðŸ‡· {card.namePt}</p>
                            )}
                            <p className="text-xs text-gray-500">{card.set?.name} Â· <span className="font-mono">{card.number}</span></p>
                            {card.rarity && <span className="text-[10px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded-full">{card.rarity}</span>}
                          </div>
                          <button onClick={()=>removeCard(card.id)}
                            className="w-7 h-7 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-full flex items-center justify-center text-lg flex-shrink-0">âœ•</button>
                        </div>

                        <div className="p-3 space-y-3">

                          {/* Qualidade */}
                          <div>
                            <label className="text-[10px] font-bold text-gray-500 block mb-1.5">QUALIDADE DA CARTA</label>
                            <div className="flex gap-1.5 flex-wrap">
                              {QUALITIES.map(q=>(
                                <button key={q} onClick={()=>updateCard(card.id,'quality',q)}
                                  className={`px-3 py-1.5 rounded-lg text-xs font-black border-2 transition-all ${quality===q?`${QUALITY_COLOR[q]} text-white border-transparent`:'bg-white text-gray-500 border-gray-200 hover:border-gray-400'}`}>
                                  {q}
                                </button>
                              ))}
                            </div>
                            <p className="text-[9px] text-gray-400 mt-1">{QUALITY_DESC[quality]}</p>
                          </div>

                          {/* Valores â€” POLL */}
                          {form.auctionType==='poll' && (
                            <div className="bg-blue-50 rounded-xl p-3 border-2 border-blue-200">
                              <label className="text-[10px] font-bold text-blue-700 block mb-2">
                                OPÃ‡Ã•ES DA POLL â€” valores para esta carta (R$)
                              </label>
                              {pollOptions.map((opt,idx)=>(
                                <div key={idx} className="flex items-center gap-2 mb-2 last:mb-0">
                                  <span className="text-xs text-gray-400 w-14 flex-shrink-0">OpÃ§Ã£o {idx+1}</span>
                                  <input value={opt}
                                    onChange={e=>updateCardPollOption(card.id,idx,e.target.value)}
                                    placeholder="R$ 0,00" type="number"
                                    className="flex-1 px-3 py-2 border-2 border-blue-200 rounded-lg text-sm outline-none focus:border-blue-500 bg-white" />
                                  {pollOptions.length>2 && (
                                    <button onClick={()=>{
                                      setAuctionCards(prev=>prev.map(c=>{
                                        if(c.card.id!==card.id)return c;
                                        return {...c,pollOptions:c.pollOptions.filter((_,j)=>j!==idx)};
                                      }));
                                    }} className="text-gray-300 hover:text-red-400 text-lg">âœ•</button>
                                  )}
                                </div>
                              ))}
                              <button onClick={()=>addPollOption(card.id)}
                                className="mt-2 text-xs text-blue-600 font-bold flex items-center gap-1">
                                + Adicionar opÃ§Ã£o
                              </button>
                            </div>
                          )}

                          {/* Valores â€” LANCE LIVRE */}
                          {form.auctionType==='free' && (
                            <div className="bg-green-50 rounded-xl p-3 border-2 border-green-200">
                              <label className="text-[10px] font-bold text-green-700 block mb-2">
                                CONFIGURAÃ‡ÃƒO DE LANCES â€” para esta carta
                              </label>
                              <div className="grid grid-cols-2 gap-2">
                                <div>
                                  <label className="text-[10px] text-gray-500 block mb-1">Lance MÃ­nimo (R$)</label>
                                  <input value={minBid} onChange={e=>updateCard(card.id,'minBid',e.target.value)}
                                    placeholder="50" type="number"
                                    className="w-full px-3 py-2 border-2 border-green-200 rounded-lg text-sm outline-none focus:border-green-500 bg-white" />
                                </div>
                                <div>
                                  <label className="text-[10px] text-gray-500 block mb-1">Incremento (R$)</label>
                                  <input value={increment} onChange={e=>updateCard(card.id,'increment',e.target.value)}
                                    placeholder="10" type="number"
                                    className="w-full px-3 py-2 border-2 border-green-200 rounded-lg text-sm outline-none focus:border-green-500 bg-white" />
                                </div>
                              </div>
                            </div>
                          )}

                          {/* ReferÃªncia Liga Pokemon */}
                          <div>
                            <label className="text-[10px] font-bold text-gray-500 block mb-1">
                              REFERÃŠNCIA LIGA POKEMON <span className="text-gray-400 font-normal">(simulado*)</span>
                            </label>
                            {ligaPrice ? (
                              <div className="flex items-center gap-3 px-3 py-2 bg-green-50 border-2 border-green-200 rounded-lg">
                                <div>
                                  <p className="text-sm font-black text-green-700">R$ {ligaPrice.toLocaleString('pt-BR')}</p>
                                  <p className="text-[9px] text-gray-400">menor preÃ§o encontrado no Liga Pokemon</p>
                                </div>
                                <button onClick={()=>updateCard(card.id,'ligaPrice',null)}
                                  className="ml-auto text-xs text-gray-400 hover:text-gray-600">â†º</button>
                              </div>
                            ) : (
                              <button onClick={()=>fetchLigaPrice(card.id,card.name)} disabled={ligaLoading}
                                className="w-full px-3 py-2 bg-blue-50 border-2 border-blue-200 rounded-lg text-xs font-bold text-blue-600 hover:bg-blue-100 disabled:opacity-60">
                                {ligaLoading ? 'âŸ³ Buscandoâ€¦' : 'ðŸ”Ž Buscar menor preÃ§o no Liga Pokemon'}
                              </button>
                            )}
                          </div>

                          {/* ComentÃ¡rio */}
                          <div>
                            <label className="text-[10px] font-bold text-gray-500 block mb-1">COMENTÃRIOS SOBRE A CARTA</label>
                            <textarea value={comment} onChange={e=>updateCard(card.id,'comment',e.target.value)}
                              placeholder="Ex: Centering 60/40, pequena amassado na borda inferior, sem riscos na faceâ€¦"
                              rows={2}
                              className="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm outline-none focus:border-gray-800 resize-none" />
                          </div>

                        </div>
                      </div>
                    ))}
                  </div>
                )}

                <div className="flex gap-2">
                  <button onClick={()=>setStep(1)} className="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-bold text-sm hover:bg-gray-200">â† Voltar</button>
                  <button onClick={()=>setStep(3)} disabled={auctionCards.length===0}
                    className="flex-2 flex-1 bg-gray-800 text-white py-3 rounded-xl font-bold text-sm disabled:opacity-40 hover:bg-gray-900">
                    Revisar LeilÃ£o â†’
                  </button>
                </div>
              </div>
            )}

            {/* â•â• STEP 3: REVISÃƒO â•â• */}
            {step===3 && (
              <div className="p-4 space-y-4">
                <h3 className="font-black text-gray-800 text-lg">ðŸ“‹ RevisÃ£o Final</h3>

                <div className="bg-gray-50 rounded-xl p-4 space-y-2 border-2 border-gray-200">
                  <div className="flex justify-between text-sm"><span className="text-gray-500">Nome</span><span className="font-bold text-gray-800">{form.name}</span></div>
                  <div className="flex justify-between text-sm"><span className="text-gray-500">Data</span><span className="font-bold">{form.date} Ã s {form.time}</span></div>
                  <div className="flex justify-between text-sm"><span className="text-gray-500">Tipo</span><span className="font-bold">{form.auctionType==='poll'?'Poll de Lances':'Lances Livres'}</span></div>
                  {form.auctionType==='free' && form.minBid && <div className="flex justify-between text-sm"><span className="text-gray-500">Lance mÃ­n.</span><span className="font-bold">R$ {form.minBid} (+{form.increment})</span></div>}
                  {form.categories.length>0 && <div className="flex justify-between text-sm items-start"><span className="text-gray-500">Categorias</span><span className="font-bold text-right max-w-[60%]">{form.categories.join(', ')}</span></div>}
                  <div className="flex justify-between text-sm"><span className="text-gray-500">Cartas</span><span className="font-bold">{auctionCards.length}</span></div>
                </div>

                <div className="space-y-2">
                  <p className="font-bold text-sm text-gray-700">Cartas do leilÃ£o:</p>
                  {auctionCards.map(({card,quality,ligaPrice,comment,pollOptions,minBid,increment},i)=>(
                    <div key={i} className="flex items-start gap-3 bg-white rounded-xl p-3 border border-gray-200">
                      <img src={card.images?.small} alt={card.name} className="h-12 w-auto object-contain rounded flex-shrink-0" onError={e=>e.target.style.display='none'} />
                      <div className="flex-1 min-w-0">
                        <p className="font-bold text-sm text-gray-800 truncate">{card.name}</p>
                        <p className="text-xs text-gray-500">{card.number} Â· {card.set?.name}</p>
                        {form.auctionType==='free' && (minBid||increment) && (
                          <p className="text-xs text-green-700 mt-0.5">MÃ­n: R$ {minBid||'â€”'} Â· Inc: R$ {increment||'â€”'}</p>
                        )}
                        {form.auctionType==='poll' && (
                          <p className="text-xs text-blue-700 mt-0.5">Poll: {pollOptions.filter(Boolean).map(v=>`R$${v}`).join(', ')||'â€”'}</p>
                        )}
                        {ligaPrice && <p className="text-[10px] text-green-600">Liga: R$ {ligaPrice.toLocaleString('pt-BR')}</p>}
                        {comment && <p className="text-[10px] text-gray-400 italic mt-0.5 truncate">ðŸ’¬ {comment}</p>}
                      </div>
                      <span className={`text-xs font-black text-white px-2 py-1 rounded-lg flex-shrink-0 ${QUALITY_COLOR[quality]}`}>{quality}</span>
                    </div>
                  ))}
                </div>

                <div className="flex gap-2">
                  <button onClick={()=>setStep(2)} className="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-bold text-sm">â† Editar</button>
                  <button onClick={saveAuction} className="flex-1 bg-green-500 text-white py-3 rounded-xl font-bold text-sm hover:bg-green-600">
                    âœ“ Publicar LeilÃ£o
                  </button>
                </div>

                <p className="text-[10px] text-gray-400 text-center">Ao publicar, o leilÃ£o aparecerÃ¡ imediatamente no CalendÃ¡rio e os usuÃ¡rios com cartas deste leilÃ£o na Wanted List receberÃ£o um alerta.</p>
              </div>
            )}

            {/* â•â• STEP 4: OFERTA SALA AO VIVO â•â• */}
            {step===4 && (
              <div className="p-6 text-center space-y-5">
                <div className="text-6xl">ðŸŽ‰</div>
                <h3 className="font-black text-xl text-gray-800">LeilÃ£o publicado!</h3>
                <p className="text-sm text-gray-600">JÃ¡ aparece no CalendÃ¡rio. Quer realizar o leilÃ£o agora pela plataforma?</p>
                <div className="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-5 text-left text-white space-y-3">
                  <p className="font-black text-base">ðŸ”¨ Sala de LeilÃ£o ao Vivo â€” Sem custo</p>
                  <p className="text-xs text-gray-300 leading-relaxed">Conduza o leilÃ£o carta por carta. Participantes entram na sala, dÃ£o lances e vocÃª recebe relatÃ³rio completo ao final.</p>
                  <div className="grid grid-cols-2 gap-1 text-xs text-gray-400">
                    {['âœ… Timer por carta','âœ… Timestamps de bids','âœ… Poll ou Lance livre','âœ… Upload de fotos/vÃ­deo','âœ… RelatÃ³rio automÃ¡tico','âœ… Contatos dos vencedores'].map((f,i)=><p key={i}>{f}</p>)}
                  </div>
                </div>
                <div className="space-y-2">
                  <button onClick={()=>setStep(5)} className="w-full bg-gray-800 text-white py-4 rounded-xl font-bold hover:bg-gray-900">
                    ðŸ”¨ Iniciar Sala de LeilÃ£o Agora
                  </button>
                  <button onClick={()=>{ setStep(1); setForm({name:'',date:'',time:'',whatsappLink:'',auctionType:'free',categories:[],photos:[],groupId:'',announcementPhoto:null,eventPhotos:[]}); setAuctionCards([]); }}
                    className="w-full bg-gray-100 text-gray-500 py-3 rounded-xl font-semibold text-sm">
                    Agendei para depois â€” Voltar ao painel
                  </button>
                </div>
              </div>
            )}

            {/* â•â• STEP 5: SALA AO VIVO â•â• */}
            {step===5 && (
              <LiveAuctionRoom
                auction={savedAuctions[savedAuctions.length-1]}
                onEnd={()=>{ setStep(1); setForm({name:'',date:'',time:'',whatsappLink:'',auctionType:'free',categories:[],photos:[],groupId:'',announcementPhoto:null,eventPhotos:[]}); setAuctionCards([]); }}
              />
            )}
          </div>
        </div>
        <BottomNav current="auctioneer" />
      </div>
    );
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SALA DE LEILÃƒO AO VIVO ðŸ”¨
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const LiveAuctionRoom = ({ auction, onEnd }) => {
      if (!auction) return null;
      const cards = auction.rawCards || [];
      const atype = auction.auctionType || 'free';
      const isFree = atype === 'free';
      const isPoll = atype === 'poll';
  
      const QUALITY_COLOR = {M:'bg-green-500',NM:'bg-blue-500',SP:'bg-yellow-500',MP:'bg-orange-500',HP:'bg-red-500',D:'bg-gray-500'};
  
      // â”€â”€ FREE: estado linear carta-por-carta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const [cardIdx,    setCardIdx]    = useState(0);
      const [phase,      setPhase]      = useState('waiting'); // waiting | bidding | sold | ended
      const [timer,      setTimer]      = useState(0);
      const [timerMax,   setTimerMax]   = useState(60);
      const [timerInput, setTimerInput] = useState('60');
      const [bids,       setBids]       = useState({});        // {cardIdx: [{user,value,ts}]}
  
      // â”€â”€ POLL: estado por carta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // pollBids[cardIdx] = {optIdx: [{user,ts}]}   votos por opÃ§Ã£o
      const [pollBids,   setPollBids]   = useState({});
      // pollStatus[cardIdx] = 'open' | 'arremate_pending' | 'closed'
      const [pollStatus, setPollStatus] = useState(() => {
        const s = {};
        cards.forEach((_,i) => { s[i] = 'open'; });
        return s;
      });
      // pollArremate[cardIdx] = { optIdx, user, ts, countdown }
      const [pollArremate, setPollArremate] = useState({});
      // countdown de 3 min por carta em arremate_pending
      const [arrCountdown, setArrCountdown] = useState({});  // {cardIdx: secondsLeft}
  
      // â”€â”€ Compartilhados â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const [chatMsgs,   setChatMsgs]   = useState([
        {user:'Sistema', msg:'Bem-vindo Ã  sala! Aguardando o leiloeiro iniciar.', ts:new Date(), system:true},
      ]);
      const [chatInput,  setChatInput]  = useState('');
      const [showReport, setShowReport] = useState(false);
      const [uploads,    setUploads]    = useState({});
      const [inlineBid,  setInlineBid]  = useState({minBid:'', increment:'', pollOptions:['','','']});
      const [showConfirm,setShowConfirm]= useState(false);
      const [activePollCard, setActivePollCard] = useState(0); // carta visÃ­vel no poll
  
      const currentCard     = cards[cardIdx];
      const participants    = [{name:'Dr. JoÃ£o (leiloeiro)'}, {name:'Participante 1'}, {name:'Participante 2'}];
      const effectiveMinBid = inlineBid.minBid    || currentCard?.minBid    || '';
      const effectiveInc    = inlineBid.increment || currentCard?.increment  || '';
      const effectivePollOpts = inlineBid.pollOptions.some(Boolean)
        ? inlineBid.pollOptions
        : (currentCard?.pollOptions || []);
  
      // â”€â”€ Timer countdown (FREE) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      useEffect(() => {
        if (phase !== 'bidding' || timer <= 0) return;
        const t = setTimeout(() => setTimer(p => p - 1), 1000);
        return () => clearTimeout(t);
      }, [phase, timer]);
  
      useEffect(() => {
        if (phase === 'bidding' && timer === 0) {
          setChatMsgs(p => [...p, {user:'Sistema', msg:`â±ï¸ Tempo esgotado! Carta: ${currentCard?.card?.name}`, ts:new Date(), system:true}]);
          setPhase('sold');
        }
      }, [timer, phase]);
  
      // â”€â”€ Countdown arremate (POLL) 3 minutos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      useEffect(() => {
        const pending = Object.entries(pollStatus).filter(([,s]) => s === 'arremate_pending');
        if (!pending.length) return;
        const t = setInterval(() => {
          setArrCountdown(prev => {
            const next = {...prev};
            pending.forEach(([idx]) => {
              const i = parseInt(idx);
              const cur = next[i] ?? 180;
              if (cur <= 1) {
                // Tempo esgotado â€” fechar carta
                setPollStatus(p => ({...p, [i]: 'closed'}));
                setChatMsgs(p => [...p, {
                  user:'Sistema',
                  msg:`ðŸ”’ Carta ${i+1} (${cards[i]?.card?.name}) FECHADA â€” arremate confirmado!`,
                  ts:new Date(), system:true
                }]);
                delete next[i];
              } else {
                next[i] = cur - 1;
              }
            });
            return next;
          });
        }, 1000);
        return () => clearInterval(t);
      }, [pollStatus]);
  
      // â”€â”€ FREE: funÃ§Ãµes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const startCard = () => {
        const t = parseInt(timerInput) || 60;
        setTimerMax(t); setTimer(t); setPhase('bidding');
        setUploads(p => ({...p, [cardIdx]:{front:null,back:null,video:null}}));
        setShowConfirm(false);
        setChatMsgs(p => [...p, {
          user:'Sistema',
          msg:`ðŸŽ´ Carta ${cardIdx+1}/${cards.length}: ${currentCard?.card?.name} | ${currentCard?.quality} | Lance mÃ­n: R$ ${effectiveMinBid} (+R$${effectiveInc}) | â±ï¸ ${t}s`,
          ts:new Date(), system:true
        }]);
      };
  
      const placeBid = (value, user='Dr. JoÃ£o (simulado)') => {
        const entry = {user, value, ts:new Date()};
        setBids(p => ({...p, [cardIdx]:[...(p[cardIdx]||[]), entry]}));
        setChatMsgs(p => [...p, {user, msg:`ðŸ’° Lance: R$ ${value}`, ts:new Date()}]);
      };
  
      const markSold = () => {
        setPhase('sold');
        setChatMsgs(p => [...p, {user:'Sistema', msg:'ðŸ”¨ VENDIDO!', ts:new Date(), system:true}]);
      };
  
      const nextCard = () => {
        if (cardIdx + 1 >= cards.length) { setPhase('ended'); setShowReport(true); return; }
        setCardIdx(p => p + 1); setPhase('waiting'); setTimer(0);
        setChatMsgs(p => [...p, {
          user:'Sistema',
          msg:`âž¡ï¸ PrÃ³xima carta: ${cards[cardIdx+1]?.card?.name}`,
          ts:new Date(), system:true
        }]);
      };
  
      const getWinner = (idx) => {
        const b = bids[idx]; if (!b?.length) return null;
        return b.reduce((a,c) => (parseFloat(c.value) > parseFloat(a.value) ? c : a));
      };
  
      // â”€â”€ POLL: funÃ§Ãµes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const pollVote = (cardI, optIdx, user='Participante') => {
        const card   = cards[cardI];
        const opts   = card?.pollOptions || [];
        const maxOpt = opts.length - 1;
        const isMax  = optIdx === maxOpt;
  
        // Registrar voto
        setPollBids(p => {
          const c = p[cardI] || {};
          return {...p, [cardI]: {...c, [optIdx]: [...(c[optIdx]||[]), {user, ts:new Date()}]}};
        });
        setChatMsgs(p => [...p, {
          user, msg:`ðŸ—³ï¸ [Carta ${cardI+1}] ${card?.card?.name} â€” Lance: R$ ${opts[optIdx]}`,
          ts:new Date()
        }]);
  
        // Se Ã© o lance mÃ¡ximo â†’ iniciar contagem de arremate
        if (isMax && pollStatus[cardI] === 'open') {
          setPollStatus(p => ({...p, [cardI]: 'arremate_pending'}));
          setArrCountdown(p => ({...p, [cardI]: 180}));
          setPollArremate(p => ({...p, [cardI]: {optIdx, user, ts:new Date()}}));
          setChatMsgs(p => [...p, {
            user:'Sistema',
            msg:`âš ï¸ ARREMATE! [Carta ${cardI+1}] ${card?.card?.name} â€” R$ ${opts[optIdx]} por ${user}. â³ 3 minutos para retirar o lance!`,
            ts:new Date(), system:true
          }]);
        }
      };
  
      const retirarLance = (cardI) => {
        const arr = pollArremate[cardI];
        if (!arr) return;
        setPollStatus(p => ({...p, [cardI]: 'open'}));
        setArrCountdown(p => { const n={...p}; delete n[cardI]; return n; });
        setPollArremate(p => { const n={...p}; delete n[cardI]; return n; });
        setChatMsgs(p => [...p, {
          user:'Sistema',
          msg:`â†©ï¸ Lance retirado! [Carta ${cardI+1}] ${cards[cardI]?.card?.name} â€” aberta para novos lances.`,
          ts:new Date(), system:true
        }]);
      };
  
      const fecharPollManual = (cardI) => {
        setPollStatus(p => ({...p, [cardI]: 'closed'}));
        setArrCountdown(p => { const n={...p}; delete n[cardI]; return n; });
        setChatMsgs(p => [...p, {
          user:'Sistema',
          msg:`ðŸ”’ Carta ${cardI+1} (${cards[cardI]?.card?.name}) fechada pelo leiloeiro.`,
          ts:new Date(), system:true
        }]);
      };
  
      const getPollWinner = (cardI) => {
        const card = cards[cardI];
        const opts = card?.pollOptions || [];
        const bidsForCard = pollBids[cardI] || {};
        // Encontrar opÃ§Ã£o com maior Ã­ndice que tem votos
        for (let i = opts.length-1; i >= 0; i--) {
          if (bidsForCard[i]?.length) {
            const lastVote = bidsForCard[i][bidsForCard[i].length-1];
            return {optIdx:i, value:opts[i], user:lastVote.user, ts:lastVote.ts};
          }
        }
        return null;
      };
  
      // â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const sendChat = () => {
        if (!chatInput.trim()) return;
        setChatMsgs(p => [...p, {user:'Dr. JoÃ£o (leiloeiro)', msg:chatInput.trim(), ts:new Date()}]);
        setChatInput('');
      };
  
      const timerPct   = timerMax > 0 ? (timer/timerMax)*100 : 0;
      const timerColor = timerPct > 50 ? 'bg-green-500' : timerPct > 20 ? 'bg-yellow-400' : 'bg-red-500';
  
      const allPollClosed = cards.length > 0 && cards.every((_,i) => pollStatus[i]==='closed');
  
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // UI POLL
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      if (isPoll) return (
        <div className="space-y-0 pb-24">
          {/* Header */}
          <div className="bg-gradient-to-r from-indigo-700 to-purple-700 text-white px-4 py-3 flex items-center justify-between">
            <div>
              <p className="font-black text-sm">{auction.title}</p>
              <p className="text-indigo-200 text-xs mt-0.5">ðŸ—³ï¸ LeilÃ£o por Poll â€” lances abertos</p>
            </div>
            <div className="text-right text-xs text-indigo-200">
              <p>{cards.filter((_,i)=>pollStatus[i]==='closed').length}/{cards.length} fechadas</p>
            </div>
          </div>
  
          {/* Cards navegÃ¡veis */}
          <div className="bg-gray-50 px-3 py-3 space-y-3">
            {cards.map((c, cardI) => {
              const opts    = c?.pollOptions || c?.card?.pollOptions || [];
              const status  = pollStatus[cardI] || 'open';
              const winner  = getPollWinner(cardI);
              const arr     = pollArremate[cardI];
              const secs    = arrCountdown[cardI];
              const bidsC   = pollBids[cardI] || {};
              const isClosed = status === 'closed';
              const isPending = status === 'arremate_pending';
  
              return (
                <div key={cardI} className={`bg-white rounded-2xl shadow-md overflow-hidden border-2 ${
                  isClosed  ? 'border-gray-300 opacity-70' :
                  isPending ? 'border-orange-400 ring-2 ring-orange-300' :
                  'border-purple-200'
                }`}>
                  {/* Status badge */}
                  <div className={`px-4 py-1.5 flex items-center justify-between text-[11px] font-black ${
                    isClosed  ? 'bg-gray-200 text-gray-600' :
                    isPending ? 'bg-orange-100 text-orange-700' :
                    'bg-purple-50 text-purple-700'
                  }`}>
                    <span>Carta {cardI+1} de {cards.length}</span>
                    <span>{isClosed ? 'ðŸ”’ Fechada' : isPending ? `âš ï¸ ARREMATE â€” ${Math.floor((secs||0)/60)}:${String((secs||0)%60).padStart(2,'0')} para retirar` : 'ðŸŸ¢ Aberta'}</span>
                  </div>
  
                  {/* Corpo da carta */}
                  <div className="p-3 flex gap-3">
                    <div className="flex-shrink-0 relative">
                      <img src={c?.card?.images?.large || c?.card?.images?.small || c?.card?.img}
                        alt={c?.card?.name}
                        className="h-28 w-auto rounded-xl border border-gray-200 shadow-sm object-contain"
                        onError={e=>e.target.style.display='none'} />
                      <span className={`absolute -top-1 -right-1 text-white text-[9px] font-black px-1.5 py-0.5 rounded-full ${QUALITY_COLOR[c?.quality]||'bg-gray-400'}`}>
                        {c?.quality}
                      </span>
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="font-black text-gray-900 text-sm leading-tight">{c?.card?.name}</p>
                      <p className="text-[11px] text-gray-400 mt-0.5">{c?.card?.set?.name || c?.card?.set} Â· {c?.card?.number}</p>
  
                      {/* Winner se fechada */}
                      {isClosed && winner && (
                        <div className="mt-2 bg-yellow-50 border border-yellow-200 rounded-xl p-2">
                          <p className="text-xs font-black text-yellow-800">ðŸ† R$ {winner.value}</p>
                          <p className="text-[10px] text-gray-500">{winner.user}</p>
                        </div>
                      )}
                      {isClosed && !winner && (
                        <p className="mt-2 text-xs text-gray-400 italic">Sem lances</p>
                      )}
  
                      {/* Arremate pendente */}
                      {isPending && arr && (
                        <div className="mt-2 bg-orange-50 border border-orange-200 rounded-xl p-2">
                          <p className="text-xs font-black text-orange-800">âš¡ R$ {opts[arr.optIdx]} â€” {arr.user}</p>
                          <p className="text-[10px] text-gray-500">Tempo para retirar: {Math.floor((secs||0)/60)}:{String((secs||0)%60).padStart(2,'0')}</p>
                          <button onClick={()=>retirarLance(cardI)}
                            className="mt-1.5 w-full bg-orange-500 text-white text-[11px] font-black py-1 rounded-lg">
                            â†©ï¸ Retirar lance
                          </button>
                        </div>
                      )}
                    </div>
                  </div>
  
                  {/* OpÃ§Ãµes de lance */}
                  {!isClosed && (
                    <div className="px-3 pb-3 space-y-2">
                      <p className="text-[10px] text-gray-400 font-semibold uppercase tracking-wide">Selecione seu lance:</p>
                      <div className="grid grid-cols-2 gap-1.5">
                        {opts.filter(Boolean).map((opt, optIdx) => {
                          const votesForOpt = bidsC[optIdx]?.length || 0;
                          const isMaxOpt    = optIdx === opts.filter(Boolean).length - 1;
                          const hasVotes    = votesForOpt > 0;
                          return (
                            <button key={optIdx}
                              disabled={isPending}
                              onClick={()=>pollVote(cardI, optIdx, 'Participante (sim.)')}
                              className={`p-2 rounded-xl border-2 text-left transition-all disabled:opacity-40 ${
                                isMaxOpt
                                  ? 'border-red-400 bg-red-50 hover:bg-red-100'
                                  : hasVotes
                                  ? 'border-blue-300 bg-blue-50 hover:bg-blue-100'
                                  : 'border-gray-200 bg-white hover:border-blue-300 hover:bg-blue-50'
                              }`}>
                              <p className={`text-xs font-black ${isMaxOpt?'text-red-700':'text-blue-700'}`}>
                                {isMaxOpt ? 'ðŸ”¨ ' : ''}R$ {opt}
                              </p>
                              <p className="text-[10px] text-gray-400">{votesForOpt} lance(s)</p>
                            </button>
                          );
                        })}
                      </div>
                      {/* Fechar manualmente (leiloeiro) */}
                      <button onClick={()=>fecharPollManual(cardI)}
                        className="w-full text-[10px] text-gray-400 hover:text-red-600 py-1 border border-dashed border-gray-200 rounded-lg hover:border-red-300 transition-all">
                        ðŸ”’ Fechar esta carta
                      </button>
                    </div>
                  )}
                </div>
              );
            })}
          </div>
  
          {/* Encerrar leilÃ£o */}
          {allPollClosed && (
            <div className="px-3 py-3">
              <button onClick={()=>setShowReport(true)}
                className="w-full bg-gray-800 text-white py-3.5 rounded-xl font-black text-sm">
                ðŸ“‹ Ver RelatÃ³rio Final
              </button>
            </div>
          )}
  
          {/* RelatÃ³rio */}
          {showReport && (
            <div className="fixed inset-0 bg-black/80 z-[9999] flex items-end justify-center"
              onClick={e=>{ if(e.target===e.currentTarget) setShowReport(false); }}>
              <div className="bg-white w-full rounded-t-3xl max-h-[85vh] overflow-y-auto p-6"
                onClick={e=>e.stopPropagation()}>
                <h2 className="text-xl font-black text-gray-900 mb-4">ðŸ“‹ RelatÃ³rio â€” {auction.title}</h2>
                <div className="space-y-2">
                  {cards.map((c,i) => {
                    const w = getPollWinner(i);
                    return (
                      <div key={i} className="flex items-center justify-between py-2 border-b border-gray-100">
                        <div>
                          <p className="font-bold text-sm text-gray-800">{c?.card?.name}</p>
                          <p className="text-[11px] text-gray-400">{c?.card?.set?.name || c?.card?.set} Â· {c?.quality}</p>
                        </div>
                        {w
                          ? <div className="text-right"><p className="font-black text-green-600">R$ {w.value}</p><p className="text-[10px] text-gray-400">{w.user}</p></div>
                          : <span className="text-xs text-gray-400">Sem lance</span>
                        }
                      </div>
                    );
                  })}
                </div>
                <button onClick={()=>{setShowReport(false); onEnd && onEnd();}}
                  className="w-full mt-4 bg-gray-800 text-white py-3 rounded-xl font-black">
                  Encerrar Sala
                </button>
              </div>
            </div>
          )}
  
          {/* Chat */}
          <div className="fixed bottom-16 left-0 right-0 bg-white border-t shadow-lg">
            <div className="h-28 overflow-y-auto p-2 space-y-1 bg-gray-50">
              {chatMsgs.slice(-20).map((m,i) => (
                <div key={i} className={`text-xs ${m.system?'text-center text-gray-400 italic':''}`}>
                  {!m.system && <span className="font-bold text-gray-700">{m.user}: </span>}
                  <span className={m.system?'':'text-gray-600'}>{m.msg}</span>
                </div>
              ))}
            </div>
            <div className="flex gap-2 p-2 border-t">
              <input value={chatInput} onChange={e=>setChatInput(e.target.value)}
                onKeyDown={e=>e.key==='Enter'&&sendChat()}
                placeholder="Mensagem para a salaâ€¦"
                className="flex-1 px-3 py-2 border border-gray-200 rounded-xl text-xs outline-none focus:border-gray-800" />
              <button onClick={sendChat} className="bg-gray-800 text-white px-4 py-2 rounded-xl text-xs font-bold">Enviar</button>
            </div>
          </div>
        </div>
      );
  
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // UI FREE (arremates) â€” carta por carta com timer
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const needsConfig = !effectiveMinBid || !effectiveInc;
  
      return (
        <div className="space-y-0">
          {/* Status bar */}
          <div className="bg-gray-800 text-white px-4 py-2 flex items-center justify-between text-xs">
            <span className="font-bold">Carta {cardIdx+1}/{cards.length}</span>
            <span className={`px-2 py-0.5 rounded-full font-bold ${
              phase==='waiting' ? 'bg-gray-600' :
              phase==='bidding' ? 'bg-green-500' :
              phase==='sold'    ? 'bg-yellow-500' : 'bg-red-500'
            }`}>
              {phase==='waiting'?'Aguardando':phase==='bidding'?'Lance aberto':phase==='sold'?'Vendido!':'Encerrado'}
            </span>
            <span className="text-gray-400">{participants.length} na sala</span>
          </div>
  
          {/* Carta atual */}
          <div className="bg-gradient-to-br from-gray-800 to-gray-900 p-4">
            {currentCard && (
              <div className="flex gap-4 items-start">
                <div className="relative flex-shrink-0">
                  <img src={currentCard.card?.images?.large || currentCard.card?.images?.small || currentCard.card?.img}
                    alt={currentCard.card?.name}
                    className="h-32 w-auto object-contain rounded-xl shadow-2xl border-2 border-gray-600"
                    onError={e=>e.target.style.display='none'} />
                  <span className={`absolute -top-1 -right-1 text-white text-[10px] font-black px-1.5 py-0.5 rounded-full ${QUALITY_COLOR[currentCard.quality]||'bg-gray-400'}`}>
                    {currentCard.quality}
                  </span>
                </div>
                <div className="flex-1 text-white min-w-0">
                  <p className="font-black text-base leading-tight">{currentCard.card?.name}</p>
                  <p className="text-xs text-gray-400">{currentCard.card?.set?.name || currentCard.card?.set} Â· {currentCard.card?.number}</p>
                  {currentCard.ligaPrice && (
                    <p className="text-xs text-green-400 mt-1">ðŸ“Š Liga: R$ {currentCard.ligaPrice.toLocaleString('pt-BR')} ({currentCard.quality})*</p>
                  )}
                  {currentCard.comment && (
                    <p className="text-xs text-gray-300 mt-1 italic">ðŸ’¬ {currentCard.comment}</p>
                  )}
                  {/* Uploads */}
                  <div className="flex gap-1.5 mt-2 flex-wrap">
                    {[{key:'front',icon:'ðŸ“·',label:'Frente',accept:'image/*'},{key:'back',icon:'ðŸ”„',label:'Verso',accept:'image/*'},{key:'video',icon:'ðŸŽ¥',label:'VÃ­deo',accept:'video/*'}].map(u=>{
                      const uploaded = uploads[cardIdx]?.[u.key];
                      return (
                        <label key={u.key} className={`px-2 py-1 rounded-lg text-[10px] font-bold cursor-pointer flex items-center gap-1 ${uploaded?'bg-green-500 text-white':'bg-gray-600 text-gray-300 hover:bg-gray-500'}`}>
                          {u.icon} {uploaded ? `âœ“ ${uploaded.name.slice(0,8)}â€¦` : u.label}
                          <input type="file" accept={u.accept} className="hidden"
                            onChange={e=>{const f=e.target.files?.[0];if(!f)return;setUploads(p=>({...p,[cardIdx]:{...(p[cardIdx]||{}),[u.key]:f}}));}} />
                        </label>
                      );
                    })}
                  </div>
                </div>
              </div>
            )}
  
            {/* Timer bar */}
            {phase==='bidding' && (
              <div className="mt-3">
                <div className="flex justify-between text-xs text-gray-300 mb-1">
                  <span>Tempo restante</span>
                  <span className={`font-black text-sm ${timer<=10?'text-red-400':'text-white'}`}>{timer}s</span>
                </div>
                <div className="h-2 bg-gray-700 rounded-full overflow-hidden">
                  <div className={`h-full ${timerColor} transition-all duration-1000 rounded-full`} style={{width:`${timerPct}%`}}></div>
                </div>
              </div>
            )}
          </div>
  
          {/* Controles */}
          <div className="bg-white border-b border-gray-200 p-3 space-y-3">
            {phase==='waiting' && (
              <div className="space-y-3">
                {/* Config inline */}
                {needsConfig && (
                  <div className="bg-amber-50 border-2 border-amber-300 rounded-xl p-3 space-y-2">
                    <p className="text-xs font-bold text-amber-800">âš ï¸ Configure lance mÃ­nimo e incremento antes de liberar.</p>
                    <div className="grid grid-cols-2 gap-2">
                      <div>
                        <label className="text-[10px] font-bold text-gray-500 uppercase">Lance mÃ­n.</label>
                        <input type="number" value={inlineBid.minBid} onChange={e=>setInlineBid(p=>({...p,minBid:e.target.value}))}
                          placeholder="R$ 0" className="w-full border border-amber-300 rounded-lg px-2 py-1.5 text-sm font-bold outline-none focus:border-amber-500 mt-0.5" />
                      </div>
                      <div>
                        <label className="text-[10px] font-bold text-gray-500 uppercase">Incremento</label>
                        <input type="number" value={inlineBid.increment} onChange={e=>setInlineBid(p=>({...p,increment:e.target.value}))}
                          placeholder="R$ 0" className="w-full border border-amber-300 rounded-lg px-2 py-1.5 text-sm font-bold outline-none focus:border-amber-500 mt-0.5" />
                      </div>
                    </div>
                  </div>
                )}
                {/* Timer config */}
                <div className="flex items-center gap-2">
                  <span className="text-xs font-bold text-gray-600">â±ï¸ Timer:</span>
                  <input type="number" value={timerInput} onChange={e=>setTimerInput(e.target.value)}
                    className="w-20 border border-gray-300 rounded-xl px-3 py-1.5 text-sm font-bold text-center outline-none focus:border-gray-600" />
                  <span className="text-xs text-gray-400">segundos</span>
                  <div className="flex gap-1 ml-auto">
                    {[30,60,90,120].map(v=>(
                      <button key={v} onClick={()=>setTimerInput(String(v))}
                        className={`px-2 py-1 rounded-lg text-[10px] font-bold transition-all ${timerInput===String(v)?'bg-gray-800 text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                        {v}s
                      </button>
                    ))}
                  </div>
                </div>
                <button onClick={startCard} disabled={needsConfig}
                  className="w-full bg-green-500 text-white py-3 rounded-xl font-black text-sm disabled:opacity-40 hover:bg-green-600">
                  â–¶ Liberar Lance â€” {currentCard?.card?.name}
                </button>
              </div>
            )}
  
            {phase==='bidding' && (
              <div className="space-y-2">
                <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-3">
                  <p className="text-xs text-gray-600">Lance mÃ­nimo: <span className="font-black text-blue-700">R$ {effectiveMinBid}</span></p>
                  <p className="text-xs text-gray-600">Incremento: <span className="font-black text-blue-700">+R$ {effectiveInc}</span></p>
                </div>
                {/* Simular lances */}
                <div className="flex gap-2 flex-wrap">
                  {[effectiveMinBid, parseFloat(effectiveMinBid||0)+parseFloat(effectiveInc||0), parseFloat(effectiveMinBid||0)+2*parseFloat(effectiveInc||0)].filter(v=>v>0).map((v,i)=>(
                    <button key={i} onClick={()=>placeBid(v)}
                      className="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-blue-700">
                      R$ {v}
                    </button>
                  ))}
                  <button onClick={()=>setTimer(p=>p+15)} className="bg-gray-200 text-gray-700 px-3 py-2 rounded-xl text-xs font-bold hover:bg-gray-300">+15s</button>
                  <button onClick={markSold} className="bg-red-500 text-white px-3 py-2 rounded-xl text-xs font-bold hover:bg-red-600">ðŸ”¨ Encerrar</button>
                </div>
                {bids[cardIdx]?.length > 0 && (
                  <div className="bg-gray-50 rounded-xl p-2 max-h-24 overflow-y-auto">
                    {[...bids[cardIdx]].reverse().slice(0,5).map((b,i)=>(
                      <div key={i} className="flex justify-between text-xs py-0.5">
                        <span className="text-gray-600">{b.user}</span>
                        <span className="font-bold text-green-700">R$ {b.value}</span>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}
  
            {phase==='sold' && (
              <div className="space-y-2">
                {(()=>{ const w=getWinner(cardIdx); return w?(
                  <div className="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-3 text-center">
                    <p className="font-black text-yellow-800">ðŸ† R$ {w.value} â€” {w.user}</p>
                    <p className="text-[10px] text-gray-500">{new Date(w.ts).toLocaleTimeString('pt-BR')}</p>
                  </div>
                ):null; })()}
                <button onClick={nextCard} className="w-full bg-gray-800 text-white py-3 rounded-xl font-bold text-sm">
                  {cardIdx+1>=cards.length ? 'ðŸ“‹ Ver RelatÃ³rio Final' : 'âž¡ï¸ PrÃ³xima Carta'}
                </button>
              </div>
            )}
  
            {phase==='ended' && showReport && (
              <div className="space-y-2">
                <p className="font-black text-center text-gray-800">ðŸ“‹ LeilÃ£o Encerrado</p>
                {cards.map((c,i)=>{
                  const w = getWinner(i);
                  return (
                    <div key={i} className="flex items-center justify-between py-1.5 border-b border-gray-100">
                      <div>
                        <p className="font-bold text-xs text-gray-800">{c?.card?.name}</p>
                        <p className="text-[10px] text-gray-400">{c?.quality}</p>
                      </div>
                      {w
                        ? <div className="text-right"><p className="font-black text-xs text-green-600">R$ {w.value}</p><p className="text-[10px] text-gray-400">{w.user}</p></div>
                        : <span className="text-[10px] text-gray-400">Sem lance</span>
                      }
                    </div>
                  );
                })}
                <button onClick={()=>onEnd&&onEnd()} className="w-full bg-gray-800 text-white py-3 rounded-xl font-black text-sm mt-2">Encerrar Sala</button>
              </div>
            )}
          </div>
  
          {/* Chat */}
          <div className="bg-white">
            <div className="h-36 overflow-y-auto p-3 space-y-1.5 bg-gray-50">
              {chatMsgs.map((m,i)=>(
                <div key={i} className={`text-xs ${m.system?'text-center text-gray-400 italic':''}`}>
                  {!m.system && <span className="font-bold text-gray-700">{m.user}: </span>}
                  <span className={m.system?'':'text-gray-600'}>{m.msg}</span>
                  {!m.system && <span className="text-gray-300 ml-1">{new Date(m.ts).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}</span>}
                </div>
              ))}
            </div>
            <div className="flex gap-2 p-2 border-t">
              <input value={chatInput} onChange={e=>setChatInput(e.target.value)}
                onKeyDown={e=>e.key==='Enter'&&sendChat()}
                placeholder="Mensagem para a salaâ€¦"
                className="flex-1 px-3 py-2 border border-gray-200 rounded-xl text-xs outline-none focus:border-gray-800" />
              <button onClick={sendChat} className="bg-gray-800 text-white px-4 py-2 rounded-xl text-xs font-bold">Enviar</button>
            </div>
          </div>
        </div>
      );
    };
  
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TELA ADMIN - Aprovar Leiloeiros
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const AdminScreen = () => {
    const [pendingAuctioneers, setPendingAuctioneers] = React.useState([]);
    const [loading, setLoading] = React.useState(true);

    const loadPending = async () => {
      setLoading(true);
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('tipo', 'leiloeiro')
          .eq('approved', false)
          .order('created_at', { ascending: false });
        
        if (!error && data) {
          setPendingAuctioneers(data);
        }
      } catch (err) {
        console.error('Erro ao carregar leiloeiros pendentes:', err);
      }
      setLoading(false);
    };

    React.useEffect(() => {
      loadPending();
    }, []);

    const handleApprove = async (userId) => {
      const { error } = await supabase
        .from('profiles')
        .update({ approved: true })
        .eq('id', userId);
      
      if (!error) {
        alert('âœ… Leiloeiro aprovado!');
        loadPending();
      } else {
        alert('âŒ Erro ao aprovar');
      }
    };

    const handleReject = async (userId) => {
      if (!confirm('Tem certeza que deseja rejeitar este leiloeiro?')) return;
      
      const { error } = await supabase
        .from('profiles')
        .delete()
        .eq('id', userId);
      
      if (!error) {
        alert('âŒ Leiloeiro rejeitado');
        loadPending();
      }
    };

    return (
      <div className="min-h-screen bg-gray-50 pokeball-bg pb-24">
        <div className="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 pb-8 relative overflow-hidden">
          <button onClick={() => setScreen('profile')} className="absolute top-6 left-4 text-white text-2xl">â†</button>
          <h1 className="text-2xl font-black text-center" style={{fontFamily:'Arial Black,sans-serif'}}>ðŸ” Painel Admin</h1>
          <p className="text-purple-100 text-sm text-center mt-1">Aprovar Leiloeiros</p>
        </div>

        <div className="px-4 py-6 space-y-4">
          {loading ? (
            <div className="text-center py-12">
              <p className="text-gray-500">â³ Carregando...</p>
            </div>
          ) : pendingAuctioneers.length === 0 ? (
            <div className="bg-white rounded-2xl shadow-lg p-8 text-center">
              <p className="text-5xl mb-3">âœ…</p>
              <p className="font-bold text-gray-800 mb-2">Nenhum leiloeiro pendente</p>
              <p className="text-sm text-gray-500">Todos os leiloeiros foram aprovados!</p>
            </div>
          ) : (
            pendingAuctioneers.map(auctioneer => (
              <div key={auctioneer.id} className="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-orange-400">
                <div className="flex items-start gap-4 mb-4">
                  <div className="w-12 h-12 bg-gradient-to-br from-orange-500 to-red-500 rounded-full flex items-center justify-center text-white text-xl font-black">
                    {auctioneer.nome?.charAt(0).toUpperCase() || '?'}
                  </div>
                  <div className="flex-1">
                    <p className="font-black text-gray-800 text-lg">{auctioneer.nome}</p>
                    <p className="text-sm text-gray-500">{auctioneer.email}</p>
                    {auctioneer.whatsapp && (
                      <p className="text-sm text-gray-600 mt-1">ðŸ“± {auctioneer.whatsapp}</p>
                    )}
                    <span className="inline-block mt-2 text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full font-bold">
                      â³ Aguardando AprovaÃ§Ã£o
                    </span>
                  </div>
                </div>

                <div className="flex gap-2">
                  <button 
                    onClick={() => handleApprove(auctioneer.id)}
                    className="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white py-3 rounded-xl font-bold shadow-lg hover:from-green-600 hover:to-green-700">
                    âœ… Aprovar
                  </button>
                  <button 
                    onClick={() => handleReject(auctioneer.id)}
                    className="flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white py-3 rounded-xl font-bold shadow-lg hover:from-red-600 hover:to-red-700">
                    âŒ Rejeitar
                  </button>
                </div>
              </div>
            ))
          )}
        </div>

        <BottomNav current="profile" />
      </div>
    );
  };

  const ProfileScreen = () => {
    const handleLogout = async () => {
      const { error } = await sbAuth.signOut();
      if (!error) {
        setUser(null);
        setUserProfile(null);
        setScreen('login');
      }
    };

    const userEmail = user?.email || userProfile?.email || 'email@example.com';
    const userName = userProfile?.nome || user?.user_metadata?.display_name || 'UsuÃ¡rio';
    const userInitial = userName.charAt(0).toUpperCase();
    const userWhatsapp = userProfile?.whatsapp;
    const userType = userProfile?.tipo;
    const needsApproval = userType === 'leiloeiro' && userProfile?.approved === false;

    return (
    <div className="min-h-screen bg-gray-50 pokeball-bg pb-24">
      <div className="bg-gradient-to-r from-indigo-500 to-pink-500 text-white p-6 pb-14 relative overflow-hidden">
        <img src={POKE.dragonite} className="absolute -right-8 top-0 w-40 opacity-20" />
        <h1 className="text-2xl font-black relative z-10" style={{fontFamily:'Arial Black,sans-serif'}}>Meu Perfil</h1>
      </div>
      <div className="px-4 -mt-10 space-y-4">
        <div className="bg-white rounded-2xl shadow-lg p-6 border-t-4 border-yellow-400">
          <div className="flex items-center gap-4 mb-4">
            <div className="w-16 h-16 bg-gradient-to-br from-red-500 to-yellow-400 rounded-full flex items-center justify-center text-white text-3xl font-black shadow-lg border-4 border-white">{userInitial}</div>
            <div>
              <p className="text-xl font-black text-gray-800">{userName}</p>
              <p className="text-gray-500 text-sm">{userEmail}</p>
              {userWhatsapp && (
                <p className="text-gray-500 text-xs mt-1">ðŸ“± {userWhatsapp}</p>
              )}
              <div className="flex items-center gap-2 mt-1 flex-wrap">
                <span className="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full font-bold">âš¡ Membro Ativo</span>
                {isAuctioneer && !needsApproval && <span className="text-xs bg-gray-800 text-white px-2 py-1 rounded-full font-bold">ðŸ”¨ Leiloeiro</span>}
                {needsApproval && <span className="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full font-bold">â³ Aguardando AprovaÃ§Ã£o</span>}
              </div>
            </div>
          </div>

          {needsApproval && (
            <div className="mb-4 p-4 bg-orange-50 border-2 border-orange-200 rounded-xl">
              <p className="text-sm text-orange-800 font-bold mb-1">ðŸ”¨ Conta de Leiloeiro em AnÃ¡lise</p>
              <p className="text-xs text-orange-600">Sua conta estÃ¡ sendo analisada pela equipe PokÃ©Eventos. VocÃª serÃ¡ notificado quando for aprovada!</p>
            </div>
          )}

          <div className="grid grid-cols-3 gap-3 mb-5">
            <div className="bg-blue-50 rounded-xl p-3 text-center border-2 border-blue-100"><p className="text-2xl font-black text-blue-600">{checkins.length}</p><p className="text-xs text-gray-500 font-semibold">Check-ins</p></div>
            <div className="bg-yellow-50 rounded-xl p-3 text-center border-2 border-yellow-100"><p className="text-2xl font-black text-yellow-600">{wantedList.length}</p><p className="text-xs text-gray-500 font-semibold">Wanted</p></div>
            <div className="bg-purple-50 rounded-xl p-3 text-center border-2 border-purple-100"><p className="text-2xl font-black text-purple-600">{EVENTS.length}</p><p className="text-xs text-gray-500 font-semibold">LeilÃµes</p></div>
          </div>

          {/* HistÃ³rico de buscas */}
          {searchLog.length>0 && (
            <div className="mb-5 bg-white rounded-2xl border-2 border-gray-100 overflow-hidden">
              <div className="bg-gradient-to-r from-blue-50 to-indigo-50 px-4 py-3 border-b flex items-center justify-between">
                <div className="flex items-center gap-2"><span className="text-lg">ðŸ”</span><p className="font-bold text-gray-700 text-sm">Minhas buscas recentes</p></div>
                <span className="text-xs text-gray-400 bg-white px-2 py-1 rounded-full border">{Math.min(searchLog.length,15)}</span>
              </div>
              <div className="divide-y divide-gray-50">
                {[...searchLog].sort((a,b)=>new Date(b.last)-new Date(a.last)).slice(0,15).map((item,i)=>(
                  <button key={i} onClick={()=>setScreen('search')} className="w-full flex items-center justify-between px-4 py-3 hover:bg-blue-50 text-left group">
                    <div className="flex items-center gap-3">
                      <div className="w-7 h-7 bg-gray-100 group-hover:bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0"><span className="text-sm">ðŸŽ´</span></div>
                      <div>
                        <p className="text-sm font-semibold text-gray-700 group-hover:text-blue-700">{item.query}</p>
                        <p className="text-[10px] text-gray-400">{new Date(item.last).toLocaleDateString('pt-BR',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'})}{item.count>1&&<span className="ml-2 bg-gray-100 text-gray-500 px-1.5 rounded-full">{item.count}x</span>}</p>
                      </div>
                    </div>
                    <span className="text-gray-300 group-hover:text-blue-400">â†’</span>
                  </button>
                ))}
              </div>
            </div>
          )}

          <div className="space-y-2">
            <button onClick={()=>setScreen('home')}     className="w-full text-left px-4 py-3 bg-gray-50 rounded-xl font-semibold border text-sm hover:bg-gray-100">ðŸ  Meus LeilÃµes</button>
            <button onClick={()=>setScreen('calendar')} className="w-full text-left px-4 py-3 bg-gray-50 rounded-xl font-semibold border text-sm hover:bg-gray-100">ðŸ“… CalendÃ¡rio</button>
            <button onClick={()=>setScreen('wanted')}   className="w-full text-left px-4 py-3 bg-yellow-50 text-yellow-700 rounded-xl font-semibold border border-yellow-200 text-sm hover:bg-yellow-100">â­ Wanted List {wantedList.length>0&&`(${wantedList.length})`}</button>

            {/* Ãrea Admin */}
            {userProfile?.is_admin && (
              <div className="border-t-2 border-dashed border-gray-200 pt-2 mt-2 space-y-2">
                <p className="text-[10px] font-bold text-gray-400 uppercase tracking-wide px-1">AdministraÃ§Ã£o</p>
                <button onClick={()=>setScreen('admin')} className="w-full text-left px-4 py-3 bg-purple-600 text-white rounded-xl font-bold text-sm hover:bg-purple-700 flex items-center gap-2">
                  ðŸ” Painel Admin
                </button>
                {/* Admin pode criar leilÃµes tambÃ©m */}
                <button onClick={()=>setScreen('auctioneer')} className="w-full text-left px-4 py-3 bg-gray-800 text-white rounded-xl font-bold text-sm hover:bg-gray-900 flex items-center gap-2">
                  ðŸ”¨ Criar Novo LeilÃ£o
                </button>
              </div>
            )}

            {/* Ãrea exclusiva leiloeiro APROVADO (que nÃ£o seja admin) */}
            {isAuctioneer && isApproved && !userProfile?.is_admin && (
              <div className="border-t-2 border-dashed border-gray-200 pt-2 mt-2 space-y-2">
                <p className="text-[10px] font-bold text-gray-400 uppercase tracking-wide px-1">Ãrea do Leiloeiro</p>
                <button onClick={()=>setScreen('auctioneer')} className="w-full text-left px-4 py-3 bg-gray-800 text-white rounded-xl font-bold text-sm hover:bg-gray-900 flex items-center gap-2">
                  ðŸ”¨ Criar Novo LeilÃ£o
                </button>
              </div>
            )}

            <button onClick={handleLogout} className="w-full text-left px-4 py-3 bg-red-50 text-red-600 rounded-xl font-bold border-2 border-red-100 text-sm hover:bg-red-100">ðŸšª Sair</button>
          </div>
        </div>
      </div>
      <BottomNav current="profile" />
    </div>
    );
  };

  /* â”€â”€â”€ ROTEAMENTO â”€â”€â”€ */
  if (loading) {
    return (
      <div className="w-full h-screen flex items-center justify-center bg-gradient-to-br from-red-500 via-yellow-400 to-blue-500">
        <div className="text-center">
          <img src={POKE.pikachu} className="w-24 h-24 mx-auto mb-4 animate-bounce" />
          <p className="text-white text-xl font-black">Carregando PokÃ©Eventos...</p>
        </div>
      </div>
    );
  }

  // Se nÃ£o estÃ¡ logado, mostrar apenas login/register
  if (!user && screen !== 'register') {
    return <LoginScreen />;
  }

  return (
    <div className="w-full min-h-screen">
      {showTutorial && <TutorialModal />}
      {screen==='login'      && <LoginScreen />}
      {screen==='register'   && <RegisterScreen />}
      {screen==='home'       && <HomeScreen />}
      {screen==='calendar'   && <CalendarScreen />}
      {screen==='search'     && <SearchWantedScreen />}
      {screen==='wanted'     && <SearchWantedScreen />}
      {screen==='auctioneer' && <AuctioneerScreen />}
      {screen==='admin'      && <AdminScreen />}
      {screen==='profile'    && <ProfileScreen />}
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>